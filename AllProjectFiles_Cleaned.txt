--- File: README.md (Path: .\README.md) ---

# AutomationOfPurchases

--- File: AppDbContext.cs (Path: .\AutomationOfPurchases.API\AppDbContext.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API
{
    /// <summary>
    /// Контекст БД, що успадковується від IdentityDbContext для підтримки Identity-користувачів.
    /// </summary>
    public class AppDbContext : IdentityDbContext<AppUser>
    {
        public AppDbContext(DbContextOptions<AppDbContext> options)
            : base(options)
        {
        }

        // Основні сутності:
        public DbSet<Department> Departments { get; set; } = null!;
        public DbSet<Request> Requests { get; set; } = null!;
        public DbSet<RequestItem> RequestItems { get; set; } = null!;
        public DbSet<Item> Items { get; set; } = null!;
        public DbSet<DeliveryRequest> DeliveryRequests { get; set; } = null!;
        public DbSet<Notification> Notifications { get; set; } = null!;
        public DbSet<DepartmentEconomist> DepartmentEconomists { get; set; } = null!;

        // Списки для загальних/чистих потреб
        public DbSet<GeneralNeedsList> GeneralNeedsLists { get; set; } = null!;
        public DbSet<NetNeedsList> NetNeedsLists { get; set; } = null!;

        // **НОВІ** сутності для рядків загальних/чистих потреб:
        public DbSet<GeneralNeedsItem> GeneralNeedsItems { get; set; } = null!;
        public DbSet<NetNeedsItem> NetNeedsItems { get; set; } = null!;

        protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            // ===========================
            // 1) DepartmentEconomist composite key
            // ===========================
            builder.Entity<DepartmentEconomist>()
                .HasKey(de => new { de.DepartmentId, de.EconomistId });

            builder.Entity<DepartmentEconomist>()
                .HasOne(de => de.Department)
                .WithMany(d => d.DepartmentEconomists)
                .HasForeignKey(de => de.DepartmentId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.Entity<DepartmentEconomist>()
                .HasOne(de => de.Economist)
                .WithMany(u => u.DepartmentEconomists)
                .HasForeignKey(de => de.EconomistId)
                .OnDelete(DeleteBehavior.Cascade);

            // ===========================
            // 2) Department -> HeadOfDepartment
            // ===========================
            builder.Entity<Department>()
                .HasOne(d => d.HeadOfDepartment)
                .WithMany()
                .HasForeignKey(d => d.HeadOfDepartmentId)
                .OnDelete(DeleteBehavior.Restrict);

            // (Приклад, якщо у Department є колекція Economists)
            builder.Entity<Department>()
                .HasMany(d => d.Economists)
                .WithOne(u => u.Department)
                .HasForeignKey(u => u.DepartmentId)
                .OnDelete(DeleteBehavior.SetNull);

            // ===========================
            // 3) За бажання: налаштування зв’язків для GeneralNeedsList -> GeneralNeedsItem
            // ===========================
            // Якщо ви хочете явний Fluent API:
            // builder.Entity<GeneralNeedsItem>()
            //     .HasOne(gni => gni.List)
            //     .WithMany(gnl => gnl.Items)
            //     .HasForeignKey(gni => gni.GeneralNeedsListId)
            //     .OnDelete(DeleteBehavior.Cascade);

            // ===========================
            // 4) Так само для NetNeedsList -> NetNeedsItem (необов’язково):
            // ===========================
            // builder.Entity<NetNeedsItem>()
            //     .HasOne(nni => nni.List)
            //     .WithMany(nl => nl.Items)
            //     .HasForeignKey(nni => nni.NetNeedsListId)
            //     .OnDelete(DeleteBehavior.Cascade);

            // (Якщо не вказувати, EF спробує налаштувати все за конвенцією)
        }
    }
}


--- File: appsettings.Development.json (Path: .\AutomationOfPurchases.API\appsettings.Development.json) ---

{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}


--- File: appsettings.json (Path: .\AutomationOfPurchases.API\appsettings.json) ---

{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=PurchasesDb;Username=postgres;Password=admin"
  },
  "JwtSettings": {
    "SecretKey": "0123456789_ABCDEF_0123456789_ABC"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}


--- File: Program.cs (Path: .\AutomationOfPurchases.API\Program.cs) ---

using AutomationOfPurchases.API.Infrastructure.Seed;     // де лежить DatabaseSeeder
using AutomationOfPurchases.Shared.Models;               // де лежить AppDbContext, AppUser
using Microsoft.AspNetCore.Identity;                     // Identity
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using AutomationOfPurchases.API;
using AutomationOfPurchases.API.Services.Mappings;
using AutomationOfPurchases.API.Services;               // IRequestService, RequestService
using AutomationOfPurchases.API.Repositories;           // IUnitOfWork, UnitOfWork, IRepositoryFactory, RepositoryFactory
using System.Text.Json.Serialization;

var builder = WebApplication.CreateBuilder(args);

// ----------------------------- CORS -----------------------------------
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowClient", policy =>
    {
        // Вкажіть адреси вашого Blazor/клієнтського застосунку
        policy.WithOrigins("https://localhost:7018", "http://localhost:7018")
              .AllowAnyHeader()
              .AllowAnyMethod();
        // Якщо потрібно передавати Cookie чи Авторизацію з різних доменів:
        // policy.AllowCredentials();
    });
});

// ------------------------ 1) Зчитуємо рядок підключення ----------------
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? throw new InvalidOperationException("Connection string not found.");

// ------------------------ 2) Налаштування DbContext --------------------
builder.Services.AddDbContext<AppDbContext>(options =>
{
    options.UseNpgsql(connectionString);
});

// ------------------ 3) Підключаємо ASP.NET Identity --------------------
builder.Services.AddIdentity<AppUser, IdentityRole>(options =>
{
    // Тут можна налаштувати правила щодо паролів, блокування і т.д.
    // Наприклад:
    // options.Password.RequireDigit = false;
    // options.Password.RequiredLength = 4;
    // ...
})
.AddEntityFrameworkStores<AppDbContext>()
.AddDefaultTokenProviders();

// --------------------- 4) Налаштування JWT ----------------------------
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(cfg =>
{
    var secretKey = builder.Configuration["JwtSettings:SecretKey"];
    var key = Encoding.UTF8.GetBytes(secretKey!);

    cfg.SaveToken = true;
    cfg.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),

        ValidateIssuer = false,   // або встановіть issuer, якщо треба
        ValidateAudience = false, // або встановіть audience, якщо треба
        ClockSkew = TimeSpan.Zero,

        RoleClaimType = "http://schemas.microsoft.com/ws/2008/06/identity/claims/role"
    };
});

// --------------------- 5) Підключаємо AutoMapper ----------------------
builder.Services.AddAutoMapper(cfg =>
{
    cfg.AddProfile<UserProfile>();
    cfg.AddProfile<RequestProfile>();
    // інші профілі, якщо є
});

// --------------------- 6) Реєструємо свої сервіси ---------------------
// Тут ми реєструємо RepositoryFactory, UnitOfWork і RequestService
builder.Services.AddScoped<IRepositoryFactory, RepositoryFactory>();
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();
builder.Services.AddScoped<IRequestService, RequestService>();
builder.Services.AddScoped<IDepartmentHeadService, DepartmentHeadService>();
builder.Services.AddScoped<IEconomistService, EconomistService>();

// --------------------- 7) Авторизація (політики) ----------------------
builder.Services.AddAuthorization();

// --------------------- 8) Swagger, контролери тощо --------------------
builder.Services.AddControllers().AddJsonOptions(options =>
{
    // Використовуємо IgnoreCycles для уникнення нескінченних циклів при серіалізації
    options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
});
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// Створюємо й будуємо додаток
var app = builder.Build();

// --------------------- 9) Сідування (міграції + тестові користувачі) --
using (var scope = app.Services.CreateScope())
{
    var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    var roleManager = scope.ServiceProvider.GetRequiredService<RoleManager<IdentityRole>>();
    var userManager = scope.ServiceProvider.GetRequiredService<UserManager<AppUser>>();

    // Викликаємо метод сидування
    await DatabaseSeeder.SeedTestDataAsync(dbContext, roleManager, userManager);
}

// -------------------- 10) Налаштування pipeline -----------------------
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseCors("AllowClient");

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();


--- File: AuthController.cs (Path: .\AutomationOfPurchases.API\Controllers\AuthController.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.Security.Claims;
using System.Text;
using System.IdentityModel.Tokens.Jwt;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly UserManager<AppUser> _userManager;
        private readonly IConfiguration _configuration;

        public AuthController(
            UserManager<AppUser> userManager,
            IConfiguration configuration)
        {
            _userManager = userManager;
            _configuration = configuration;
        }

        // POST: api/auth/login
        [HttpPost("login")]
        public async Task<IActionResult> Login(LoginModel model)
        {
            // 1. Знаходимо користувача за UserName
            var user = await _userManager.FindByNameAsync(model.UserName);
            if (user == null)
                return Unauthorized("Invalid credentials.");

            // 2. Перевіряємо пароль
            var validPass = await _userManager.CheckPasswordAsync(user, model.Password);
            if (!validPass)
                return Unauthorized("Invalid credentials.");

            // 3. Збираємо ролі
            var roles = await _userManager.GetRolesAsync(user);

            // 4. Генеруємо JWT
            var token = GenerateJwtToken(user, roles);
            return Ok(new { token });
        }

        private string GenerateJwtToken(AppUser user, IList<string> roles)
        {
            var secretKey = _configuration["JwtSettings:SecretKey"];
            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey!));
            var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

            var claims = new List<Claim>
            {
                new Claim(JwtRegisteredClaimNames.Sub, user.Id),
                new Claim(JwtRegisteredClaimNames.Email, user.Email ?? ""),
                new Claim("fullName", user.FullName)
            };

            // Додаємо claims із ролями
            foreach (var role in roles)
            {
                claims.Add(new Claim(ClaimTypes.Role, role));
            }

            var token = new JwtSecurityToken(
                claims: claims,
                expires: DateTime.UtcNow.AddHours(8),
                signingCredentials: creds
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }

    public class LoginModel
    {
        public string UserName { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}


--- File: DeliveryRequestsController.cs (Path: .\AutomationOfPurchases.API\Controllers\DeliveryRequestsController.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;  // <-- Використовуємо DTO з Shared
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "WarehouseWorker")]
    public class DeliveryRequestsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public DeliveryRequestsController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/deliveryrequests
        [HttpGet]
        public async Task<ActionResult<List<DeliveryRequestDTO>>> GetAll()
        {
            // Завантажуємо DeliveryRequests разом із потрібними навігаційними властивостями
            var deliveries = await _context.DeliveryRequests
                .Include(d => d.Item)
                .Include(d => d.RequestItem).ThenInclude(ri => ri.OrderedBy).ThenInclude(u => u.Department)
                .ToListAsync();

            // Мапимо кожен DeliveryRequest -> DeliveryRequestDTO
            var result = deliveries.Select(d => new DeliveryRequestDTO
            {
                DeliveryRequestId = d.DeliveryRequestId,
                ItemId = d.ItemId,
                Quantity = d.Quantity,
                Warehouse = d.Warehouse,
                OrderedById = d.OrderedById,
                RequestItemId = d.RequestItemId,

                // Додаткові поля для відображення на клієнті:
                ItemName = d.Item?.ItemName ?? "",
                OrderedByFullName = d.RequestItem?.OrderedBy?.FullName ?? "",
                OrderedByDepartmentName = d.RequestItem?.OrderedBy?.Department?.DepartmentName ?? "",
                OrderedByEmail = d.RequestItem?.OrderedBy?.Email ?? ""
            }).ToList();

            return Ok(result);
        }
    }
}


--- File: GeneralNeedsController.cs (Path: .\AutomationOfPurchases.API\Controllers\GeneralNeedsController.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Economist")]
    public class GeneralNeedsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public GeneralNeedsController(AppDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Повертає «розширену» структуру списків загальних потреб.
        /// Кожен GeneralNeedsList -> GeneralNeedsListExpandedDTO,
        /// а в ньому AggregatedItems, згруповані за ItemId.
        /// </summary>
        [HttpGet("expanded")]
        public async Task<ActionResult<List<GeneralNeedsListExpandedDTO>>> GetAllListsExpanded()
        {
            // 1) Завантажуємо всі (або тільки активні) GeneralNeedsList
            var lists = await _context.GeneralNeedsLists
                .Include(l => l.Items).ThenInclude(gni => gni.Item)
                .Include(l => l.Items).ThenInclude(gni => gni.OrderedBy).ThenInclude(u => u.Department)
                .ToListAsync();

            // 2) Формуємо колекцію DTO
            var result = new List<GeneralNeedsListExpandedDTO>();

            foreach (var l in lists)
            {
                // Групуємо Items за ItemId
                var aggregatedItems = l.Items
                    .GroupBy(x => x.ItemId)
                    .Select(g =>
                    {
                        // «Перший» елемент групи (щоб взяти ItemName тощо)
                        var first = g.First();

                        // Підсумовуємо загальну кількість
                        int sumQty = g.Sum(x => x.Quantity);

                        // Деталі: хто замовник, його відділ, скільки
                        var details = g.Select(x => new GeneralDetailDTO
                        {
                            RequestItemId = x.OriginalRequestItemId ?? 0, // або x.GeneralNeedsItemId
                            OrderedByFullName = x.OrderedBy?.FullName ?? "",
                            DepartmentName = x.OrderedBy?.Department?.DepartmentName ?? "",
                            Quantity = x.Quantity
                        }).ToList();

                        return new GeneralAggregatedItemDTO
                        {
                            ItemId = first.ItemId,
                            ItemName = first.Item?.ItemName ?? "",
                            StorageUnit = first.Item?.StorageUnit ?? "",
                            TotalQuantity = sumQty,
                            IsExpanded = false, // для Blazor
                            Details = details
                        };
                    })
                    .Where(ag => ag.TotalQuantity > 0)
                    .ToList();

                // Створюємо «розширений» DTO
                var dto = new GeneralNeedsListExpandedDTO
                {
                    ListId = l.ListId,
                    CreationDate = l.CreationDate,
                    NullificationDate = l.NullificationDate,
                    AggregatedItems = aggregatedItems
                };

                result.Add(dto);
            }

            return Ok(result);
        }
    }
}


--- File: ItemController.cs (Path: .\AutomationOfPurchases.API\Controllers\ItemController.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ItemController : ControllerBase
    {
        private readonly AppDbContext _context;

        public ItemController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/item
        [HttpGet]
        public async Task<ActionResult<List<ItemDTO>>> GetItems()
        {
            // Вибираємо з таблиці Items
            var items = await _context.Items.ToListAsync();

            // Мапимо Item -> ItemDTO (поки що вручну)
            var result = items.Select(i => new ItemDTO
            {
                ItemId = i.ItemId,
                ItemName = i.ItemName,
                StorageUnit = i.StorageUnit
            }).ToList();

            return Ok(result);
        }
    }
}


--- File: NetNeedsController.cs (Path: .\AutomationOfPurchases.API\Controllers\NetNeedsController.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "Economist")]
    public class NetNeedsController : ControllerBase
    {
        private readonly AppDbContext _context;

        public NetNeedsController(AppDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Повертає «розширену» структуру списків чистих потреб.
        /// Кожен NetNeedsList -> NetNeedsListExpandedDTO
        /// з агрегованими ItemId.
        /// </summary>
        [HttpGet("expanded")]
        public async Task<ActionResult<List<NetNeedsListExpandedDTO>>> GetAllNetNeedsExpanded()
        {
            // 1) Завантажуємо списки NetNeedsList
            var lists = await _context.NetNeedsLists
                .Include(l => l.Items).ThenInclude(nni => nni.Item)
                .Include(l => l.Items).ThenInclude(nni => nni.OrderedBy).ThenInclude(u => u.Department)
                .ToListAsync();

            var result = new List<NetNeedsListExpandedDTO>();

            foreach (var l in lists)
            {
                // 2) Групуємо Items (NetNeedsItem) за ItemId
                var aggregatedItems = l.Items
                    .GroupBy(x => x.ItemId)
                    .Select(g =>
                    {
                        var first = g.First();
                        int sumQty = g.Sum(x => x.Quantity);

                        // Детальна інформація
                        var details = g.Select(x => new NetDetailDTO
                        {
                            RequestItemId = x.OriginalRequestItemId ?? 0, // або x.NetNeedsItemId
                            OrderedByFullName = x.OrderedBy?.FullName ?? "",
                            DepartmentName = x.OrderedBy?.Department?.DepartmentName ?? "",
                            Quantity = x.Quantity
                        }).ToList();

                        return new NetAggregatedItemDTO
                        {
                            ItemId = first.ItemId,
                            ItemName = first.Item?.ItemName ?? "",
                            StorageUnit = first.Item?.StorageUnit ?? "",
                            TotalQuantity = sumQty,
                            IsExpanded = false, // для Blazor
                            Details = details
                        };
                    })
                    .Where(ag => ag.TotalQuantity > 0)
                    .ToList();

                // 3) Формуємо «розширений» список
                var dto = new NetNeedsListExpandedDTO
                {
                    ListId = l.ListId,
                    CreationDate = l.CreationDate,
                    NullificationDate = l.NullificationDate,
                    AggregatedItems = aggregatedItems
                };

                result.Add(dto);
            }

            return Ok(result);
        }
    }
}


--- File: NotificationController.cs (Path: .\AutomationOfPurchases.API\Controllers\NotificationController.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class NotificationController : ControllerBase
    {
        private readonly AppDbContext _context;

        public NotificationController(AppDbContext context)
        {
            _context = context;
        }

        // GET: api/notification/my
        [HttpGet("my")]
        public async Task<ActionResult<List<NotificationDTO>>> GetMyNotifications()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found.");

            var notifications = await _context.Notifications
                .Where(n => n.RecipientId == userId)
                .OrderByDescending(n => n.CreatedAt)
                .ToListAsync();

            var result = notifications.Select(n => new NotificationDTO
            {
                NotificationId = n.NotificationId,
                Title = n.Title,
                Message = n.Message,
                IsRead = n.IsRead,
                CreatedAt = n.CreatedAt,
                LinkUrl = n.LinkUrl,

                // **НОВЕ**: передаємо RequestId
                RequestId = n.RequestId
            }).ToList();

            return Ok(result);
        }

        // PUT: api/notification/{id}/mark-read
        [HttpPut("{id}/mark-read")]
        public async Task<IActionResult> MarkAsRead(int id)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found.");

            var notif = await _context.Notifications
                .FirstOrDefaultAsync(n => n.NotificationId == id && n.RecipientId == userId);

            if (notif == null)
                return NotFound("Notification not found or not yours.");

            notif.IsRead = true;
            await _context.SaveChangesAsync();

            return NoContent();
        }
    }
}


--- File: RequestController.cs (Path: .\AutomationOfPurchases.API\Controllers\RequestController.cs) ---

﻿using AutomationOfPurchases.API.Services;
using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class RequestController : ControllerBase
    {
        private readonly IRequestService _requestService;
        private readonly IDepartmentHeadService _deptHeadService;
        private readonly IEconomistService _economistService;
        private readonly AppDbContext _context;

        public RequestController(
            IRequestService requestService,
            IDepartmentHeadService deptHeadService,
            IEconomistService economistService,
            AppDbContext context)
        {
            _requestService = requestService;
            _deptHeadService = deptHeadService;
            _economistService = economistService;
            _context = context;
        }

        [HttpPost]
        public async Task<IActionResult> CreateRequest([FromBody] RequestDTO requestDto)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var createdRequest = await _requestService.CreateRequestAsync(requestDto, userId);
            return Ok(createdRequest);
        }

        [HttpPut("{requestId}")]
        public async Task<IActionResult> UpdateRequest(int requestId, [FromBody] RequestDTO requestDto)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var updated = await _requestService.UpdateRequestAsync(requestId, requestDto, userId);
            if (updated == null)
                return NotFound("Заявка не знайдена або не належить поточному користувачу.");

            return Ok(updated);
        }

        [HttpGet("my")]
        public async Task<IActionResult> GetMyRequests()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var requests = await _requestService.GetRequestsByUserAsync(userId);
            return Ok(requests);
        }

        [HttpGet("my/{requestId}")]
        public async Task<IActionResult> GetMyRequestById(int requestId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var oneRequest = await _requestService.GetRequestByIdForUserAsync(requestId, userId);
            if (oneRequest == null)
                return NotFound("Заявка не знайдена або не належить поточному користувачу.");

            return Ok(oneRequest);
        }

        [HttpGet("department")]
        [Authorize(Roles = "DepartmentHead")]
        public async Task<IActionResult> GetDepartmentRequests()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var requests = await _deptHeadService.GetRequestsInMyDepartmentAsync(userId);
            return Ok(requests);
        }

        [HttpPut("{requestId}/approve")]
        [Authorize(Roles = "DepartmentHead")]
        public async Task<IActionResult> ApproveRequest(int requestId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var success = await _deptHeadService.ApproveRequestAsync(requestId, userId);
            if (!success)
                return NotFound("Request not found or access denied.");

            return Ok("Request approved successfully.");
        }

        [HttpPut("{requestId}/reject")]
        [Authorize(Roles = "DepartmentHead")]
        public async Task<IActionResult> RejectRequest(int requestId, [FromBody] RejectModel model)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var success = await _deptHeadService.RejectRequestAsync(requestId, userId, model.Reason);
            if (!success)
                return NotFound("Request not found or access denied.");

            return Ok("Request rejected successfully.");
        }

        [HttpGet("{id}")]
        [Authorize(Roles = "DepartmentHead,Economist")]
        public async Task<IActionResult> GetRequestById(int id)
        {
            var dto = await _requestService.GetRequestByIdAsync(id, "");
            if (dto == null)
                return NotFound("Request not found.");
            return Ok(dto);
        }

        [HttpDelete("draft/{requestId}")]
        public async Task<IActionResult> DeleteDraft(int requestId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var success = await _requestService.DeleteDraftAsync(requestId, userId);
            if (!success)
                return NotFound("Draft не знайдена або вона не належить поточному користувачу.");

            return Ok("Draft видалено успішно.");
        }

        [HttpGet("economist")]
        [Authorize(Roles = "Economist")]
        public async Task<IActionResult> GetEconomistRequests()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var requests = await _economistService.GetRequestsInMyDepartmentAsync(userId);
            return Ok(requests);
        }

        [HttpPut("{requestId}/approve-economist")]
        [Authorize(Roles = "Economist")]
        public async Task<IActionResult> ApproveEconomistRequest(int requestId)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var success = await _economistService.ApproveRequestAsync(requestId, userId);
            if (!success)
                return NotFound("Request not found or access denied.");

            return Ok("Request approved by economist successfully.");
        }

        [HttpPut("{requestId}/reject-economist")]
        [Authorize(Roles = "Economist")]
        public async Task<IActionResult> RejectEconomistRequest(int requestId, [FromBody] RejectModel model)
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            var success = await _economistService.RejectRequestAsync(requestId, userId, model.Reason);
            if (!success)
                return NotFound("Request not found or access denied.");

            return Ok("Request rejected by economist successfully.");
        }

        // Новий ендпоінт для отримання заявок для фільтрації повідомлень.
        // Він повертає список RequestShortDTO для всіх заявок, по яким надходили повідомлення для поточного користувача.
        [HttpGet("notification-requests")]
        public async Task<IActionResult> GetNotificationRequests()
        {
            var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(userId))
                return Unauthorized("User ID not found in token.");

            // Отримуємо всі унікальні RequestId із повідомлень поточного користувача
            var notifRequestIds = await _context.Notifications
                .Where(n => n.RecipientId == userId && n.RequestId.HasValue)
                .Select(n => n.RequestId.Value)
                .Distinct()
                .ToListAsync();

            if (!notifRequestIds.Any())
                return Ok(new List<RequestShortDTO>());

            var requests = await _context.Requests
                .Where(r => notifRequestIds.Contains(r.RequestId))
                .Select(r => new RequestShortDTO
                {
                    RequestId = r.RequestId,
                    Title = r.Title
                })
                .ToListAsync();

            return Ok(requests);
        }
    }
}


--- File: WarehouseController.cs (Path: .\AutomationOfPurchases.API\Controllers\WarehouseController.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace AutomationOfPurchases.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize(Roles = "WarehouseWorker")]
    public class WarehouseController : ControllerBase
    {
        private readonly AppDbContext _context;

        public WarehouseController(AppDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Повертає список ТМЦ із активного GeneralNeedsList (NullificationDate == null),
        /// згрупований за ItemId, для відображення на фронті.
        /// </summary>
        [HttpGet("grouped-needs")]
        public async Task<ActionResult<List<GroupedNeedDTO>>> GetGroupedNeeds()
        {
            // 1) Шукаємо активний GeneralNeedsList
            var activeList = await _context.GeneralNeedsLists
                .Include(l => l.Items).ThenInclude(gni => gni.Item)
                .Include(l => l.Items).ThenInclude(gni => gni.OrderedBy).ThenInclude(u => u.Department)
                .Where(l => l.NullificationDate == null)
                .FirstOrDefaultAsync();

            if (activeList == null)
                return Ok(new List<GroupedNeedDTO>()); // або NotFound(...)

            // 2) Групуємо GeneralNeedsItem за ItemId, щоб показати сумарні потреби
            var grouped = activeList.Items
                .GroupBy(x => x.ItemId)
                .Select(g =>
                {
                    var first = g.First();
                    int totalQty = g.Sum(it => it.Quantity);

                    return new GroupedNeedDTO
                    {
                        ItemId = first.ItemId,
                        ItemName = first.Item?.ItemName,
                        StorageUnit = first.Item?.StorageUnit,
                        TotalQuantity = totalQty,
                        IsExpanded = false, // Для Blazor

                        Requests = g.Select(x => new DepartmentRequestDTO
                        {
                            // У DepartmentRequestDTO.RequestItemId
                            // тимчасово зберігаємо GeneralNeedsItemId,
                            // щоб на фронті знати, що саме передати в SatisfyNeedModel:
                            RequestItemId = x.GeneralNeedsItemId,
                            DepartmentName = x.OrderedBy?.Department?.DepartmentName ?? "",
                            OrderedByFullName = x.OrderedBy?.FullName ?? "",
                            Quantity = x.Quantity,
                            OrderedById = x.OrderedById
                        }).ToList()
                    };
                })
                .Where(gr => gr.TotalQuantity > 0)
                .ToList();

            return Ok(grouped);
        }

        /// <summary>
        /// Задовольняє (QuantityToSatisfy) або позначає «Відсутньо» (IsNotAvailable) для 
        /// конкретного рядка GeneralNeedsItem, змінює оригінальний RequestItem 
        /// та надсилає повідомлення.
        /// </summary>
        [HttpPost("satisfy")]
        public async Task<IActionResult> SatisfyNeed([FromBody] SatisfyNeedModel model)
        {
            // 1) Знаходимо GeneralNeedsItem
            var gItem = await _context.GeneralNeedsItems
                .Include(gi => gi.Item)
                .Include(gi => gi.OrderedBy).ThenInclude(u => u.Department)
                .Include(gi => gi.OriginalRequestItem).ThenInclude(ri => ri.Item)
                .FirstOrDefaultAsync(gi => gi.GeneralNeedsItemId == model.GeneralNeedsItemId);

            if (gItem == null)
                return NotFound("GeneralNeedsItem not found.");

            // 2) Знаходимо оригінальний RequestItem (ri)
            var ri = gItem.OriginalRequestItem;
            if (ri == null)
                return BadRequest("No original RequestItem is linked to this record.");

            // 3) Підраховуємо, скільки залишилося задовольнити в оригіналі
            int leftover = ri.Quantity - (ri.DeliveredQuantity + ri.ToPurchaseQuantity);
            if (leftover <= 0)
                return Ok("No leftover in the original item (already satisfied or closed).");

            // 4) Отримуємо додаткові дані (для повідомлень)
            var itemName = ri.Item?.ItemName ?? "[N/A]";
            var originalRequestId = ri.RequestId;
            var authorId = ri.OrderedById; // Автор оригінальної заявки
            var authorUser = await _context.Users
                .Include(u => u.Department)
                .FirstOrDefaultAsync(u => u.Id == authorId);
            var deptHeadId = authorUser?.Department?.HeadOfDepartmentId;

            // Користувач, який зараз діє (складовик)
            var warehouseUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
            if (string.IsNullOrEmpty(warehouseUserId))
                return Unauthorized("Warehouse user ID not found in token.");

            // =====================
            // CASE A: "Відсутня" 
            // =====================
            if (model.IsNotAvailable)
            {
                // 1) Усе leftover → ToPurchaseQuantity
                ri.ToPurchaseQuantity += leftover;

                // 2) Додаємо запис у NetNeedsList
                var activeNet = await _context.NetNeedsLists
                    .FirstOrDefaultAsync(nl => nl.NullificationDate == null);
                if (activeNet == null)
                {
                    activeNet = new NetNeedsList
                    {
                        CreationDate = DateTime.UtcNow
                    };
                    _context.NetNeedsLists.Add(activeNet);
                    await _context.SaveChangesAsync();
                }
                var netItem = new NetNeedsItem
                {
                    NetNeedsListId = activeNet.ListId,
                    ItemId = ri.ItemId,
                    Quantity = leftover,
                    OrderedById = authorId, // хто автор цієї потреби
                    OriginalRequestItemId = ri.RequestItemId
                };
                _context.NetNeedsItems.Add(netItem);

                // 3) Створюємо повідомлення автору: “ТМЦ відсутня”
                if (!string.IsNullOrEmpty(authorId))
                {
                    var notifAuthor = new Notification
                    {
                        RecipientId = authorId,
                        Title = "ТМЦ відсутня на складі",
                        Message = $"Ваш запит на товар \"{itemName}\" (#{originalRequestId}) позначено як відсутній.",
                        LinkUrl = $"/request-details/{originalRequestId}",
                        Category = "Rejected",
                        RequestId = originalRequestId
                    };
                    _context.Notifications.Add(notifAuthor);

                    // Повідомлення керівнику (якщо інший)
                    if (!string.IsNullOrEmpty(deptHeadId) && deptHeadId != authorId)
                    {
                        var notifHead = new Notification
                        {
                            RecipientId = deptHeadId,
                            Title = "ТМЦ відсутня для підлеглого",
                            Message = $"Запит підлеглого (\"{authorUser?.FullName}\") на \"{itemName}\" позначено як відсутній на складі.",
                            LinkUrl = $"/request-details/{originalRequestId}",
                            Category = "Rejected",
                            RequestId = originalRequestId
                        };
                        _context.Notifications.Add(notifHead);
                    }
                }

                // Повідомлення економістам цього відділу,
                // що позиція переходить у NetNeedsList
                var deptId = authorUser?.DepartmentId;
                if (deptId.HasValue)
                {
                    var econIds = await _context.DepartmentEconomists
                        .Where(de => de.DepartmentId == deptId.Value)
                        .Select(de => de.EconomistId)
                        .ToListAsync();
                    foreach (var econId in econIds)
                    {
                        var notifEcon = new Notification
                        {
                            RecipientId = econId,
                            Title = "Нове додавання в чисті потреби",
                            Message = $"Товар \"{itemName}\" (#{originalRequestId}) відсутній на складі, додано в NetNeedsList.",
                            LinkUrl = "/net-needs",
                            Category = "Rejected",
                            RequestId = originalRequestId
                        };
                        _context.Notifications.Add(notifEcon);
                    }
                }

                await _context.SaveChangesAsync();
                return Ok($"Marked as not available => leftover {leftover} moved to NetNeeds.");
            }
            else
            {
                // =====================
                // CASE B: "Задовольнити" (QuantityToSatisfy)
                // =====================
                if (model.QuantityToSatisfy <= 0)
                    return BadRequest("QuantityToSatisfy must be > 0 if not pressing 'Відсутня'.");

                int canGive = Math.Min(leftover, model.QuantityToSatisfy);

                // 1) Збільшуємо DeliveredQuantity
                ri.DeliveredQuantity += canGive;

                // 2) Логуємо в DeliveryRequest
                var warehouseName = string.IsNullOrEmpty(model.WarehouseName)
                    ? "Основний склад"
                    : model.WarehouseName;

                var delivery = new DeliveryRequest
                {
                    RequestItemId = ri.RequestItemId,
                    ItemId = ri.ItemId,
                    Quantity = canGive,
                    OrderedById = warehouseUserId,
                    Warehouse = warehouseName
                };
                _context.DeliveryRequests.Add(delivery);

                // 3) Створюємо повідомлення для автора і керівника
                var isFullySatisfied = (ri.Quantity == ri.DeliveredQuantity + ri.ToPurchaseQuantity);
                var msgText = isFullySatisfied
                    ? $"повністю задоволено ({canGive} шт.)."
                    : $"частково задоволено ({canGive} шт. із {leftover}).";

                if (!string.IsNullOrEmpty(authorId))
                {
                    var notifAuthor = new Notification
                    {
                        RecipientId = authorId,
                        Title = "ТМЦ отримано зі складу",
                        Message = $"Ваш запит на товар \"{itemName}\" було {msgText}",
                        LinkUrl = $"/request-details/{originalRequestId}",
                        Category = "Approved",
                        RequestId = originalRequestId
                    };
                    _context.Notifications.Add(notifAuthor);

                    if (!string.IsNullOrEmpty(deptHeadId) && deptHeadId != authorId)
                    {
                        var notifHead = new Notification
                        {
                            RecipientId = deptHeadId,
                            Title = isFullySatisfied
                                ? "Запит підлеглого повністю задоволено"
                                : "Запит підлеглого частково задоволено",
                            Message = isFullySatisfied
                                ? $"Склад видав {canGive} шт. товару \"{itemName}\" (повне задоволення)."
                                : $"Склад видав {canGive} шт. товару \"{itemName}\". (Залишок у цього рядка ще {ri.Quantity - (ri.DeliveredQuantity + ri.ToPurchaseQuantity)}).",
                            LinkUrl = $"/request-details/{originalRequestId}",
                            Category = "Approved",
                            RequestId = originalRequestId
                        };
                        _context.Notifications.Add(notifHead);
                    }
                }

                await _context.SaveChangesAsync();

                // 4) Повертаємо результат
                if (canGive < model.QuantityToSatisfy)
                {
                    // Частково
                    return Ok($"Partially satisfied => gave {canGive}, leftover now = {leftover - canGive}.");
                }
                else
                {
                    // Повністю
                    return Ok("Fully satisfied from the warehouse.");
                }
            }
        }
    }
}


--- File: DatabaseSeeder.cs (Path: .\AutomationOfPurchases.API\Infrastructure\Seed\DatabaseSeeder.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Infrastructure.Seed
{
    public static class DatabaseSeeder
    {
        public static async Task SeedTestDataAsync(
            AppDbContext db,
            RoleManager<IdentityRole> roleManager,
            UserManager<AppUser> userManager)
        {
            // 1) Застосовуємо (за потреби) міграції
            db.Database.Migrate();

            // 2) Створюємо (якщо треба) ролі
            var roles = new[] { "User", "DepartmentHead", "Economist", "WarehouseWorker" };
            foreach (var roleName in roles)
            {
                if (!await roleManager.RoleExistsAsync(roleName))
                {
                    await roleManager.CreateAsync(new IdentityRole(roleName));
                }
            }

            // 3) Створюємо 5 департаментів, якщо ще не існують
            if (!db.Departments.Any())
            {
                var finance = new Department { DepartmentName = "Департамент фінансів", FreeCapital = 40000 };
                var sales = new Department { DepartmentName = "Департамент продажів", FreeCapital = 20000 };
                var itDept = new Department { DepartmentName = "Департамент IT", FreeCapital = 25000 };
                var whDept = new Department { DepartmentName = "Департамент першого складу", FreeCapital = 8000 };
                var mach = new Department { DepartmentName = "Машинобудівний департамент", FreeCapital = 30000 };

                db.Departments.AddRange(finance, sales, itDept, whDept, mach);
                await db.SaveChangesAsync();

                Console.WriteLine("Created 5 departments: Finance, Sales, IT, Warehouse, Machinery");
            }

            // Зчитаємо департаменти з БД
            var finDept = db.Departments.First(d => d.DepartmentName == "Департамент фінансів");
            var salesDept = db.Departments.First(d => d.DepartmentName == "Департамент продажів");
            var itDeptDb = db.Departments.First(d => d.DepartmentName == "Департамент IT");
            var whDeptDb = db.Departments.First(d => d.DepartmentName == "Департамент першого складу");
            var machDept = db.Departments.First(d => d.DepartmentName == "Машинобудівний департамент");

            // 4) Створюємо економістів, ЯКІ ФІЗИЧНО ПЕРЕБУВАЮТЬ У ФІНАНСОВОМУ ВІДДІЛІ
            //    (тобто departmentId = finDept, щоб їх заявки затверджував керівник фіндепу).
            var ecoOneId = await CreateUserIfNotExists(
                userManager,
                userName: "ecoOne",
                password: "EcoOne123!",
                fullName: "Єфименко Євген Вікторович",
                roleName: "Economist",
                departmentId: finDept.DepartmentId
            );
            var ecoTwoId = await CreateUserIfNotExists(
                userManager,
                userName: "ecoTwo",
                password: "EcoTwo123!",
                fullName: "Лучко Людмила Петрівна",
                roleName: "Economist",
                departmentId: finDept.DepartmentId
            );

            // 5) Прив’язуємо цих економістів до додаткових відділів (через DepartmentEconomists)
            //    ecoOne -> (fin, sales, it)
            //    ecoTwo -> (fin, warehouse, mach)
            if (!string.IsNullOrEmpty(ecoOneId))
            {
                await CreateEconomistInDepartments(db, ecoOneId, finDept.DepartmentId, salesDept.DepartmentId, itDeptDb.DepartmentId);
            }
            if (!string.IsNullOrEmpty(ecoTwoId))
            {
                await CreateEconomistInDepartments(db, ecoTwoId, whDeptDb.DepartmentId, machDept.DepartmentId);
            }

            // 6) Керівник фіндепу (єдиний у цьому відділі)
            var finHeadId = await CreateUserIfNotExists(
                userManager,
                userName: "finHead",
                password: "FinHead123!",
                fullName: "Ковальчук Олександр Миколайович",
                roleName: "DepartmentHead",
                departmentId: finDept.DepartmentId
            );
            if (!string.IsNullOrEmpty(finHeadId))
            {
                finDept.HeadOfDepartmentId = finHeadId;
                db.Departments.Update(finDept);
                await db.SaveChangesAsync();
            }

            // 7) Департамент продажів: 2 user, 1 head
            await CreateUserIfNotExists(
                userManager,
                userName: "salesUser1",
                password: "SalesUser1!",
                fullName: "Романенко Роман Юрійович",
                roleName: "User",
                departmentId: salesDept.DepartmentId
            );
            await CreateUserIfNotExists(
                userManager,
                userName: "salesUser2",
                password: "SalesUser2!",
                fullName: "Мельник Микола Васильович",
                roleName: "User",
                departmentId: salesDept.DepartmentId
            );
            var salesHeadId = await CreateUserIfNotExists(
                userManager,
                userName: "salesHead",
                password: "SalesHead123!",
                fullName: "Гончаренко Андрій Петрович",
                roleName: "DepartmentHead",
                departmentId: salesDept.DepartmentId
            );
            if (!string.IsNullOrEmpty(salesHeadId))
            {
                salesDept.HeadOfDepartmentId = salesHeadId;
                db.Departments.Update(salesDept);
                await db.SaveChangesAsync();
            }

            // 8) Департамент IT: 2 user, 1 head
            await CreateUserIfNotExists(
                userManager,
                userName: "itUser1",
                password: "ItUser1!",
                fullName: "Ярошенко Ярослав Богданович",
                roleName: "User",
                departmentId: itDeptDb.DepartmentId
            );
            await CreateUserIfNotExists(
                userManager,
                userName: "itUser2",
                password: "ItUser2!",
                fullName: "Бондаренко Богдан Михайлович",
                roleName: "User",
                departmentId: itDeptDb.DepartmentId
            );
            var itHeadId = await CreateUserIfNotExists(
                userManager,
                userName: "itHead",
                password: "ItHead123!",
                fullName: "Волошин Ігор Вікторович",
                roleName: "DepartmentHead",
                departmentId: itDeptDb.DepartmentId
            );
            if (!string.IsNullOrEmpty(itHeadId))
            {
                itDeptDb.HeadOfDepartmentId = itHeadId;
                db.Departments.Update(itDeptDb);
                await db.SaveChangesAsync();
            }

            // 9) Департамент першого складу: 2 user (WarehouseWorker), 1 head (WarehouseWorker + DeptHead)
            await CreateUserIfNotExists(
                userManager,
                userName: "whUser1",
                password: "WhUser1!",
                fullName: "Лисенко Леонід Васильович",
                roleName: "WarehouseWorker",
                departmentId: whDeptDb.DepartmentId
            );
            await CreateUserIfNotExists(
                userManager,
                userName: "whUser2",
                password: "WhUser2!",
                fullName: "Остапенко Олег Анатолійович",
                roleName: "WarehouseWorker",
                departmentId: whDeptDb.DepartmentId
            );
            var whHeadId = await CreateUserIfNotExists(
                userManager,
                userName: "whHead",
                password: "WhHead123!",
                fullName: "Савченко Сергій Олександрович",
                roleName: "WarehouseWorker",
                departmentId: whDeptDb.DepartmentId
            );
            if (!string.IsNullOrEmpty(whHeadId))
            {
                // Додаємо йому додатково роль DepartmentHead
                var whHeadUser = await userManager.FindByIdAsync(whHeadId);
                await userManager.AddToRoleAsync(whHeadUser, "DepartmentHead");

                // Прописуємо в сам департамент
                whDeptDb.HeadOfDepartmentId = whHeadId;
                db.Departments.Update(whDeptDb);
                await db.SaveChangesAsync();
            }

            // 10) Машинобудівний департамент: 2 user + 1 head
            await CreateUserIfNotExists(
                userManager,
                userName: "machUser1",
                password: "MachUser1!",
                fullName: "Степаненко Степан Степанович",
                roleName: "User",
                departmentId: machDept.DepartmentId
            );
            await CreateUserIfNotExists(
                userManager,
                userName: "machUser2",
                password: "MachUser2!",
                fullName: "Опря Олексій Романович",
                roleName: "User",
                departmentId: machDept.DepartmentId
            );
            var machHeadId = await CreateUserIfNotExists(
                userManager,
                userName: "machHead",
                password: "MachHead123!",
                fullName: "Дорошенко Дмитро Іванович",
                roleName: "DepartmentHead",
                departmentId: machDept.DepartmentId
            );
            if (!string.IsNullOrEmpty(machHeadId))
            {
                machDept.HeadOfDepartmentId = machHeadId;
                db.Departments.Update(machDept);
                await db.SaveChangesAsync();
            }

            // 11) Додаємо товарні позиції (Items), якщо треба
            await SeedItemsFromListAsync(db);

            Console.WriteLine("Database seeding completed with 5 departments, 2 economists in finance, no regular users in finance!");
        }

        /// <summary>
        /// Прив’язує користувача-економіста (userId) до переліку відділів (departmentIds),
        /// додаючи запис DepartmentEconomist для кожного.
        /// </summary>
        private static async Task CreateEconomistInDepartments(AppDbContext db, string economistUserId, params int[] departmentIds)
        {
            // Користувач уже належить до якоїсь DeptId, але тут робимо many-to-many зв’язки
            foreach (var deptId in departmentIds)
            {
                var exists = db.DepartmentEconomists.Any(de =>
                    de.DepartmentId == deptId && de.EconomistId == economistUserId);
                if (!exists)
                {
                    var link = new DepartmentEconomist
                    {
                        DepartmentId = deptId,
                        EconomistId = economistUserId
                    };
                    db.DepartmentEconomists.Add(link);
                    Console.WriteLine($"Economist '{economistUserId}' прив’язаний до DepartmentId={deptId}");
                }
            }
            await db.SaveChangesAsync();
        }

        /// <summary>
        /// Створює користувача з указаними параметрами, якщо його ще не існує;
        /// повертає Id створеного/існуючого користувача.
        /// </summary>
        private static async Task<string?> CreateUserIfNotExists(
            UserManager<AppUser> userManager,
            string userName,
            string password,
            string fullName,
            string roleName,
            int? departmentId)
        {
            var existingUser = await userManager.FindByNameAsync(userName);
            if (existingUser == null)
            {
                var user = new AppUser
                {
                    UserName = userName,
                    Email = userName + "@test.com",
                    FullName = fullName,
                    DepartmentId = departmentId
                };

                var createResult = await userManager.CreateAsync(user, password);
                if (createResult.Succeeded)
                {
                    await userManager.AddToRoleAsync(user, roleName);
                    Console.WriteLine($"User '{userName}' created, role '{roleName}', deptId={departmentId}.");
                    return user.Id;
                }
                else
                {
                    var errors = string.Join("; ", createResult.Errors.Select(e => e.Description));
                    Console.WriteLine($"Failed to create user '{userName}': {errors}");
                    return null;
                }
            }
            else
            {
                Console.WriteLine($"User '{userName}' already exists. Skipping.");
                return existingUser.Id;
            }
        }

        /// <summary>
        /// Якщо треба додати кілька Item, якщо ще не існують у БД.
        /// </summary>
        private static async Task SeedItemsFromListAsync(AppDbContext db)
        {
            if (!db.Items.Any())
            {
                var items = new List<Item>
                {
                  new Item { ItemName = "ЛИСТ ЗІ СТАЛІ 500HBW б=40мм", StorageUnit = "т" },
new Item { ItemName = "МЕТАЛОКОНСТРУКЦІЇ 1725.2-1-106.11-КМ", StorageUnit = "т" },
new Item { ItemName = "МЕТАЛОКОНСТРУКЦІЇ 1725.2-1-106.11-КМ", StorageUnit = "т" },
new Item { ItemName = "РЕШІТКОВИЙ НАСТИЛ ПРЕСОВАНИЙ KOP 22*22/30*3 оц", StorageUnit = "т" },
new Item { ItemName = "ФУТЕРУВАЛЬНИЙ МАТЕРІАЛ \"КОРУНДОВА ПЛИТКА AL2O3 НА ГНУЧКІЙ ОСНОВІ 494*965мм", StorageUnit = "м2" },
new Item { ItemName = "ФУТЕРУВАЛЬНИЙ МАТЕРІАЛ \"КОРУНДОВА ПЛИТКА AL2O3 НА ГНУЧКІЙ ОСНОВІ 494*965мм", StorageUnit = "м2" },
new Item { ItemName = "БОРТ ГУМОВИЙ (БЕЗ КОРДА) АМ.62-583.00.02-01", StorageUnit = "шт" },
new Item { ItemName = "ОБИЧАЙКА КОРПУСУ ПЕЧІ 40.4442.001", StorageUnit = "шт" },
new Item { ItemName = "ЕЛЕКТРОДИ ГРАФІТОВАНІ В КОМПЛЕКТІ З НІПЕЛЯМИ Ф 200 ММ", StorageUnit = "т" },
new Item { ItemName = "МУФТА D=50мм", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ф32 ЭК", StorageUnit = "шт" },
new Item { ItemName = "МУФТА В-В Мод.0270 09 \"GENEBRE\"", StorageUnit = "шт" },
new Item { ItemName = "МУФТА СТАЛЕВА ПРЯМА Ду50 ГОСТ 8966-75", StorageUnit = "шт" },
new Item { ItemName = "ТРІЙНИК РІВНОПРОХОДНИЙ D=325*10мм ГОСТ 17376-2001", StorageUnit = "шт" },
new Item { ItemName = "ПАТРУБОК ГУМОВО-МЕТАЛЕВИЙ З ФЛАНЦЕМ D=300; L=515", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ПЕРЕХІДНА МІДНА D= 42*22", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ПЕРЕХІДНА СТАЛЬНА d= 42*15", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД ГУМОВИЙ D400 X300", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД СТАЛЕВИЙ 57*5-25*3 ГОСТ 17378-2001", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД СТАЛЕВИЙ К 325*8-159*6", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД СТАЛЕВИЙ 720*14-630*14 ОСТ 3622-77", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД СТАЛЕВИЙ К 2-325*8-219*7 ГОСТ 17378;2003", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД СТАЛЕВИЙ К 426*12-219*10мм ДСТУ ГОСТ 17378:2003", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕХІД СТАЛЕВИЙ К 42,4*3,6-33,7*3,2 ст.20 ДСТУ ГОСТ 17378:2003", StorageUnit = "шт" },
new Item { ItemName = "ЗАГЛУШКА 325*10 ДСТУ ГОСТ 17 379:2003", StorageUnit = "шт" },
new Item { ItemName = "ЗАГЛУШКА D=283 (АМ.62-28.00.36)", StorageUnit = "шт" },
new Item { ItemName = "ЗАГЛУШКА СТАЛЕВА 76*3 ГОСТ 17379-2003", StorageUnit = "шт" },
new Item { ItemName = "ЗАГЛУШКА ФЛАНЦЕВА 1-300-10 ГОСТ 12836-67", StorageUnit = "шт" },
new Item { ItemName = "ФУТОРКА Ду 32*15", StorageUnit = "шт" },
new Item { ItemName = "ЗГІН G 1/2-А (94.4987.001)", StorageUnit = "шт" },
new Item { ItemName = "ЗГІН-АМЕРИКАНКА ПРЯМИЙ 1 1/2\"", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=325*8мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=325*8мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=325*8мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=219*8мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=219*8мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=133*6мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=133*6мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=133*6мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД ЗАГНУТИЙ 90град. D=219*4мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=40*3,5мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=426*10мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=426*10мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 60град. D=325*8мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=57*5мм ДСТУ ГОСТ 17378-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=108*3,5мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=325*16мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=325*16мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=530*16мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 60град. D=159*14мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=273*8мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 60град. D=325*10мм", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=720*10мм", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=219*8мм", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=219*14мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=325*14мм ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=426*14мм ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 30град. D=325*14мм ДСТУ ГОСТ 17375-2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 45град. D=159*14мм ДСТУ ГОСТ 17375:2003", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД МЕТАЛЕВИЙ ОБГУМОВАНИЙ 15-1-355,6*1 (2.3735-253-ТХ2)", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД МЕТАЛЕВИЙ ОБГУМОВАНИЙ 17-1-355,6*1 (2.3735-253-ТХ2)", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД МЕТАЛЕВИЙ ОБГУМОВАНИЙ 31-1-355,6*1 (2.3735-253-ТХ2)", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. D=426*12мм", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 60град. D=273*14мм ДСТУ ГОСТ 17375", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 90град. Ду50", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД СТАЛЕВИЙ 30град. D=102*6мм 17375-2001", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД ГУМОВИЙ 90град. D=325мм 3430/6-101.3-ТК 1.1", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД ГУМОВАНИЙ (КОМПЛЕКТНО: З ФЛАНЦЕМ, ВІДПОВІДНИМ ФЛАНЦЕМ ПІД ТРУБУ D=426 і КРІПЛЕННЯ) Ду400 37град.", StorageUnit = "шт" },
new Item { ItemName = "ВІДВІД ГУМОВИЙ D=426 ОТР-Н 426.95.02 ВО", StorageUnit = "шт" },
new Item { ItemName = "КОМПЛЕКТ ЗВОРОТНИХ ФЛАНЦІВ З ПРОКЛАДКАМИ ТА КРІПЛЕННЯМ DN200 PN16", StorageUnit = "компл" },
new Item { ItemName = "ФЛАНЕЦЬ D=630, d=520 (АМ.62-28.00.02)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=565, d=430 (АМ.62-28.00.05)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=345, d=230 (АМ.62-28.00.06)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=450, d=325 (АМ.62-28.00.07)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=538, d=325 (АМ.62-28.00.13)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=505, d=345 (АМ.62-28.00.14)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=640, d=530 (АМ.62-28.00.18)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=600, d=430 (АМ.62-28.00.20)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=535, d=370 (АМ.62-28.00.22)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=820, d=690 (АМ.62-28.00.24)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=193, d=91 (АМ.62-28.00.32)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=234, d=134 (АМ.62-28.00.33)", StorageUnit = "шт" },
new Item { ItemName = "ФЛАНЕЦЬ D=640, d=320 (АМ.62-28.00.35)", StorageUnit = "шт" },
new Item { ItemName = "ВСТАВКА ГУМОВА  Ду150 56.2778.004", StorageUnit = "шт" },
new Item { ItemName = "ПЕРЕТВОРЮВАЧ ЧАСТОТИ З ПАНЕЛЛЮ УПРАВЛІННЯ ACS550-01-087A-4", StorageUnit = "шт" },
new Item { ItemName = "SEW ПЕРЕТВОРЮВАЧ ЧАСТОТНИЙ 206401915", StorageUnit = "шт" },
new Item { ItemName = "СТРОП 4СК1 12,5/4500", StorageUnit = "шт" },
new Item { ItemName = "СТРОП 4СК 10,0/3000 ГОСТ 25573-82", StorageUnit = "шт" },
new Item { ItemName = "БУФЕР ГОРИЗОНТАЛЬНИЙ 11431.2.4СБ", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРОМІЖНИЙ 11431.10СБ", StorageUnit = "шт" },
new Item { ItemName = "ТЯГЛО 561331073", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ ГАЛЬМІВНИЙ D=400мм С282.423", StorageUnit = "шт" },
new Item { ItemName = "СИСТЕМА ПЕРЕСУВАННЯ РУКАВА Дв25 мм FESTOON", StorageUnit = "шт" },
new Item { ItemName = "БОЛТ М64*300 4-86778", StorageUnit = "шт" },
new Item { ItemName = "ШПОНКА 40*22*180 (110.4739.001)", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ 1510*1190*160", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА 3020, D=55мм, SA952801", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА (ДЛЯ ЕЛЕКТРОДВИГУНА \"БАРМАК\") B96AT02", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА (869.0283-00) MGT Nr125 Di95mm", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА для 61-564130 \"МЕТСО\" кат.61-586287", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА MGT Nr125 Di110 (869.0286-00)", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА MGT Nr125 Di110 (869.0286-00)", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА MGT Nr125 Di110 (869.0286-00)", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ (ДЛЯ ЕЛЕКТРОДВИГУНА \"БАРМАК\") B96AT15", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ PHP 4SPC200TB SKF", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ SPC 335 MGT 125-10 (879.0511-00)", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ SPC 400 MGT 125-12 (879.0499-00)", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ ВЕДЕНИЙ SPC 5.265", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ ВЕДЕНИЙ SPC 5.265-01", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ SPC 500 MGT 125 (879.0497-00)", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ SPC 500 MGT 125 (879.0497-00)", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ SPC 500 MGT 125 (879.0497-00)", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ З ВТУЛКОЮ В ЗБОРІ SPC265-03 (TB 3535)+TB 3535 d=48mm", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ У ЗБОРІ З ВТУЛКОЮ PHP 3SPC200TB (SKF)", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-4", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-6", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-6", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-6", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-7", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-7", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-8", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-9", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-9", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ЗУБЧАСТА МЗ-9", StorageUnit = "шт" },
new Item { ItemName = "НАПІВМУФТА З ЧОРНОВИМ ОТВОРОМ РНЕ FRC90RSB", StorageUnit = "шт" },
new Item { ItemName = "ТРУБА ГУМОВО-МЕТАЛЕВА D=200; L=665", StorageUnit = "шт" },
new Item { ItemName = "ТРУБА ГУМОВА D=426; L=910", StorageUnit = "шт" },
new Item { ItemName = "ТРУБА ГУМОВО-МЕТАЛЕВА D=300; L=1050", StorageUnit = "шт" },
new Item { ItemName = "ТРУБА ГУМОВО-МЕТАЛЕВА D=250; L=1010", StorageUnit = "шт" },
new Item { ItemName = "ВОРОТА РАСПАШНЫЕ АМ.01-622.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "ВОРОТА РАСПАШНЫЕ АМ.01-631.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "ВОРОНКА ЗАВАНТАЖЕННЯ НАСОСУ ТА-42А НПВ 110-2 639-105-КМ (арк.1-3)", StorageUnit = "шт" },
new Item { ItemName = "ЩИТ ПЕРЕКРИТТЯ Щ1 2658.1-1-КБ02", StorageUnit = "шт" },
new Item { ItemName = "ЩИТ ПЕРЕКРИТТЯ Щ2 2658.1-1-КБ02", StorageUnit = "шт" },
new Item { ItemName = "ЩИТ ПЕРЕКРИТТЯ Щ3 2658.1-1-КБ02", StorageUnit = "шт" },
new Item { ItemName = "ЩИТ ПЕРЕКРИТТЯ Щ4 2658.1-1-КБ02.1", StorageUnit = "шт" },
new Item { ItemName = "ПЛАСТИНА 6*130*1500", StorageUnit = "шт" },
new Item { ItemName = "ПЛАСТИНА ПРАВА  10*320*2170(62.13336.04) (ЗАМОВЛЕННЯ 0201568)", StorageUnit = "шт" },
new Item { ItemName = "ПЛАСТИНА ПРАВА  10*320*2170(62.13336.04) (ЗАМОВЛЕННЯ 0201568)", StorageUnit = "шт" },
new Item { ItemName = "ПЛАСТИНА ПРАВА  10*320*2170(62.13336.04) (ЗАМОВЛЕННЯ 0201568)", StorageUnit = "шт" },
new Item { ItemName = "ОПОРА МЕТАЛЕВА ОМ1 13105.Р90/273.1-1-21-КБ", StorageUnit = "шт" },
new Item { ItemName = "ЗАГОТОВКА ВКЛАДИША 43.3828.002 (ЗАКАЗ 0402419)", StorageUnit = "шт" },
new Item { ItemName = "ЗАГОТІВЛЯ ВТУЛКИ НАТЯЖНОГО КОЛЕСА 3502.05.02.302 БрА9Ж3Л", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА МАТОЧИНИ ГС.62-599.00.01 (ЗАКАЗ 0302350)", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА МАТОЧИНИ ГС.62-569.00.01 (ЗАКАЗ 0302340)", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА ВТУЛКИ ТРАВЕРЗИ М608-11/2 ГОСТ 380-11 (ЗАМОВЛЕННЯ 0406560)", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА КОРПУСУ 43.3828.001 А (ЗАМОВЛЕННЯ 0406901)", StorageUnit = "шт" },
new Item { ItemName = "ЗАГОТІВКА КОРПУСА 31122.625.231А.ЗАГ СТ. 3 ГОСТ 380-94 (З/З 0406318 И 0406319)", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА ШЕСТІРНІ D=320*d=80*223 (ЗАМОВЛЕННЯ 0402626)", StorageUnit = "шт" },
new Item { ItemName = "ГІДРОЗАМОК ЗМ10 091-60.280151-03", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА ПІВМУФТИ 430*100", StorageUnit = "шт" },
new Item { ItemName = "КОЖУХ ЗАВИТКА R=3000 62-12253.04.06.000СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ (кр.БП.800.1.000СБ) З.11164 КОД 531010", StorageUnit = "шт" },
new Item { ItemName = "62.11677.00.00.00.СБ БАРАБАН ПОВІДНИЙ D495", StorageUnit = "шт" },
new Item { ItemName = "КОНВЕЄР (БЕЗ СТРІЧКИ) 2658.1-6-ТХ2.1 КС-6-3", StorageUnit = "шт" },
new Item { ItemName = "КОНВЕЄР (БЕЗ СТРІЧКИ) 2658.1-7-ТХ2.1 КС-6-4", StorageUnit = "шт" },
new Item { ItemName = "КОНВЕЄР (БЕЗ СТРІЧКИ) 2658.1-6-ТХ2.2 КС-7-3", StorageUnit = "шт" },
new Item { ItemName = "КОНВЕЄР (БЕЗ СТРІЧКИ) 2658.1-7-ТХ2.2 КС-7-4", StorageUnit = "шт" },
new Item { ItemName = "62.12368.00.00.00.СБ БАРАБАН ВІДХИЛЮВАЛЬНИЙ D325", StorageUnit = "шт" },
new Item { ItemName = "62.12033.00.00.00.СБ БАРАБАН ВІДХИЛЮВАЛЬНИЙ D800", StorageUnit = "шт" },
new Item { ItemName = "62.12098.00.00.00.СБ БАРАБАН ВІДХИЛЮВАЛЬНИЙ D420", StorageUnit = "шт" },
new Item { ItemName = "62.11686.00.00.00.СБ БАРАБАН ВІДХИЛЮВАЛЬНИЙ D630", StorageUnit = "шт" },
new Item { ItemName = "62.11686.00.00.00.СБ БАРАБАН ВІДХИЛЮВАЛЬНИЙ D630", StorageUnit = "шт" },
new Item { ItemName = "РОЛИК СПЕЦІАЛЬНИЙ", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПОВІДНИЙ 41185-01.000СБ (ЗАМОВЛЕННЯ 0401419)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 160.80.120.000Б СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 160.63.100.000В СБ", StorageUnit = "шт" },
new Item { ItemName = "ШНЕК 83.4134.000СБ", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ ГАЛЬМІВНИЙ 2805155-1", StorageUnit = "шт" },
new Item { ItemName = "МУФТА СПЕЦІАЛЬНА ДОПОМІЖНОГО ПРИВОДУ 62.12889.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН  ПОВІДНИЙ БН1200.100СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ГОЛОВНИЙ 26.4165.000СБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  63.4153.001", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ БП1250.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 100.320.80.000СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН КІНЦЕВИЙ 1400-1250-160.000АСБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D630*1400 89-669", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 14.2632.000СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 14.2632.000СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 14.2632.000СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 14.2739.100СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D=630*1150 (89-708)", StorageUnit = "шт" },
new Item { ItemName = "РАМА ПРИВІДНОГО БАРАБАНА 62-13227.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ  D=630 (62.13074.00.00.00СБ)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ  D=630 (62.13074.00.00.00СБ)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЮВАЛЬНИЙ 38.509.00.000.СБ", StorageUnit = "шт" },
new Item { ItemName = "ЗУПИННИК ХРАПОВИЙ 63.3221.000СБ (ЗАМОВЛЕННЯ 0402084)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D=500 ОФ-И-291АСБ (ЗАМОВЛЕННЯ 0301425)", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  84.3581.001", StorageUnit = "шт" },
new Item { ItemName = "ГІДРОЦИЛІНДР ХОД 204мм,Qmax=2000фут/дм2", StorageUnit = "шт" },
new Item { ItemName = "ГІДРОЦИЛІНДР ХОД 204мм,Qmax=2000фут/дм2", StorageUnit = "шт" },
new Item { ItemName = "ГІДРОЦИЛІНДР ХОД 204мм,Qmax=2000фут/дм2", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ГОЛОВНИЙ 31128.200.310СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ГОЛОВНИЙ 31128.200.310СБ", StorageUnit = "шт" },
new Item { ItemName = "РАМА НЕРОБОЧОГО БАРАБАНА 62-13464.02.00СБ", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА 31128.01.017 (ЗАМОВЛЕННЯ 20199/0402691)", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  26.4447.001 (ЗАМОВЛЕННЯ 30472/0403328)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D=630 ОФ-И-314", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D=630 ОФ-И-314", StorageUnit = "шт" },
new Item { ItemName = "НАСОС ГІДРАВЛІЧНИЙ З  РЕГУЛЯТОРОМ ТИСКУ ДМ-6011-Y", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЮВАЛЬНИЙ (ЦПТ) D=1250*1800", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ  (ЦПТ) D=1600*1800", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ  (ЦПТ) D=1600*1800", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  25.1844.001 (ЗАМОВЛЕННЯ 20275/0400963)", StorageUnit = "шт" },
new Item { ItemName = "РАМА ХРАПОВОГО ЗУПИННИКА 2Б05470.1-0", StorageUnit = "шт" },
new Item { ItemName = "РАМА ХРАПОВОГО ЗУПИННИКА 2Б05470.1-0", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 100.63-100", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 100.63-100", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 100.63-100", StorageUnit = "шт" },
new Item { ItemName = "ТРУБОПРОВІД ГНУЧКИЙ 25.4747.000АСБ", StorageUnit = "шт" },
new Item { ItemName = "ТРУБОПРОВІД ГНУЧКИЙ 25.4747.000АСБ", StorageUnit = "шт" },
new Item { ItemName = "ОЧИСНИК КОНВЕЄРНОЇ СТРІЧКИ В=1000", StorageUnit = "шт" },
new Item { ItemName = "РОЛИК З ПОДОВЖЕНИМ ВАЛОМ 152*1800", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  54.3319.001", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D=800*1400", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН D=800*1400", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  54.4250.001 (ЗАМОВЛЕННЯ 20756/0404867)", StorageUnit = "шт" },
new Item { ItemName = "ОЧИСНИК КОНВЕЄРНОЇ СТРІЧКИ ГС.62-305.00.00АСБ (ЗАМОВЛЕННЯ 0201693)", StorageUnit = "шт" },
new Item { ItemName = "ОЧИСНИК КОНВЕЄРНОЇ СТРІЧКИ ГС.62-305.00.00АСБ (ЗАМОВЛЕННЯ 0201693)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ D=2000*2200ТЗ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ D=2000*2200ТЗ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ D=2000*1800ТЗ", StorageUnit = "шт" },
new Item { ItemName = "ЗМІННЕ ПОЛІУРЕТАНОВЕ ЛЕЗО CRB-1150", StorageUnit = "шт" },
new Item { ItemName = "ЗМІННЕ ПОЛІУРЕТАНОВЕ ЛЕЗО CRB-1150", StorageUnit = "шт" },
new Item { ItemName = "ПОКОВКА РОЛИКА 31118.654.611 (ЗАМОВЛЕННЯ 0400824)", StorageUnit = "шт" },
new Item { ItemName = "ОБИЧАЙКА 800*1600*12 (КН-00-012В)", StorageUnit = "шт" },
new Item { ItemName = "ОЧИСНИК КОНВЕЄРНОЇ СТРІЧКИ ГС.62-300.00.00АСБ (ЗАМОВЛЕННЯ 0201679)", StorageUnit = "шт" },
new Item { ItemName = "ВІЗОК 47-1076-200СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 1250*1150", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  38-983.02", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ 82.4876.001 (ЗАМОВЛЕННЯ 40279/0405358)", StorageUnit = "шт" },
new Item { ItemName = "ВОРОНКА №1 РОЗВАНТАЖЕННЯ РУДИ НА КОНВЕЄР 62-13650.01.00.00.СБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  15.1664.002", StorageUnit = "шт" },
new Item { ItemName = "ПРИСТРІЙ НАТЯЖНИЙ ГВИНТІВИЙ 16063ВУ-100-50", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 500*1400 (89.5010.000СБ)", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  КЦ2-750 (ГС.62-570.00.03)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ 630*1400 (89-669А.СБ)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЮВАЛЬНИЙ D=1600*2200.ТЗ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ  D=1250*1800.ТЗ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ  D=1250*2200.ТЗ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ 67-660АСБ", StorageUnit = "шт" },
new Item { ItemName = "КОЛІСНА ПАРА ГС.62-667.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 88.1688.000СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 88.1688.000СБ", StorageUnit = "шт" },
new Item { ItemName = "РАМА 3393-01.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРОВІДНИЙ (D=630) ГС.62-828.00.00.00.СБ", StorageUnit = "шт" },
new Item { ItemName = "СТАКАН 62.12061.00.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  54.3326.001", StorageUnit = "шт" },
new Item { ItemName = "РАМА КОНВЕЄРА 28.4862.00.000Р-01СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 89-527-00А.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 89-527-00А.СБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  73.5228.001", StorageUnit = "шт" },
new Item { ItemName = "ДИСК 73.5228.003", StorageUnit = "шт" },
new Item { ItemName = "ДИСК 55.1960.001", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 160-80Г-120.000В.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН КІНЦЕВИЙ 1400.800-100.000БСБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  38-417.01", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ D=1600*2200", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЯЮЧИЙ D=1250*2200", StorageUnit = "шт" },
new Item { ItemName = "РАМА 61.5123.000СБ", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВІДНИЙ К5-К6 D=160/150/140 L=2723", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВІДНИЙ К7 D=160/150/140 L=2323", StorageUnit = "шт" },
new Item { ItemName = "КОМПЛЕКТ ФІКСУЮЧИХ ЕЛЕМЕНТІВ ПРИВОДНОГО БАРАБАНА LE160", StorageUnit = "компл" },
new Item { ItemName = "КОМПЛЕКТ ФІКСУЮЧИХ ЕЛЕМЕНТІВ ВІДВІДНОГО БАРАБАНА LE80", StorageUnit = "компл" },
new Item { ItemName = "ПІВМУФТА ЕЛЕКТРОДВИГУНА ГС.55-1272.00.01", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ А2.КС.00.001.01", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН КІНЦЕВИЙ d=1250 1400.1600Ф-200-2-000 Б СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ 89-725А.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 53.3197.100А.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 53.3197.100А.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 12065Ф-120 (123.613.000Г.СБ)", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ РСЦ.55.7А.-1687.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 26.5065.000.СБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА БАРАБАНА РСЦ.55.15-1788.00.01", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ (10043Ф-80) РСЦ.55.89-1785.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЮВАЛЬНИЙ 160103Ф-200 (89-532 Б СБ)", StorageUnit = "шт" },
new Item { ItemName = "НАТЯЖНИЙ ПРИСТРІЙ 38.512.00.000АСБ", StorageUnit = "шт" },
new Item { ItemName = "ПРОКЛАДКА ГС.55.97-1553.00.01-04", StorageUnit = "шт" },
new Item { ItemName = "БАЛКА ОПОРНА РСЦ.55.25-1852.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЯЮЧИЙ 8043Ф-60 38-460.00.000БСБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВIДНИЙ 8053Ф-80 89-700Б.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ 12066Ф-80 89-669Б.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ 10043Ф-60 64.545.000Г.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВІДНИЙ 10053Ф-60 89-725Б.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВIДНИЙ 10066Ф-100 89-708В.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВIДНИЙ 10066Ф-100 89-708В.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВIДНИЙ У ЗБОРI 274 34,5Ф-90 28.4877.00.000Р1.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВIДНИЙ У ЗБОРI 274 34,5Ф-90 28.4877.00.000Р1.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ У ЗБОРI 274 34,5Ф-90 28.4874.00.000Р1.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ У ЗБОРI 274 34,5Ф-90 28.4874.00.000Р1.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12083Ф-80 89.4988.000 А СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН СВАРНОЙ 10034Ф-80 89.726.100Р1 СБ", StorageUnit = "шт" },
new Item { ItemName = "ФУТЕРІВКА LG509 W290 EP10 N14203655", StorageUnit = "шт" },
new Item { ItemName = "ФУТЕРІВКА LG587 L215 EP10 N14203660", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЮВАЛЬНИЙ 14043Ф-60 1400.400-60.000ВСБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВIДНИЙ 10043Ф-80 РСЦ.55.89-1615.00.00 А СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПОВIДНИЙ 10043Ф-80 РСЦ.55.89-1615.00.00 А СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН 38-487.00 Б СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ВІДХИЛЮВАЛЬНИЙ 38-509.00.000 В СБ", StorageUnit = "шт" },
new Item { ItemName = "ПЛАСТИНА РСЦ.55.97-1834.00.01-04", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ D=325 62.1194.09.04.00.00.СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 89.1107.000Б.СБ", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПОВІДНИЙ У ЗБОРІ РСЦ.55.73-1964.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "ОЧИЩУВАЧ ГРУБОЇ ОЧИСТКИ ROUGH POLIMER CLEANING В=1000", StorageUnit = "шт" },
new Item { ItemName = "ОЧИЩУВАЧ ТОНКОЇ ОЧИСТКИ FINE BE-METAL CLEANING В=1000", StorageUnit = "шт" },
new Item { ItemName = "РОЛИКООПОРА НИЖНЯ САМОРЕГУЛЮЮЧА HOSCH RRC2-1600", StorageUnit = "шт" },
new Item { ItemName = "ХРАПОВИЙ ЗУПИННИК З МУФТОЙ ЗУБЧАТОЙ  СБОРКА ЛІВА 2Бу05470-2", StorageUnit = "шт" },
new Item { ItemName = "РЕШІТКА ПРИЙМАЛЬНОГО БУНКЕРУ РБ 01.000 СБ", StorageUnit = "шт" },
new Item { ItemName = "РАМА ПРИВОДУ ЛК-4 62-12027.10.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "ХРАПОВИЙ ЗУПИННИК З МУФТОЙ ЗУБЧАТОЙ 2Бу05471-1 (ЗБІРКА ПРАВА)", StorageUnit = "шт" },
new Item { ItemName = "РАМА ПРИВІДНОГО БАРАБАНУ ЛК-6 62.12422.00.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "РАМА ПРИВІДНОГО БАРАБАНУ ЛК-7 62.12745.00.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "CКРЕБОК В=1200 ДО ОЧИЩУВАЧА  ПЕРВИННОГО \"FLEXCO\"  MМP660 TRB48/76490", StorageUnit = "шт" },
new Item { ItemName = "НАПІВМУФТА 55-15552.02.00.00.01", StorageUnit = "шт" },
new Item { ItemName = "НАПІВМУФТА 55-15552.02.00.00.01", StorageUnit = "шт" },
new Item { ItemName = "БОРТ ГУМОВИЙ (БЕЗ КОРДА) АМ.62-583.00.01-01", StorageUnit = "шт" },
new Item { ItemName = "РЕМКОМПЛЕКТ ДЛЯ ШТОКА ГІДРОЦИЛІНДРА К505687-900", StorageUnit = "шт" },
new Item { ItemName = "БОРТ ГУМОВИЙ (БЕЗ КОРДА) ДТО.55.15-2054.00.01-01", StorageUnit = "шт" },
new Item { ItemName = "ОЧИЩУВАЛЬНИЙ БЛОК – СУВАЮЧИЙ HOSCH VC1/VC2 (ID 0631010) 200мм", StorageUnit = "шт" },
new Item { ItemName = "РАМА ОПОРНА РУХЛИВА ДТО.55.25-2083.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "ГІДРОЦИЛІНДР HC 150_125_5181.6 В КОМПЛЕКТІ З ДОДАТКОВИМ РЕМОНТНИМ КОМПЛЕКТОМ УЩІЛЬНЕНЬ HC 150_125_5181.6", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ ДТО-2117.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 8040Ф-60 ДТО-2136.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 8040Ф-60 ДТО-2136.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 10050Ф-80 ДТО-2115.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 8050Ф-80 ДТО-2118.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 160100Ф-200 ДТО-2123.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ 10050Ф-60 ДТО-2142.01.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 16080Ф-140 ДТО-2213.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 140100Ф-150 ДТО-2138.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 16063Ф-100 ДТО-2128.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 16063Ф-100 ДТО-2128.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12063Ф-80 ДТО-2122.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12063Ф-80 ДТО-2122.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12063Ф-80 ДТО-2122.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12063Ф-80 ДТО-2122.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "КОМПЛЕКТ МЕТАЛЕВОЇ ФУТЕРІВКИ ДЛЯ ЖОЛОБА РОЗВАНТАЖУВАЛЬНОГО ПТ1002-ТХ.К.8", StorageUnit = "компл" },
new Item { ItemName = "КОМПЛЕКТ МЕТАЛЕВОЇ ФУТЕРІВКИ ДЛЯ ЖОЛОБА РОЗВАНТАЖУВАЛЬНОГО М2659.1.10-ТХ.К.8", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 12080Ф-160 ПТ 1002-ТХ.К.300", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 12063Ф-100 М2659.1.10-ТХ.К.300", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ 12080-120 ПТ 1002-ТХ.К.620", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ 12063-100 М2659.1.10-ТХ.К.250", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ОБОРОТНИЙ 12050-80 ПТ 1002-ТХ.К.250", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАННИЙ НІЖ-ОЧИСНИК БН1-04", StorageUnit = "шт" },
new Item { ItemName = "РОЛИКООПОРА ЦЕНТРИРУЮЩАЯ НИЖНЯ НЦГ120-159 ПТ1002-ТХ.К.950", StorageUnit = "шт" },
new Item { ItemName = "РОЛИК КОНВЕЄРНИЙ 159х1400 підш.408 РК 159.408л.00.000-01СБ", StorageUnit = "шт" },
new Item { ItemName = "ЗМІННЕ ЛЕЗО ДО ОЧИСНИКА (ВЕРХНІЙ) QC1HC-48MC40BR+E", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ 10040Ф-100 ДТО-2246.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 10032Ф-80 ДТО-2245.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 10032Ф-80 ДТО-2245.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 160-125Ф-200 М ДТО-2293.00.00 М ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 160-125Ф-200 М ДТО-2293.00.00 М ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 200-160Ф-200 У М ДТО-2295.00.00 М ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 200-160Ф-200 У М ДТО-2295.00.00 М ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ КОНВЕЄРУ К5-1 4678.1531.35.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ КОНВЕЄРУ К5-1 4678.1531.36.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ КОНВЕЄРУ К5-1 4678.1531.37.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ КОНВЕЄРУ К6-1 4678.1531.38.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ КОНВЕЄРУ К6-1 4678.1531.39.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ КОНВЕЄРУ К6-1 4678.1531.40.00.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ КОНВЕЄРА ЛК7 46.78-1531-11.02.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ КОНВЕЄРА ЛК7 46.78-1531-11.03.00", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 10043Ф-80 SKF ДТО-2319.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 10043Ф-80 SKF ДТО-2319.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 160100Ф-200М ДТО-2123.00.00М ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12063Ф-80М ДТО-2122.00.00М ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕ ПРИВІДНИЙ 12050Ф-100М ДТО-2137.00.00М СБ", StorageUnit = "шт" },
new Item { ItemName = "ПРИВІД ШИБЕРА БЕЗ МОТОР-РЕДУКТОРА ТО-4874.065.000 СБ", StorageUnit = "шт" },
new Item { ItemName = "СТАНЦІЯ НАТЯЖНА 274.32Ф-120 55.23-2564.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ГОЛОВНИЙ 14025Ф-120М ДТО.55.25-2244.00.00М1 ВО", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НЕПРИВІДНИЙ 10063Ф-80М ДТО-2706.00.00М ВО", StorageUnit = "шт" },
new Item { ItemName = "ДЕМПФЕРНА СТАНЦІЯ DRXD-48-535", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 30132", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПРИВІДНИЙ 30133", StorageUnit = "шт" },
new Item { ItemName = "ФІКСОВАНА ОПОРА P4B-IP-090MR", StorageUnit = "шт" },
new Item { ItemName = "ПЛАВАЮЧА ОПОРА P4B-IP-090MRE", StorageUnit = "шт" },
new Item { ItemName = "ШВИДКОХІДНА МУФТА ДО ПРИВОДУ 18,5кВт-EFC-05", StorageUnit = "шт" },
new Item { ItemName = "ШВИДКОХІДНА МУФТА ДО ПРИВОДУ 30кВт-EFC-05", StorageUnit = "шт" },
new Item { ItemName = "РОЛИКООПОРА Б-1400", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ БП 1250.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "РАМА ПРИВІДНОГО БАРАБАНА ГС.62-37.02.00СБ", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН ПОВІДНИЙ 123.613.000АБВсб (ЗАМОВЛЕННЯ 50407/0401633)", StorageUnit = "шт" },
new Item { ItemName = "РОЛИК ЗВОРОТНІЙ У ЗБОРІ РСЦ.55.27-1889.00.00А СБ", StorageUnit = "шт" },
new Item { ItemName = "МУФТА ST-040 З ПІДГОТОВЛЕНИМИ ОТВОРАМИ 55H7/45H7 MARKO ST-040", StorageUnit = "шт" },
new Item { ItemName = "БАРАБАН НАТЯЖНИЙ РСЦ.55.73-1910.01.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "КОЛЕСО ХОДОВЕ 53-922СБ", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  36-1028.01", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ 53.4885.001", StorageUnit = "шт" },
new Item { ItemName = "ПІВМУФТА  53.5239.001", StorageUnit = "шт" },
new Item { ItemName = "ЗІРОЧКА ПОВІДНА 53.2043.001-03", StorageUnit = "шт" },
new Item { ItemName = "ДИСК ПРОМІЖНИЙ 1275.01.322", StorageUnit = "шт" },
new Item { ItemName = "ДИСК ПРОМІЖНИЙ 1275.01.322", StorageUnit = "шт" },
new Item { ItemName = "ДИСК ПРОМІЖНИЙ 1275.01.322", StorageUnit = "шт" },
new Item { ItemName = "ДИСК ПРОМІЖНИЙ 1275.01.322", StorageUnit = "шт" },
new Item { ItemName = "ДИСК ПРОМІЖНИЙ 1275.01.322", StorageUnit = "шт" },
new Item { ItemName = "ЦИЛІНДР ГІДРАВЛІЧНИЙ 1255.08.300-8СБ", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ УЩІЛЬНЮВАЛЬНЕ ВНУТРІШНЄ 442.7108-01", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ СТОПОРНЕ ВЕРХНЄ B963S3004A", StorageUnit = "шт" },
new Item { ItemName = "ПРИВІДНИЙ ВАЛ 1242.06.00-5", StorageUnit = "шт" },
new Item { ItemName = "НАСОС RV6-01V 38-81387 (906.0141-00)", StorageUnit = "шт" },
new Item { ItemName = "КОВПАК ТРАВЕРСИ 442.9164-00", StorageUnit = "шт" },
new Item { ItemName = "ШПОНКА Т28*16*110 857.0336-00", StorageUnit = "шт" },
new Item { ItemName = "ШПОНКА Т28*16*110 857.0336-00", StorageUnit = "шт" },
new Item { ItemName = "ПРОКЛАДКА б=1,5 442.7136-03", StorageUnit = "шт" },
new Item { ItemName = "ГОЛОВНИЙ ВАЛ У ЗБОРІ S-4000 EXP452.1699-902", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ (2134-01 D510/404*20) 442.7169-00", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ (2134-01 D510/404*20) 442.7169-00", StorageUnit = "шт" },
new Item { ItemName = "КОНУС ДРОБАРКИ ККД 1500/180", StorageUnit = "шт" },
new Item { ItemName = "ЕКСЦЕНТРИК 442.8733-01", StorageUnit = "шт" },
new Item { ItemName = "КОЖУХ ЗМІЦНЕНИЙ 62-1071.80.00.000СБ (ЗАМОВЛЕННЯ 0301906)", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ НЕРУХОМОГО КОНУСА (Н-6800) 442.8817-02", StorageUnit = "шт" },
new Item { ItemName = "ЕКСЦЕНТРИК 1255.04.100-4СБ", StorageUnit = "шт" },
new Item { ItemName = "442.7577-01 ПРОБКА", StorageUnit = "шт" },
new Item { ItemName = "ЕКСЦЕНТРИК S4000 442.8068-01", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВОДУ 442.9937-01", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВОДУ 442.9937-01", StorageUnit = "шт" },
new Item { ItemName = "КОЖУХ ВАЛУ-ШЕСТІРНІ 442.7506-01", StorageUnit = "шт" },
new Item { ItemName = "ПРИТИСКНЕ КІЛЬЦЕ 442.8801-01", StorageUnit = "шт" },
new Item { ItemName = "СТОПОРНЕ КІЛЬЦЕ 855.0108-00", StorageUnit = "шт" },
new Item { ItemName = "ЦИЛІНДР HYDROSET 442.7163-01", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА БОКОВА ПРАВА  2-55730", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА БОКОВА ЛІВА 2-55729", StorageUnit = "шт" },
new Item { ItemName = "ПІДСТАВКА  ПІД КОНУС ДРОБАРКИ ККД 1500", StorageUnit = "шт" },
new Item { ItemName = "ПОРШЕНЬ 442.9672-00", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ ВЕРХНЄ 1242.04.08", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ 442.7109-01", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ 442.7109-01", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ 442.7109-01", StorageUnit = "шт" },
new Item { ItemName = "САЛЬНИК 950 (1255.08.05)", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВІДНИЙ B963S3002A", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВІДНИЙ B963S3002A", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПРИВІДНИЙ B963S3002A", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА 1255.05.16", StorageUnit = "шт" },
new Item { ItemName = "ВТУЛКА 1255.05.16", StorageUnit = "шт" },
new Item { ItemName = "ПРИВІД ЗІ ШКІВОМ D=1620 1255.07.300-3СБ", StorageUnit = "шт" },
new Item { ItemName = "ПРИВІД ЗІ ШКІВОМ D=695 1255.07.200", StorageUnit = "шт" },
new Item { ItemName = "ШКІВ D=695 1242.07.121", StorageUnit = "шт" },
new Item { ItemName = "ШЕСТЕРНЯ КОНІЧНА m=30, z=26 1255.06.310", StorageUnit = "шт" },
new Item { ItemName = "РЕМКОМПЛЕКТ ЗАРЯДНОГОПОРТУ АЗОТНОЇ КАМЕРИ 94400128", StorageUnit = "шт" },
new Item { ItemName = "ПОРШНЕВЕ КІЛЬЦЕ 1063085321", StorageUnit = "шт" },
new Item { ItemName = "ОЛІЄВІДБИВАЧ 1063587664", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ОПОРНИЙ", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ОПОРНИЙ", StorageUnit = "шт" },
new Item { ItemName = "КАТРИДЖ (ВЕРТИКАЛЬНИЙ ВАЛ У ЗБОРІ) В963S3000A/V", StorageUnit = "шт" },
new Item { ItemName = "КАТРИДЖ (ВЕРТИКАЛЬНИЙ ВАЛ У ЗБОРІ) В963S3000A/V", StorageUnit = "шт" },
new Item { ItemName = "УЩІЛЬНЮВАЛЬНЕ КІЛЬЦЕ 873.0838-00", StorageUnit = "шт" },
new Item { ItemName = "ШЕСТІРНЯ КОНІЧНА Z=21,M=30(кр.1239.02.302-1Б) З.435 КОД 302910", StorageUnit = "шт" },
new Item { ItemName = "ШЕСТІРНЯ КОНІЧНА Z=21,M=30(кр.1239.02.302-1Б) З.435 КОД 302910", StorageUnit = "шт" },
new Item { ItemName = "ФУТЕРІВКА-РЕБРО ВАЛУ(ЗАХИСТ ПРИВОДУ) 442.8760-00", StorageUnit = "шт" },
new Item { ItemName = "ПРИТИСКНЕ КІЛЬЦЕ 442.8425-01", StorageUnit = "шт" },
new Item { ItemName = "КІЛЬЦЕ ФІКСУВАЛЬНЕ 442.7103-01", StorageUnit = "шт" },
new Item { ItemName = "КОРПУС ПІДШИПНИКА 3605-0", StorageUnit = "шт" },
new Item { ItemName = "ШЕСТІРНЯ М10, Z=15 (М608-47/1) (ЗАМОВЛЕННЯ 0400362)", StorageUnit = "шт" },
new Item { ItemName = "КОРПУС (МЕХАНІЗМ ПІДЙОМУ 2 КСН) ГС.62-319.00.00.06", StorageUnit = "шт" },
new Item { ItemName = "КОЛЕСО КОНІЧНЕ ГС62-234.01-Б (ЗАМОВЛЕННЯ 0302249)", StorageUnit = "шт" },
new Item { ItemName = "КОЛЕСО КОНІЧНЕ ГС62-234.01-Б (ЗАМОВЛЕННЯ 0302249)", StorageUnit = "шт" },
new Item { ItemName = "ВІНЕЦЬ ЗУБЧАСТИЙ Z=268, М=20 1-174343-02", StorageUnit = "шт" },
new Item { ItemName = "ВІНЕЦЬ ЗУБЧАСТИЙ Z=268, М=20 1-174343-02", StorageUnit = "шт" },
new Item { ItemName = "ВІНЕЦЬ ЗУБЧАСТИЙ Z=268, М=20 1-174343-02", StorageUnit = "шт" },
new Item { ItemName = "ВІНЕЦЬ ЗУБЧАСТИЙ Z=268, М=20 1-174343-02", StorageUnit = "шт" },
new Item { ItemName = "ВІНЕЦЬ ЗУБЧАСТИЙ Z=268, М=20 1-174343-02", StorageUnit = "шт" },
new Item { ItemName = "ВІНЕЦЬ ЗУБЧАСТИЙ Z=268, М=20 1-174343-02", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПОВІДНИЙ У ЗБОРІ 1-271509-03", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ 69.880.001", StorageUnit = "шт" },
new Item { ItemName = "БУТАРА D=12 (2.3730-05.22ПЧ)", StorageUnit = "шт" },
new Item { ItemName = "ПАТРУБОК РОЗВАНТАЖУВАННЯ 2-145739А", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ-ШЕСТІРНЯ М8, Z=14 (РМ.1000-11-03)", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ-ШЕСТІРНЯ М8, Z=14 (РМ.1000-11-03)", StorageUnit = "шт" },
new Item { ItemName = "НАПІВЦАПФА ОФ-И-522АБ (ЗАМОВЛЕННЯ 0300878)", StorageUnit = "шт" },
new Item { ItemName = "КОРПУС 1-179734 (ЗАМОВЛЕННЯ 0301723усл)", StorageUnit = "шт" },
new Item { ItemName = "ПРОМВАЛ ОФ-И-677СБ (ЗАМОВЛЕННЯ 0301804усл)", StorageUnit = "шт" },
new Item { ItemName = "ПРОМВАЛ ОФ-И-677СБ (ЗАМОВЛЕННЯ 0301804усл)", StorageUnit = "шт" },
new Item { ItemName = "ГОРЛОВИНА ВОРОНКИ 2.66397 (ЗАМОВЛЕННЯ 0300190)", StorageUnit = "шт" },
new Item { ItemName = "ГОРЛОВИНА ВОРОНКИ 2.66397 (ЗАМОВЛЕННЯ 0300190)", StorageUnit = "шт" },
new Item { ItemName = "ГОРЛОВИНА ВОРОНКИ 2.66397 (ЗАМОВЛЕННЯ 0300190)", StorageUnit = "шт" },
new Item { ItemName = "ВОРОНКА РОЗВАНТАЖУВАЛЬНА 62-11297.00.00.00СБ", StorageUnit = "шт" },
new Item { ItemName = "КРИШКА РОЗВАНТАЖУВАЛЬНА 1374.04.101СБ", StorageUnit = "шт" },
new Item { ItemName = "ВАЛ ПОВІДНИЙ У ЗБОРІ 1-230027-11", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА ОПОРНА 8-66720", StorageUnit = "шт" },
new Item { ItemName = "ПРИВІД МЛИНА 1-180981СБ", StorageUnit = "шт" },
new Item { ItemName = "ШПОНКА 80*45*820 (66.4742.001) ЗАМОВЛЕННЯ 0404691", StorageUnit = "шт" },
new Item { ItemName = "КОРПУС БАРАБАНА 1-224437", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА ОПОРНА 1-182102", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА ОПОРНА 1-182102", StorageUnit = "шт" },
new Item { ItemName = "НАПІВЦАПФА ГС.62-527.00.01", StorageUnit = "шт" },
new Item { ItemName = "РОЛИКООПОРА СМ6001.02.00.000СБ", StorageUnit = "шт" },
new Item { ItemName = "ПАТРУБОК РОЗВАНТАЖУВАЛЬНИЙ МСЦ 3,6*5,5 ГС.62-785.00.00 СБ", StorageUnit = "шт" },
new Item { ItemName = "ЕЛЕВАТОР МШР 4,43*5,01 ГС.62-220.00.01-В", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА ФУНДАМЕНТНА 1-156915", StorageUnit = "шт" },
new Item { ItemName = "СКОБА КОНТРОЛЮ ДІАМЕТРІВ 1350 ГС.62-938.01.00.СБ", StorageUnit = "шт" },
new Item { ItemName = "КРИШКА ПІДШИПНИКА 3Б.1537-3І1", StorageUnit = "шт" },
new Item { ItemName = "БУТАРА ДО СТРИЖНЕВОГО МЛИНА ГС.62-1094.00.00-А СБ", StorageUnit = "шт" },
new Item { ItemName = "БУТАРА ДО СТРИЖНЕВОГО МЛИНА ГС.62-1094.00.00-А СБ", StorageUnit = "шт" },
new Item { ItemName = "НАПІВБУТАРА D=14 ГС.62-736.00.00.СБ", StorageUnit = "шт" },
new Item { ItemName = "СТІНКА ЗАВАНТАЖУВАЛЬНА МШР 4,0*5,0 1-224142-01", StorageUnit = "шт" },
new Item { ItemName = "ВОРОНКА РОЗВАНТАЖУВАЛЬНА ПРАВА 1374.04.102", StorageUnit = "шт" },
new Item { ItemName = "ПАТРУБОК ЗАВАНТАЖУВАЛЬНИЙ ОФ2-МШ-5К", StorageUnit = "шт" },
new Item { ItemName = "ПЛИТА ФУНДАМЕНТНА ПРИВІДНОГО ВАЛУ МСЦ 3600*5500 (8-4038)", StorageUnit = "шт" },
new Item { ItemName = "СТІНКА ТОРЦЕВА 1-145079СБ", StorageUnit = "шт" },

                };

                db.Items.AddRange(items);
                await db.SaveChangesAsync();
                Console.WriteLine($"Seeded {items.Count} items into DB from the test list.");
            }
            else
            {
                Console.WriteLine("Items already exist in DB. Skipping seeding items.");
            }
        }
    }
}


--- File: launchSettings.json (Path: .\AutomationOfPurchases.API\Properties\launchSettings.json) ---

﻿{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:18804",
      "sslPort": 0
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5156",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}


--- File: GenericRepository.cs (Path: .\AutomationOfPurchases.API\Repositories\GenericRepository.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using Microsoft.EntityFrameworkCore;
using System.Linq.Expressions;

namespace AutomationOfPurchases.API.Repositories
{
    public class GenericRepository<T> : IGenericRepository<T> where T : class
    {
        protected readonly AppDbContext _context;
        protected readonly DbSet<T> _dbSet;

        public GenericRepository(AppDbContext context)
        {
            _context = context;
            _dbSet = context.Set<T>();
        }

        public virtual async Task<T?> GetByIdAsync(int id)
        {
            return await _dbSet.FindAsync(id);
        }

        public virtual async Task<IEnumerable<T>> GetAllAsync()
        {
            return await _dbSet.ToListAsync();
        }

        public virtual async Task<IEnumerable<T>> FindAsync(Expression<Func<T, bool>> predicate)
        {
            return await _dbSet.Where(predicate).ToListAsync();
        }

        public virtual async Task AddAsync(T entity)
        {
            await _dbSet.AddAsync(entity);
            // Збереження будемо робити у UnitOfWork (або робіть тут, якщо потрібно)
        }

        public virtual async Task AddRangeAsync(IEnumerable<T> entities)
        {
            await _dbSet.AddRangeAsync(entities);
        }

        public virtual async Task UpdateAsync(T entity)
        {
            // EF Core відслідковує зміни, якщо entity знаходиться у tracked state
            // _dbSet.Update(entity); // за необхідності
            await Task.CompletedTask;
        }

        public virtual async Task DeleteAsync(T entity)
        {
            _dbSet.Remove(entity);
            await Task.CompletedTask;
        }
    }
}


--- File: IGenericRepository.cs (Path: .\AutomationOfPurchases.API\Repositories\IGenericRepository.cs) ---

﻿using System.Linq.Expressions;

namespace AutomationOfPurchases.API.Repositories
{
    public interface IGenericRepository<T> where T : class
    {
        Task<T?> GetByIdAsync(int id);
        Task<IEnumerable<T>> GetAllAsync();
        Task<IEnumerable<T>> FindAsync(Expression<Func<T, bool>> predicate);

        Task AddAsync(T entity);
        Task AddRangeAsync(IEnumerable<T> entities);

        Task UpdateAsync(T entity);
        Task DeleteAsync(T entity);
    }
}


--- File: IRepositoryFactory.cs (Path: .\AutomationOfPurchases.API\Repositories\IRepositoryFactory.cs) ---

﻿namespace AutomationOfPurchases.API.Repositories
{
    public interface IRepositoryFactory
    {
        IGenericRepository<TEntity> CreateRepository<TEntity>() where TEntity : class;
    }
}


--- File: IUnitOfWork.cs (Path: .\AutomationOfPurchases.API\Repositories\IUnitOfWork.cs) ---

﻿using System;

namespace AutomationOfPurchases.API.Repositories
{
    public interface IUnitOfWork : IDisposable
    {
        // Приклад репозиторіїв для конкретних сутностей
        IGenericRepository<AutomationOfPurchases.Shared.Models.AppUser> Users { get; }
        IGenericRepository<AutomationOfPurchases.Shared.Models.Department> Departments { get; }
        IGenericRepository<AutomationOfPurchases.Shared.Models.Request> Requests { get; }
        // за потреби додати й інші, наприклад:
        // IGenericRepository<Item> Items { get; }
        // IGenericRepository<RequestItem> RequestItems { get; }

        // Універсальне створення репозиторіїв через Factory, якщо потрібно:
        IGenericRepository<TEntity> Repository<TEntity>() where TEntity : class;

        // Основний метод збереження
        Task<int> SaveChangesAsync();
    }
}


--- File: RepositoryFactory.cs (Path: .\AutomationOfPurchases.API\Repositories\RepositoryFactory.cs) ---

﻿using AutomationOfPurchases.Shared.Models;

namespace AutomationOfPurchases.API.Repositories
{
    public class RepositoryFactory : IRepositoryFactory
    {
        private readonly AppDbContext _context;

        public RepositoryFactory(AppDbContext context)
        {
            _context = context;
        }

        public IGenericRepository<TEntity> CreateRepository<TEntity>() where TEntity : class
        {
            return new GenericRepository<TEntity>(_context);
        }
    }
}


--- File: UnitOfWork.cs (Path: .\AutomationOfPurchases.API\Repositories\UnitOfWork.cs) ---

﻿using AutomationOfPurchases.Shared.Models;

namespace AutomationOfPurchases.API.Repositories
{
    public class UnitOfWork : IUnitOfWork
    {
        private readonly AppDbContext _context;
        private readonly IRepositoryFactory _repositoryFactory;

        // "кешовані" репозиторії
        private IGenericRepository<AppUser>? _users;
        private IGenericRepository<Department>? _departments;
        private IGenericRepository<Request>? _requests;
        // Додаткові поля для інших сутностей:
        // private IGenericRepository<Item>? _items;

        public UnitOfWork(AppDbContext context, IRepositoryFactory repositoryFactory)
        {
            _context = context;
            _repositoryFactory = repositoryFactory;
        }

        public IGenericRepository<AppUser> Users
            => _users ??= _repositoryFactory.CreateRepository<AppUser>();

        public IGenericRepository<Department> Departments
            => _departments ??= _repositoryFactory.CreateRepository<Department>();

        public IGenericRepository<Request> Requests
            => _requests ??= _repositoryFactory.CreateRepository<Request>();

        // Якщо потрібен доступ до інших сутностей:
        // public IGenericRepository<Item> Items => _items ??= _repositoryFactory.CreateRepository<Item>();

        public IGenericRepository<TEntity> Repository<TEntity>() where TEntity : class
        {
            return _repositoryFactory.CreateRepository<TEntity>();
        }

        public async Task<int> SaveChangesAsync()
        {
            return await _context.SaveChangesAsync();
        }

        public void Dispose()
        {
            _context.Dispose();
        }
    }
}


--- File: DepartmentHeadService.cs (Path: .\AutomationOfPurchases.API\Services\DepartmentHeadService.cs) ---

﻿using AutomationOfPurchases.API.Repositories;
using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using AutoMapper;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Services
{
    public class DepartmentHeadService : IDepartmentHeadService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IMapper _mapper;
        private readonly AppDbContext _context;

        public DepartmentHeadService(IUnitOfWork unitOfWork, IMapper mapper, AppDbContext context)
        {
            _unitOfWork = unitOfWork;
            _mapper = mapper;
            _context = context;
        }

        /// <summary>
        /// Повертає всі заявки, які створили користувачі департаменту поточного керівника (крім статусу “Draft”).
        /// </summary>
        public async Task<List<RequestDTO>> GetRequestsInMyDepartmentAsync(string departmentHeadUserId)
        {
            // Знаходимо користувача-керівника
            var headUser = (await _unitOfWork.Users.FindAsync(u => u.Id == departmentHeadUserId)).FirstOrDefault();
            if (headUser == null) return new List<RequestDTO>();

            // Знаходимо департамент, де headOfDepartmentId == headUser.Id
            var dept = (await _unitOfWork.Departments.FindAsync(d => d.HeadOfDepartmentId == headUser.Id)).FirstOrDefault();
            if (dept == null) return new List<RequestDTO>();

            // Усі користувачі цього департаменту
            var usersInDept = await _unitOfWork.Users.FindAsync(u => u.DepartmentId == dept.DepartmentId);
            var usersInDeptIds = usersInDept.Select(u => u.Id).ToList();

            // Заявки від тих користувачів, виключаємо Draft
            var allRequests = await _unitOfWork.Requests.FindAsync(r =>
                r.OrderedById != null &&
                usersInDeptIds.Contains(r.OrderedById) &&
                r.Status != "Draft");

            // Мапимо Request -> RequestDTO
            return allRequests
                .Select(r => _mapper.Map<RequestDTO>(r))
                .ToList();
        }

        /// <summary>
        /// Затвердження заявки керівником відділу (статус → PendingEconomist) + повідомлення автору й економістам.
        /// </summary>
        public async Task<bool> ApproveRequestAsync(int requestId, string departmentHeadUserId)
        {
            // 1) Шукаємо заявку
            var request = await _unitOfWork.Requests.GetByIdAsync(requestId);
            if (request == null) return false;

            // 2) Перевіряємо, чи ця заявка належить моєму відділу
            if (!await IsRequestInMyDepartment(request, departmentHeadUserId)) return false;

            // 3) Змінюємо статус і зберігаємо
            request.Status = "PendingEconomist";
            request.ApprovedByDepartmentHead = true;
            request.DepartmentHeadApproverId = departmentHeadUserId;
            request.RejectedByUserId = null;
            request.RejectionReason = null;

            await _unitOfWork.Requests.UpdateAsync(request);
            await _unitOfWork.SaveChangesAsync();

            // ---- 4) Створюємо повідомлення автору заявки, що її затвердив керівник ---
            if (!string.IsNullOrEmpty(request.OrderedById))
            {
                var notifToAuthor = new Notification
                {
                    RecipientId = request.OrderedById,
                    Title = "Керівник затвердив вашу заявку",
                    Message = $"Ваша заявка \"{request.Title}\" була затверджена керівником.",
                    LinkUrl = $"/request-details/{requestId}",
                    Category = "Approved",
                    RequestId = requestId// для позначення блідо-зеленим фоном, наприклад
                };
                _context.Notifications.Add(notifToAuthor);
            }

            // ---- 5) Повідомлення всім економістам того відділу, що приймають далі заявку ---
            // Знаходимо відділ автора заявки (OrderedById)
            if (!string.IsNullOrEmpty(request.OrderedById))
            {
                var author = await _context.Users
                    .Include(u => u.Department)
                    .FirstOrDefaultAsync(u => u.Id == request.OrderedById);

                var deptId = author?.DepartmentId;
                if (deptId.HasValue)
                {
                    // Шукаємо всіх економістів у цьому відділі (DepartmentEconomist)
                    var economistIds = await _context.DepartmentEconomists
                        .Where(de => de.DepartmentId == deptId.Value)
                        .Select(de => de.EconomistId)
                        .ToListAsync();

                    // Для кожного економіста - повідомлення
                    foreach (var econId in economistIds)
                    {
                        var notifToEcon = new Notification
                        {
                            RecipientId = econId,
                            Title = "Нова заявка для затвердження",
                            Message = $"У вашому відділі з’явилась заявка \"{request.Title}\", що потребує вашого затвердження.",
                            LinkUrl = $"/request-details/{requestId}",
                            Category = "Important", // “важливе” повідомлення
                             RequestId = requestId
                        };
                        _context.Notifications.Add(notifToEcon);
                    }
                }
            }

            // Зберігаємо всі створені повідомлення разом
            await _context.SaveChangesAsync();

            return true;
        }

        /// <summary>
        /// Відхилення заявки керівником відділу (статус → Rejected) + повідомлення автору.
        /// </summary>
        public async Task<bool> RejectRequestAsync(int requestId, string departmentHeadUserId, string reason)
        {
            // 1) Шукаємо заявку
            var request = await _unitOfWork.Requests.GetByIdAsync(requestId);
            if (request == null) return false;

            // 2) Перевірка, чи ця заявка з мого відділу
            if (!await IsRequestInMyDepartment(request, departmentHeadUserId)) return false;

            // 3) Статус → "Rejected"
            request.Status = "Rejected";
            request.ApprovedByDepartmentHead = false;
            request.RejectedByUserId = departmentHeadUserId;
            request.RejectionReason = reason;

            await _unitOfWork.Requests.UpdateAsync(request);
            await _unitOfWork.SaveChangesAsync();

            // 4) Повідомлення автору
            if (!string.IsNullOrEmpty(request.OrderedById))
            {
                var notif = new Notification
                {
                    RecipientId = request.OrderedById,
                    Title = "Керівник відхилив вашу заявку",
                    Message = $"Ваша заявка \"{request.Title}\" була відхилена керівником. Причина: {reason}",
                    LinkUrl = $"/request-details/{requestId}",
                    Category = "Rejected",
                     RequestId = requestId
                };
                _context.Notifications.Add(notif);
                await _context.SaveChangesAsync();
            }

            return true;
        }

        /// <summary>
        /// Перевіряє, чи заявка належить відділу, де departmentHeadUserId – керівник.
        /// </summary>
        private async Task<bool> IsRequestInMyDepartment(Request request, string departmentHeadUserId)
        {
            if (request.OrderedById == null) return false;

            // Знаходимо автора заявки
            var author = (await _unitOfWork.Users.FindAsync(u => u.Id == request.OrderedById)).FirstOrDefault();
            if (author == null) return false;

            var deptId = author.DepartmentId;
            if (deptId == null) return false;

            // Перевіряємо, чи цей dept має headOfDepartmentId = departmentHeadUserId
            var dept = await _unitOfWork.Departments
                .FindAsync(d => d.DepartmentId == deptId && d.HeadOfDepartmentId == departmentHeadUserId);

            // Якщо знайдено хоч один — отже, заявка належить поточному керівнику
            return dept.Any();
        }

        /// <summary>
        /// Опційний метод: список економістів департаменту
        /// </summary>
        public async Task<List<string>> GetEconomistsOfDepartment(AppDbContext context, int departmentId)
        {
            var econIds = await context.DepartmentEconomists
                .Where(de => de.DepartmentId == departmentId)
                .Select(de => de.EconomistId)
                .ToListAsync();
            return econIds;
        }
    }
}


--- File: EconomistService.cs (Path: .\AutomationOfPurchases.API\Services\EconomistService.cs) ---

﻿using AutomationOfPurchases.API.Repositories;
using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Models;
using AutoMapper;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Services
{
    /// <summary>
    /// Сервіс, що містить логіку для економіста:
    ///  - перегляд заявок свого відділу,
    ///  - затвердження/відхилення,
    ///  - додавання копій позицій заявки у GeneralNeedsList.
    /// </summary>
    public class EconomistService : IEconomistService
    {
        private readonly IUnitOfWork _unitOfWork;
        private readonly IMapper _mapper;
        private readonly AppDbContext _context;

        public EconomistService(IUnitOfWork unitOfWork, IMapper mapper, AppDbContext context)
        {
            _unitOfWork = unitOfWork;
            _mapper = mapper;
            _context = context;
        }

        /// <summary>
        /// Повертає всі заявки (крім чернеток) користувачів, чиї департаменти
        /// входять до списку департаментів, закріплених за economistUserId.
        /// </summary>
        public async Task<List<RequestDTO>> GetRequestsInMyDepartmentAsync(string economistUserId)
        {
            // 1) Які департаменти прив’язані до цього економіста
            var deptEconomistLinks = await _unitOfWork.Repository<DepartmentEconomist>()
                .FindAsync(de => de.EconomistId == economistUserId);
            var allowedDeptIds = deptEconomistLinks.Select(de => de.DepartmentId).ToList();

            if (!allowedDeptIds.Any())
                return new List<RequestDTO>();

            // 2) Завантажуємо всі заявки (окрім Draft)
            var allRequests = await _context.Requests
                .Include(r => r.OrderedBy).ThenInclude(u => u.Department)
                .Where(r => r.OrderedById != null && r.Status != "Draft")
                .ToListAsync();

            // 3) Фільтруємо: лишаємо ті, де відділ автора входить до allowedDeptIds
            var filtered = allRequests.Where(r =>
            {
                var deptId = r.OrderedBy?.DepartmentId;
                return deptId != null && allowedDeptIds.Contains(deptId.Value);
            }).ToList();

            // 4) Мапимо в DTO
            return filtered.Select(r => _mapper.Map<RequestDTO>(r)).ToList();
        }

        /// <summary>
        /// Затверджує заявку економістом:
        /// 1) Перевіряє, чи цей economistUserId справді закріплений за відділом заявки.
        /// 2) Ставить статус "Approved", виставляє ApprovedByEconomist = true.
        /// 3) Додає копії позицій у активний GeneralNeedsList (GeneralNeedsItem).
        /// 4) Створює повідомлення автору.
        /// </summary>
        public async Task<bool> ApproveRequestAsync(int requestId, string economistUserId)
        {
            // 1) Знаходимо заявку
            var request = await _unitOfWork.Requests.GetByIdAsync(requestId);
            if (request == null)
                return false;

            // 2) Перевіряємо, чи має economistUserId доступ до цього відділу
            if (!await IsRequestInMyDepartments(request, economistUserId))
                return false; // доступ заборонено

            // 3) Оновлюємо статус
            request.Status = "Approved";
            request.ApprovedByEconomist = true;
            request.EconomistApproverId = economistUserId;
            request.RejectedByUserId = null;
            request.RejectionReason = null;

            // 4) Копіюємо позиції заявки в активний GeneralNeedsList
            await AddItemsToGeneralNeedsListAsync(request.RequestId);

            // 5) Зберігаємо
            await _unitOfWork.Requests.UpdateAsync(request);
            await _unitOfWork.SaveChangesAsync();

            // 6) Надсилаємо повідомлення автору заявки
            if (!string.IsNullOrEmpty(request.OrderedById))
            {
                var notif = new Notification
                {
                    RecipientId = request.OrderedById,
                    Title = "Економіст затвердив вашу заявку",
                    Message = $"Ваша заявка \"{request.Title}\" успішно затверджена економістом.",
                    LinkUrl = $"/request-details/{request.RequestId}",
                    Category = "Approved",
                    RequestId = request.RequestId
                };
                _context.Notifications.Add(notif);
                await _context.SaveChangesAsync();
            }

            return true;
        }

        /// <summary>
        /// Відхиляє заявку економістом: ставить статус "Rejected",
        /// створює повідомлення автору (і керівнику, якщо треба).
        /// </summary>
        public async Task<bool> RejectRequestAsync(int requestId, string economistUserId, string reason)
        {
            // 1) Шукаємо заявку
            var request = await _unitOfWork.Requests.GetByIdAsync(requestId);
            if (request == null)
                return false;

            // 2) Перевіряємо доступ
            if (!await IsRequestInMyDepartments(request, economistUserId))
                return false;

            // 3) Ставимо статус "Rejected"
            request.Status = "Rejected";
            request.ApprovedByEconomist = false;
            request.RejectedByUserId = economistUserId;
            request.RejectionReason = reason;

            await _unitOfWork.Requests.UpdateAsync(request);
            await _unitOfWork.SaveChangesAsync();

            // 4) Повідомлення автору
            if (!string.IsNullOrEmpty(request.OrderedById))
            {
                var notifAuthor = new Notification
                {
                    RecipientId = request.OrderedById,
                    Title = "Економіст відхилив вашу заявку",
                    Message = $"Заявку \"{request.Title}\" було відхилено економістом. Причина: {reason}",
                    LinkUrl = $"/request-details/{request.RequestId}",
                    Category = "Rejected",
                    RequestId = request.RequestId
                };
                _context.Notifications.Add(notifAuthor);
                await _context.SaveChangesAsync();
            }

            // 5) Якщо вона була схвалена керівником, можна повідомити керівника, 
            // але це опційно (подивіться ваші вимоги)

            return true;
        }

        // ==========================================================================
        // Допоміжні методи
        // ==========================================================================

        /// <summary>
        /// Копіює всі позиції (RequestItem) із заявки (requestId) 
        /// в активний GeneralNeedsList у вигляді (GeneralNeedsItem).
        /// </summary>
        private async Task AddItemsToGeneralNeedsListAsync(int requestId)
        {
            // 1) Знайти активний GeneralNeedsList
            var activeList = await _context.GeneralNeedsLists
                .Where(l => l.NullificationDate == null)
                .FirstOrDefaultAsync();
            if (activeList == null)
            {
                // Якщо немає активного списку - створюємо
                activeList = new GeneralNeedsList
                {
                    CreationDate = DateTime.UtcNow
                };
                _context.GeneralNeedsLists.Add(activeList);
                await _context.SaveChangesAsync();
            }

            // 2) Знаходимо всі RequestItem оригіналу
            var requestItems = await _context.RequestItems
                .Where(ri => ri.RequestId == requestId)
                .ToListAsync();

            // 3) Створюємо GeneralNeedsItem для кожного
            foreach (var item in requestItems)
            {
                var gni = new GeneralNeedsItem
                {
                    GeneralNeedsListId = activeList.ListId,
                    ItemId = item.ItemId,
                    Quantity = item.Quantity,
                    OrderedById = item.OrderedById,
                    OriginalRequestItemId = item.RequestItemId
                };
                // Додаємо запис у таблицю GeneralNeedsItems
                _context.GeneralNeedsItems.Add(gni);
            }

            await _context.SaveChangesAsync();

            // 4) Повідомляємо всіх WarehouseWorker 
            var whRole = await _context.Roles.FirstOrDefaultAsync(r => r.Name == "WarehouseWorker");
            if (whRole != null)
            {
                var whUserIds = await _context.UserRoles
                    .Where(ur => ur.RoleId == whRole.Id)
                    .Select(ur => ur.UserId)
                    .ToListAsync();

                if (whUserIds.Any())
                {
                    foreach (var whId in whUserIds)
                    {
                        var notif = new Notification
                        {
                            RecipientId = whId,
                            Title = "Нова заявка у загальних потребах",
                            Message = $"Для заявки #{requestId} додано позиції в GeneralNeedsList.",
                            LinkUrl = "/warehouse-grouped",
                            Category = "Important",
                            RequestId = requestId
                        };
                        _context.Notifications.Add(notif);
                    }
                    await _context.SaveChangesAsync();
                }
            }
        }

        /// <summary>
        /// Перевіряє, чи Request (request.OrderedBy.DepartmentId) входить до переліку відділів, 
        /// де economistUserId є економістом (DepartmentEconomist).
        /// </summary>
        private async Task<bool> IsRequestInMyDepartments(Request request, string economistUserId)
        {
            if (request.OrderedById == null)
                return false;

            var author = await _context.Users
                .Include(u => u.Department)
                .FirstOrDefaultAsync(u => u.Id == request.OrderedById);
            if (author == null || author.DepartmentId == null)
                return false;

            var deptId = author.DepartmentId.Value;

            // Перевіряємо, чи цей deptId є серед DepartmentEconomist
            var isEconOfDept = await _context.DepartmentEconomists
                .AnyAsync(de => de.DepartmentId == deptId && de.EconomistId == economistUserId);

            return isEconOfDept;
        }

        public async Task<bool> IsEconomistOfDepartmentAsync(int departmentId, string economistUserId)
        {
            return await _context.DepartmentEconomists
                .AnyAsync(de => de.DepartmentId == departmentId && de.EconomistId == economistUserId);
        }
    }
}


--- File: IDepartmentHeadService.cs (Path: .\AutomationOfPurchases.API\Services\IDepartmentHeadService.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;

namespace AutomationOfPurchases.API.Services
{
    public interface IDepartmentHeadService
    {
        Task<List<RequestDTO>> GetRequestsInMyDepartmentAsync(string departmentHeadUserId);
        Task<bool> ApproveRequestAsync(int requestId, string departmentHeadUserId);
        Task<bool> RejectRequestAsync(int requestId, string departmentHeadUserId, string reason);
        Task<List<string>> GetEconomistsOfDepartment(AppDbContext context, int departmentId);
    }
}


--- File: IEconomistService.cs (Path: .\AutomationOfPurchases.API\Services\IEconomistService.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;

namespace AutomationOfPurchases.API.Services
{
    public interface IEconomistService
    {
        /// <summary>
        /// Повертає всі заявки користувачів відділів, з якими пов’язаний економіст
        /// (крім статусу Draft, якщо потрібно).
        /// </summary>
        Task<List<RequestDTO>> GetRequestsInMyDepartmentAsync(string economistUserId);

        /// <summary>
        /// Затвердження заявки економістом.
        /// </summary>
        Task<bool> ApproveRequestAsync(int requestId, string economistUserId);

        /// <summary>
        /// Відхилення заявки економістом із причиною.
        /// </summary>
        Task<bool> RejectRequestAsync(int requestId, string economistUserId, string reason);

        /// <summary>
        /// Перевіряє, чи закріплений користувач з economistUserId як економіст
        /// за департаментом із ідентифікатором departmentId.
        /// </summary>
        Task<bool> IsEconomistOfDepartmentAsync(int departmentId, string economistUserId);





    }
}


--- File: IRequestService.cs (Path: .\AutomationOfPurchases.API\Services\IRequestService.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;

namespace AutomationOfPurchases.API.Services
{
    public interface IRequestService
    {
        Task<RequestDTO> CreateRequestAsync(RequestDTO requestDto, string orderedByUserId);
        Task<List<RequestDTO>> GetRequestsByUserAsync(string userId);

        // Для перегляду заявки
        Task<RequestDTO?> GetRequestByIdAsync(int requestId, string currentUserId);
        Task<RequestDTO?> GetRequestByIdForUserAsync(int requestId, string userId);

        // Додавали раніше для видалення чернетки
        Task<bool> DeleteDraftAsync(int requestId, string userId);

        // ==================== ДОДАТИ НОВИЙ МЕТОД ====================
        // Для оновлення (PUT) існуючої заявки (включно з чернеткою).
        Task<RequestDTO?> UpdateRequestAsync(int requestId, RequestDTO requestDto, string userId);
    }
}


--- File: RequestService.cs (Path: .\AutomationOfPurchases.API\Services\RequestService.cs) ---

﻿using AutomationOfPurchases.API.Repositories;
using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Enums;
using AutomationOfPurchases.Shared.Models;
using AutoMapper;
using Microsoft.EntityFrameworkCore;

namespace AutomationOfPurchases.API.Services
{
    /// <summary>
    /// Сервіс для CRUD-операцій із заявками від імені “автора”:
    /// Створити, змінити, отримати список, видалити чернетку тощо.
    /// </summary>
    public class RequestService : IRequestService
    {
        private readonly AppDbContext _context;
        private readonly IMapper _mapper;
        private readonly IUnitOfWork _unitOfWork;

        public RequestService(AppDbContext context, IMapper mapper, IUnitOfWork unitOfWork)
        {
            _context = context;
            _mapper = mapper;
            _unitOfWork = unitOfWork;
        }

        /// <summary>
        /// Створює нову заявку. За замовчуванням статус “PendingDepartmentHead” (якщо не вказано інакше).
        /// Надсилає повідомлення керівнику відділу автора, якщо він не співпадає з автором.
        /// </summary>
        public async Task<RequestDTO> CreateRequestAsync(RequestDTO requestDto, string orderedByUserId)
        {
            // 1) Мапимо з DTO у сутність Request
            var requestEntity = _mapper.Map<Request>(requestDto);

            // 2) Встановлюємо поля
            requestEntity.OrderedById = orderedByUserId;
            requestEntity.CreationDate = DateTime.UtcNow;

            // Якщо не задано статус
            if (string.IsNullOrWhiteSpace(requestEntity.Status))
            {
                requestEntity.Status = "PendingDepartmentHead";
            }

            // 3) Заповнюємо у RequestItem поле OrderedById
            if (requestEntity.Items != null)
            {
                foreach (var ri in requestEntity.Items)
                {
                    ri.OrderedById = orderedByUserId;
                }
            }

            // 4) Зберігаємо заявку
            _context.Requests.Add(requestEntity);
            await _context.SaveChangesAsync();

            // 5) Надсилаємо повідомлення керівнику (якщо він існує і не збігається з автором)
            var author = await _context.Users
                .Include(u => u.Department)
                .FirstOrDefaultAsync(u => u.Id == orderedByUserId);

            var departmentHeadId = author?.Department?.HeadOfDepartmentId;
            if (!string.IsNullOrEmpty(departmentHeadId) && departmentHeadId != orderedByUserId)
            {
                var notification = new Notification
                {
                    RecipientId = departmentHeadId,
                    Title = "Підлеглий створив нову заявку",
                    Message = $"Користувач \"{author?.FullName}\" створив нову заявку \"{requestEntity.Title}\".",
                    LinkUrl = $"/request-details/{requestEntity.RequestId}",
                    Category = "Important",
                    RequestId = requestEntity.RequestId
                };
                _context.Notifications.Add(notification);
                await _context.SaveChangesAsync();
            }

            // 6) Повертаємо DTO створеної заявки
            return _mapper.Map<RequestDTO>(requestEntity);
        }

        /// <summary>
        /// Оновлює існуючу заявку, яку створив currentUser (тільки якщо вона ще в статусі Draft чи PendingDepartmentHead?).
        /// </summary>
        public async Task<RequestDTO?> UpdateRequestAsync(int requestId, RequestDTO requestDto, string userId)
        {
            // 1) Шукаємо заявку, що належить userId (якщо потрібна така логіка)
            var requestEntity = await _context.Requests
                .Include(r => r.Items)
                .FirstOrDefaultAsync(r => r.RequestId == requestId && r.OrderedById == userId);

            if (requestEntity == null)
                return null; // Не знайдено, або не належить поточному користувачеві

            // 2) Оновлюємо основні поля заявки (назва, опис, статус)
            requestEntity.Title = requestDto.Title;
            requestEntity.Description = requestDto.Description;
            requestEntity.Status = requestDto.Status.ToString();

            // 3) Очищаємо старі Items і додаємо нові (якщо треба)
            requestEntity.Items.Clear();
            if (requestDto.Items != null)
            {
                foreach (var itemDto in requestDto.Items)
                {
                    var newItem = new RequestItem
                    {
                        ItemId = itemDto.ItemId,
                        Quantity = itemDto.Quantity,
                        Satisfied = itemDto.Satisfied,
                        OrderedById = userId
                    };
                    requestEntity.Items.Add(newItem);
                }
            }

            // 4) Зберігаємо
            await _context.SaveChangesAsync();
            return _mapper.Map<RequestDTO>(requestEntity);
        }

        /// <summary>
        /// Повертає список заявок, створених певним користувачем (userId).
        /// </summary>
        public async Task<List<RequestDTO>> GetRequestsByUserAsync(string userId)
        {
            var requestEntities = await _context.Requests
                .Where(r => r.OrderedById == userId)
                .ToListAsync();

            return requestEntities
                .Select(r => _mapper.Map<RequestDTO>(r))
                .ToList();
        }

        /// <summary>
        /// Повертає заявку з деталями за Id (для керівника/економіста).
        /// Якщо потрібні поля DeliveredQuantity/ToPurchaseQuantity, вони беруться із RequestItem.
        /// </summary>
        public async Task<RequestDTO?> GetRequestByIdAsync(int id)
        {
            var entity = await _context.Requests
                .Include(r => r.OrderedBy).ThenInclude(u => u.Department)
                .Include(r => r.Items).ThenInclude(ri => ri.Item)
                .Include(r => r.EconomistApprover)
                .Include(r => r.DepartmentHeadApprover)
                .Include(r => r.RejectedByUser)
                .FirstOrDefaultAsync(r => r.RequestId == id);

            if (entity == null) return null;

            return _mapper.Map<RequestDTO>(entity);
        }

        /// <summary>
        /// Повертає заявку лише якщо вона належить userId (для автора).
        /// </summary>
        public async Task<RequestDTO?> GetRequestByIdForUserAsync(int requestId, string userId)
        {
            var entity = await _context.Requests
                .Include(r => r.OrderedBy).ThenInclude(u => u.Department)
                .Include(r => r.Items).ThenInclude(ri => ri.Item)
                .Include(r => r.EconomistApprover)
                .Include(r => r.DepartmentHeadApprover)
                .Include(r => r.RejectedByUser)
                .FirstOrDefaultAsync(r => r.RequestId == requestId && r.OrderedById == userId);

            if (entity == null) return null;

            return _mapper.Map<RequestDTO>(entity);
        }

        /// <summary>
        /// Видаляє чернетку (Draft) заявки, якщо вона належить userId.
        /// </summary>
        public async Task<bool> DeleteDraftAsync(int requestId, string userId)
        {
            var requestEntity = await _context.Requests
                .Include(r => r.Items)
                .FirstOrDefaultAsync(r =>
                    r.RequestId == requestId &&
                    r.OrderedById == userId &&
                    r.Status == "Draft");

            if (requestEntity == null)
                return false; 

            _context.RequestItems.RemoveRange(requestEntity.Items);
            _context.Requests.Remove(requestEntity);
            await _context.SaveChangesAsync();
            return true;
        }

        /// <summary>
        /// Повертає заявку з її деталями за Id (для керівника/економіста).
        /// Заповнює DeliveredQuantity і ToPurchaseQuantity для кожного RequestItemDTO.
        /// </summary>
        public async Task<RequestDTO?> GetRequestByIdAsync(int requestId, string currentUserId)
        {
            var entity = await _context.Requests
                .Include(r => r.OrderedBy).ThenInclude(u => u.Department)
                .Include(r => r.Items).ThenInclude(ri => ri.Item)
                // Додатково, якщо треба, .Include(r => r.Items).ThenInclude(ri => ri.DeliveryRequests)
                .Include(r => r.EconomistApprover)
                .Include(r => r.DepartmentHeadApprover)
                .Include(r => r.RejectedByUser)
                .FirstOrDefaultAsync(r => r.RequestId == requestId);

            if (entity == null) return null;

            var dto = _mapper.Map<RequestDTO>(entity);
            var user = await _context.Users.FindAsync(currentUserId);
            if (user != null)
            {
                // Можна перевірити, чи має цей user роль "Economist" 
                // (наприклад, дивимося в таблицю UserRoles)
                // 1) Спочатку дістаємо ідентифікатор ролі економіста
                string? econRoleId = await GetRoleIdByName("Economist");

                // 2) А тоді використовуємо вже готове econRoleId
                bool isEconomist = await _context.UserRoles
                    .AnyAsync(ur => ur.UserId == currentUserId && ur.RoleId == econRoleId);

                if (isEconomist && entity.OrderedBy?.DepartmentId != null)
                {
                    var deptId = entity.OrderedBy.DepartmentId.Value;
                    // 2) Перевіряємо, чи є currentUserId у DepartmentEconomists 
                    //    для deptId:
                    bool isEconOfDept = await _context.DepartmentEconomists
                        .AnyAsync(de => de.DepartmentId == deptId &&
                                        de.EconomistId == currentUserId);

                    dto.CanApproveAsEconomist = isEconOfDept;
                }
                else
                {
                    dto.CanApproveAsEconomist = false;
                }
            }

            return dto;
        }


        private async Task<string?> GetRoleIdByName(string roleName)
        {
            var role = await _context.Roles
                .FirstOrDefaultAsync(r => r.Name == roleName);
            return role?.Id;
        }
    }
}


--- File: RequestProfile.cs (Path: .\AutomationOfPurchases.API\Services\Mappings\RequestProfile.cs) ---

﻿using AutoMapper;
using AutomationOfPurchases.Shared.Models;
using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Enums;

namespace AutomationOfPurchases.API.Services.Mappings
{
    public class RequestProfile : Profile
    {
        public RequestProfile()
        {
            CreateMap<Request, RequestDTO>()
                .ForMember(dest => dest.Status,
                    opt => opt.MapFrom(src => ConvertToEnum(src.Status)))
                .ForMember(dest => dest.OrderedByFullName,
                    opt => opt.MapFrom(src => src.OrderedBy != null ? src.OrderedBy.FullName : ""))
                .ForMember(dest => dest.OrderedByEmail,
                    opt => opt.MapFrom(src => src.OrderedBy != null ? src.OrderedBy.Email : ""))
                .ForMember(dest => dest.OrderedByDepartmentName,
                    opt => opt.MapFrom(src => src.OrderedBy != null && src.OrderedBy.Department != null
                        ? src.OrderedBy.Department.DepartmentName
                        : ""))
                .ForMember(dest => dest.DepartmentHeadApproverFullName,
                    opt => opt.MapFrom(src => src.DepartmentHeadApprover != null
                        ? src.DepartmentHeadApprover.FullName
                        : null))
                .ForMember(dest => dest.EconomistApproverFullName,
                    opt => opt.MapFrom(src => src.EconomistApprover != null
                        ? src.EconomistApprover.FullName
                        : null))
                .ForMember(dest => dest.RejectedByUserFullName,
                    opt => opt.MapFrom(src => src.RejectedByUser != null
                        ? src.RejectedByUser.FullName
                        : null))
                // Явне мапування для колекції позицій (Items)
                .ForMember(dest => dest.Items,
                           opt => opt.MapFrom(src => src.Items))
                .ReverseMap()
                .ForMember(dest => dest.Status, opt => opt.MapFrom(src => src.Status.ToString()))
                .ForMember(dest => dest.OrderedBy, opt => opt.Ignore())
                .ForMember(dest => dest.OrderedById, opt => opt.Ignore())
                .ForMember(dest => dest.DepartmentHeadApprover, opt => opt.Ignore())
                .ForMember(dest => dest.DepartmentHeadApproverId, opt => opt.Ignore())
                .ForMember(dest => dest.EconomistApprover, opt => opt.Ignore())
                .ForMember(dest => dest.EconomistApproverId, opt => opt.Ignore())
                .ForMember(dest => dest.RejectedByUser, opt => opt.Ignore())
                .ForMember(dest => dest.RejectedByUserId, opt => opt.Ignore())
                .ForMember(dest => dest.RequestId, opt => opt.Ignore())
                .ForMember(dest => dest.CreationDate, opt => opt.Ignore());

            CreateMap<RequestItem, RequestItemDTO>().ReverseMap();
            CreateMap<Item, ItemDTO>().ReverseMap();
        }

        private RequestStatus ConvertToEnum(string statusString)
        {
            return statusString.ToLower() switch
            {
                "draft" => RequestStatus.Draft,
                "pendingdepartmenthead" => RequestStatus.PendingDepartmentHead,
                "pendingeconomist" => RequestStatus.PendingEconomist,
                "approved" => RequestStatus.Approved,
                "rejected" => RequestStatus.Rejected,
                _ => RequestStatus.Draft
            };
        }
    }
}


--- File: UserProfile.cs (Path: .\AutomationOfPurchases.API\Services\Mappings\UserProfile.cs) ---

﻿using AutoMapper;
using AutomationOfPurchases.Shared.Models;
using AutomationOfPurchases.Shared.DTOs;

namespace AutomationOfPurchases.API.Services.Mappings
{
    public class UserProfile : Profile
    {
        public UserProfile()
        {
            // Мапінг для AppUser <-> UserDTO
            CreateMap<AppUser, UserDTO>()
                .ReverseMap();

            // Додаємо мапінг для Department <-> DepartmentDTO,
            // щоб AutoMapper міг коректно відобразити властивість Department у UserDTO
            CreateMap<Department, DepartmentDTO>()
                .ReverseMap();
        }
    }
}


--- File: App.razor (Path: .\AutomationOfPurchases.Client\App.razor) ---

﻿@using Microsoft.AspNetCore.Components.Authorization

<CascadingAuthenticationState>
    <Router AppAssembly="@typeof(App).Assembly">
        <Found Context="routeData">
            <AuthorizeRouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)">
                <NotAuthorized Context="authContext">
                    @if (!(authContext.User?.Identity?.IsAuthenticated ?? false))
                    {
                        <!-- Якщо користувач неавторизований -->
                        <RedirectToLogin />
                    }
                    else
                    {
                        <!-- Якщо авторизований, але не має потрібних прав/ролей -->
                        <p>У Вас немає прав доступу до цієї сторінки.</p>
                    }
                </NotAuthorized>
            </AuthorizeRouteView>
        </Found>
        <NotFound>
            <LayoutView Layout="@typeof(MainLayout)">
                <p>Сторінку не знайдено.</p>
            </LayoutView>
        </NotFound>
    </Router>
</CascadingAuthenticationState>


--- File: Program.cs (Path: .\AutomationOfPurchases.Client\Program.cs) ---

--- File: _Imports.razor (Path: .\AutomationOfPurchases.Client\_Imports.razor) ---

﻿@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components.WebAssembly.Http
@using Microsoft.JSInterop
@using AutomationOfPurchases.Client
@using AutomationOfPurchases.Client.Layout
@using Microsoft.AspNetCore.Authorization
@using AutomationOfPurchases.Client.Shared


--- File: CustomAuthHeaderHandler.cs (Path: .\AutomationOfPurchases.Client\Auth\CustomAuthHeaderHandler.cs) ---

﻿using System.Net.Http;
using System.Net.Http.Headers;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.JSInterop;

namespace AutomationOfPurchases.Client.Auth
{
    /// <summary>
    /// Кастомний DelegatingHandler, що в кожен HTTP-запит додає заголовок Authorization із токеном.
    /// </summary>
    public class CustomAuthHeaderHandler : DelegatingHandler
    {
        private readonly IJSRuntime _jsRuntime;

        public CustomAuthHeaderHandler(IJSRuntime jsRuntime)
        {
            _jsRuntime = jsRuntime;
        }

        protected override async Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            // 1) Спробуємо дістати токен із localStorage
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");

            // 2) Якщо токен не порожній – додамо заголовок Authorization
            if (!string.IsNullOrEmpty(token))
            {
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }

            // 3) Викликаємо "наступний" обробник у ланцюжку або безпосередньо відправляємо запит
            return await base.SendAsync(request, cancellationToken);
        }
    }
}


--- File: CustomAuthHeaderHandlerWith401.cs (Path: .\AutomationOfPurchases.Client\Auth\CustomAuthHeaderHandlerWith401.cs) ---

﻿using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Components;
using Microsoft.JSInterop;

namespace AutomationOfPurchases.Client.Auth
{
    /// <summary>
    /// DelegatingHandler, який:
    /// 1) Додає Bearer-токен із localStorage,
    /// 2) Якщо отримує 401 Unauthorized – знищує токен і перенаправляє на /login.
    /// </summary>
    public class CustomAuthHeaderHandlerWith401 : DelegatingHandler
    {
        private readonly IJSRuntime _jsRuntime;
        private readonly NavigationManager _navigationManager;

        public CustomAuthHeaderHandlerWith401(IJSRuntime jsRuntime, NavigationManager navigationManager)
        {
            _jsRuntime = jsRuntime;
            _navigationManager = navigationManager;
        }

        protected override async Task<HttpResponseMessage> SendAsync(
            HttpRequestMessage request,
            CancellationToken cancellationToken)
        {
            // 1) Дістаємо токен із localStorage
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (!string.IsNullOrEmpty(token))
            {
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }

            // 2) Робимо запит до сервера
            var response = await base.SendAsync(request, cancellationToken);

            // 3) Якщо отримали 401 - прибираємо токен і переходимо на логін
            if (response.StatusCode == HttpStatusCode.Unauthorized)
            {
                // Видаляємо токен
                await _jsRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");

                // Перенаправляємо на /login
                // forceLoad = true зробить повне перезавантаження сторінки
                _navigationManager.NavigateTo("/login", forceLoad: true);
            }

            return response;
        }
    }
}


--- File: CustomAuthStateProvider.cs (Path: .\AutomationOfPurchases.Client\Auth\CustomAuthStateProvider.cs) ---

﻿using Microsoft.AspNetCore.Components.Authorization;
using Microsoft.JSInterop;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;



namespace AutomationOfPurchases.Client.Auth
{
    public class CustomAuthStateProvider : AuthenticationStateProvider
    {
        private readonly IJSRuntime _jsRuntime;

        public CustomAuthStateProvider(IJSRuntime jsRuntime)
        {
            _jsRuntime = jsRuntime;
        }

        public override async Task<AuthenticationState> GetAuthenticationStateAsync()
        {
            // 1) Читаємо токен із LocalStorage
            var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrWhiteSpace(token))
            {
                // Якщо токена немає — повертаємо анонімного користувача
                var anonymous = new ClaimsPrincipal(new ClaimsIdentity());
                return new AuthenticationState(anonymous);
            }

            try
            {
                // 2) Розбираємо (декодуємо) JWT без перевірки підпису
                var handler = new JwtSecurityTokenHandler();
                var jwt = handler.ReadJwtToken(token);

                // 3) Створюємо ClaimsIdentity, вказуючи:
                //    - nameType, щоб ClaimTypes.Name брався з, наприклад, `sub` чи ін.
                //    - roleType, щоб ролі бралися з нашого claim типу (наприклад, 
                //      "http://schemas.microsoft.com/ws/2008/06/identity/claims/role").
                //    Залежно від того, що у вас у токені, можна підставити інші константи.
                var identity = new ClaimsIdentity(
                    claims: jwt.Claims,
                    authenticationType: "jwtAuth",
                    nameType: JwtRegisteredClaimNames.Sub, // або "unique_name" чи інший
                    roleType: "http://schemas.microsoft.com/ws/2008/06/identity/claims/role"
                );

                // 4) Створюємо ClaimsPrincipal і повертаємо
                var user = new ClaimsPrincipal(identity);
                return new AuthenticationState(user);
            }
            catch
            {
                // Якщо токен "битий" — повертаємо анонімного
                var anonymous = new ClaimsPrincipal(new ClaimsIdentity());
                return new AuthenticationState(anonymous);
            }
        }

        /// <summary>
        /// Викликати цей метод після логіну/логауту, 
        /// щоб повідомити Blazor, що авторизація змінилася.
        /// </summary>
        public void NotifyUserAuthenticationStateChanged()
        {
            NotifyAuthenticationStateChanged(GetAuthenticationStateAsync());
        }
    }
}


--- File: MainLayout.razor (Path: .\AutomationOfPurchases.Client\Layout\MainLayout.razor) ---

﻿@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand ms-3" href="/">Планування закупівель</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNav" aria-controls="navbarNav"
            aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    @if (isUserAuthenticated)
    {
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <!-- Звичайні пункти меню -->
                <li class="nav-item">
                    <NavLink class="nav-link" href="/">
                        Повідомлення
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="/create-request">
                        Створити заявку
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="nav-link" href="/my-requests">
                        Мої заявки
                    </NavLink>
                </li>

                <!-- Додатковий пункт для керівника відділу -->
                @if (isDepartmentHead)
                {
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/dept-requests">
                            Заявки відділу
                        </NavLink>
                    </li>
                }

                @if (isWarehouseWorker)
                {
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/warehouse-grouped">
                            Загальний список потреб
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/delivery-requests">
                            Заявки на доставку
                        </NavLink>
                    </li>
                }


                <!-- Додатковий пункт для економіста -->
                @if (isEconomist)
                {
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/eco-requests">
                            Заявки для обробки
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/general-needs">
                            Таблиця загальних потреб
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/net-needs">
                            Таблиця чистих потреб
                        </NavLink>
                    </li>
                }

                <!-- Кнопка “Вихід” -->
                <li class="nav-item">
                    <button class="btn btn-link nav-link text-white"
                            @onclick="Logout">
                        Вихід
                    </button>
                </li>
            </ul>
        </div>
    }
</nav>

<div class="container mt-4">
    @Body
</div>

@code {
    [Inject] IJSRuntime JSRuntime { get; set; } = default!;
    [Inject] AuthenticationStateProvider AuthStateProvider { get; set; } = default!;
    [Inject] NavigationManager Navigation { get; set; } = default!;

    private bool isUserAuthenticated;
    private bool isDepartmentHead;
    private bool isEconomist; // <--- Додана змінна
    private bool isWarehouseWorker; // <--- нове поле

    protected override async Task OnInitializedAsync()
    {
        // Отримуємо поточний стан автентифікації
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;


        // Перевірка, чи користувач авторизований
        isUserAuthenticated = user?.Identity?.IsAuthenticated ?? false;

        // Якщо авторизований, перевіряємо ролі
        if (isUserAuthenticated)
        {
            if (user.IsInRole("DepartmentHead"))
            {
                isDepartmentHead = true;
            }
            if (user.IsInRole("Economist"))
            {
                isEconomist = true;
            }
            if (user.IsInRole("WarehouseWorker")) isWarehouseWorker = true; // <---
        }
    }

    private async Task Logout()
    {
        // Видаляємо токен із localStorage
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");

        // Повідомляємо AuthStateProvider, що користувач більше не авторизований
        if (AuthStateProvider is AutomationOfPurchases.Client.Auth.CustomAuthStateProvider customProvider)
        {
            customProvider.NotifyUserAuthenticationStateChanged();
        }

        // Перенаправляємося на сторінку логіну (з повним перезавантаженням)
        Navigation.NavigateTo("/login", true);
    }
}


--- File: CreateRequest.razor (Path: .\AutomationOfPurchases.Client\Pages\CreateRequest.razor) ---

﻿@page "/create-request"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@using AutomationOfPurchases.Shared.DTOs
@using AutomationOfPurchases.Shared.Enums

<h3>Створення заявки</h3>

@if (items == null)
{
    <p>Завантаження списку ТМЦ...</p>
}
else
{
    <EditForm Model="@requestDto" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Назва заявки -->
        <div class="mb-3">
            <label class="form-label">Назва заявки</label>
            <InputText class="form-control"
                       @bind-Value="requestDto.Title"
                       placeholder="Назва повинна відображати головне, що потрібно закупити." />
        </div>

        <!-- Опис заявки -->
        <div class="mb-3">
            <label class="form-label">Опис заявки</label>
            <InputTextArea class="form-control"
                           @bind-Value="requestDto.Description"
                           rows="3"
                           placeholder="Коротко опишіть що та навіщо потрібно закупити." />
        </div>

        <h5>Додати ТМЦ</h5>
        <!-- Поле додавання ТМЦ з відображенням одиниці виміру -->
        <div class="row g-2 align-items-end">
            <div class="col-md-5 position-relative">
                <label class="form-label">Назва</label>
                <input class="form-control"
                       type="text"
                       placeholder="Введіть назву ТМЦ..."
                       @bind-value="typedItemName"
                       @bind-value:event="oninput"
                       @bind-value:after="HandleItemNameChanged"
                       @onfocus="HandleItemNameChanged"
                       @onblur="HideSuggestions" />
                @if (showSuggestions && suggestions.Any())
                {
                    <ul class="list-group" style="position: absolute; z-index: 999; width: 100%; max-height: 200px; overflow-y: auto;">
                        @foreach (var it in suggestions)
                        {
                            <!-- Використовуємо onmousedown, щоб вибір елемента відбувався до втрати фокусу -->
                            <li class="list-group-item list-group-item-action"
                                @onmousedown="() => SelectItem(it)">
                                @it.ItemName (@it.StorageUnit)
                            </li>
                        }
                    </ul>
                }
            </div>
            <div class="col-md-2">
                <label class="form-label">Одиниця виміру</label>
                <input class="form-control"
                       type="text"
                       readonly
                       value="@(selectedItem?.StorageUnit)"
                       placeholder="Одиниця" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Кількість</label>
                <input class="form-control" type="number" @bind="selectedQuantity" min="1" />
            </div>
            <div class="col-md-3" style="padding-bottom: 0.5rem;">
                <button type="button" class="btn btn-success w-100"
                        @onclick="AddPosition"
                        disabled="@( !CanAddPosition )">
                    Додати
                </button>
            </div>
        </div>

        <!-- Список позицій у заявці -->
        <div class="mt-3">
            <h5>Список ТМЦ у заявці</h5>
            @if (!requestDto.Items.Any())
            {
                <p>Поки що жодної позиції</p>
            }
            else
            {
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ТМЦ</th>
                            <th>Одиниця виміру</th>
                            <th>Кількість</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ri in requestDto.Items)
                        {
                            var item = items.FirstOrDefault(i => i.ItemId == ri.ItemId);
                            <tr>
                                <td>@item?.ItemName</td>
                                <td>@item?.StorageUnit</td>
                                <td>
                                    <InputNumber class="form-control"
                                                 @bind-Value="ri.Quantity"
                                                 min="1" />
                                </td>
                                <td>
                                    <button class="btn btn-link text-danger" @onclick="() => RemovePosition(ri)">
                                        Видалити
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <button type="submit" class="btn btn-primary mt-3 me-3" disabled="@(!CanSaveRequest)">
            Створити заявку
        </button>
        <button type="button" class="btn btn-secondary mt-3" @onclick="SaveAsDraft" disabled="@(!CanSaveRequest)">
            Зберегти як чернетку
        </button>
    </EditForm>
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@code {
    private List<ItemDTO>? items;
    private RequestDTO requestDto = new RequestDTO
        {
            Items = new List<RequestItemDTO>()
        };

    private string? message;

    // Поле для автодоповнення
    private string typedItemName = "";
    private List<ItemDTO> suggestions = new List<ItemDTO>();
    private bool showSuggestions = false;
    private ItemDTO? selectedItem;

    // Поле для кількості
    private int selectedQuantity = 1;

    // Кнопка "Додати" активна, якщо обрано ТМЦ та введено кількість > 0
    private bool CanAddPosition => selectedItem != null && selectedQuantity > 0;

    // Заявку можна зберегти лише якщо заповнені поля Назва, Опис та додано хоча б один ТМЦ
    private bool CanSaveRequest =>
        !string.IsNullOrWhiteSpace(requestDto.Title) &&
        !string.IsNullOrWhiteSpace(requestDto.Description) &&
        requestDto.Items.Any();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Завантаження чернетки, якщо є query-параметр "draftId"
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var draftIdStr = queryParams["draftId"];
            if (!string.IsNullOrEmpty(draftIdStr) && int.TryParse(draftIdStr, out int draftId))
            {
                var draft = await Http.GetFromJsonAsync<RequestDTO>($"api/request/my/{draftId}");
                if (draft != null && draft.Status == RequestStatus.Draft)
                {
                    requestDto = draft;
                }
                else
                {
                    message = "Неможливо завантажити чернетку або вона не має статусу Draft.";
                }
            }

            // Завантаження списку ТМЦ
            items = await Http.GetFromJsonAsync<List<ItemDTO>>("api/item");
        }
        catch (Exception ex)
        {
            message = "Помилка завантаження даних: " + ex.Message;
            items = new List<ItemDTO>();
        }
    }

    private void HandleItemNameChanged()
    {
        if (string.IsNullOrWhiteSpace(typedItemName))
        {
            // Показуємо ВСІ items
            suggestions = items!.ToList();
            showSuggestions = suggestions.Any();
        }
        else
        {
            // Фільтруємо за typedItemName, але теж БЕЗ обмеження
            suggestions = items!
                .Where(i => i.ItemName.Contains(typedItemName, StringComparison.OrdinalIgnoreCase))
                .ToList();
            showSuggestions = suggestions.Any();
        }
    }


    private void HideSuggestions() => showSuggestions = false;

    private void SelectItem(ItemDTO item)
    {
        selectedItem = item;
        typedItemName = item.ItemName;
        showSuggestions = false;
    }

    private void AddPosition()
    {
        if (selectedItem == null)
        {
            message = "Спочатку оберіть ТМЦ зі списку.";
            return;
        }
        if (selectedQuantity <= 0)
        {
            message = "Невірна кількість.";
            return;
        }

        requestDto.Items.Add(new RequestItemDTO
            {
                ItemId = selectedItem.ItemId,
                Quantity = selectedQuantity
            });

        // Очищення полів для наступного вводу
        typedItemName = "";
        selectedItem = null;
        selectedQuantity = 1;
        message = null;
        showSuggestions = false;
        suggestions.Clear();
    }

    private void RemovePosition(RequestItemDTO ri)
    {
        requestDto.Items.Remove(ri);
    }

    /// <summary>
    /// Обробка збереження заявки у "бойовому" режимі (не Draft)
    /// </summary>
    private async Task HandleValidSubmit()
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", new object[] { "Потім змінити дані буде неможливо. Ви впевнені?" });
        if (!confirm)
            return;

        requestDto.Status = RequestStatus.PendingDepartmentHead;
        await SaveOrUpdateAsync();
    }

    /// <summary>
    /// Збереження як чернетки (Draft)
    /// </summary>
    private async Task SaveAsDraft()
    {
        requestDto.Status = RequestStatus.Draft;
        await SaveOrUpdateAsync();
    }

    /// <summary>
    /// Виконує POST (створення) або PUT (оновлення) заявки
    /// </summary>
    private async Task SaveOrUpdateAsync()
    {
        try
        {
            HttpResponseMessage resp;
            if (requestDto.RequestId > 0)
            {
                resp = await Http.PutAsJsonAsync($"api/request/{requestDto.RequestId}", requestDto);
            }
            else
            {
                resp = await Http.PostAsJsonAsync("api/request", requestDto);
            }

            if (resp.IsSuccessStatusCode)
            {
                var saved = await resp.Content.ReadFromJsonAsync<RequestDTO>();
                if (saved != null)
                {
                    requestDto = saved;
                    message = "Заявку збережено успішно.";

                    if (requestDto.Status != RequestStatus.Draft)
                    {
                        Navigation.NavigateTo("/my-requests", true);
                    }
                }
            }
            else
            {
                var err = await resp.Content.ReadAsStringAsync();
                message = $"Помилка збереження: {err}";
            }
        }
        catch (Exception ex)
        {
            message = $"Помилка: {ex.Message}";
        }
    }
}


--- File: DeliveryRequests.razor (Path: .\AutomationOfPurchases.Client\Pages\DeliveryRequests.razor) ---

﻿@page "/delivery-requests"
@attribute [Authorize(Roles = "WarehouseWorker")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime

@using AutomationOfPurchases.Shared.DTOs

<h3>Заявки на доставку</h3>

<!-- Кнопка для розгортання/згортання панелі фільтру -->
<button class="btn btn-secondary mb-3" @onclick="ToggleFilter">
    @(showFilter ? "Сховати фільтр" : "Фільтрація")
</button>

@if (showFilter)
{
    <div class="border p-3 mb-3">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">ТМЦ</label>
                <input class="form-control"
                       @bind="filterTmc"
                       @bind:event="oninput"
                       placeholder="Назва товару..." />
            </div>
            <div class="col-md-3">
                <label class="form-label">Склад</label>
                <input class="form-control"
                       @bind="filterWarehouse"
                       @bind:event="oninput"
                       placeholder="Назва складу..." />
            </div>
            <div class="col-md-3">
                <label class="form-label">Замовник</label>
                <input class="form-control"
                       @bind="filterUser"
                       @bind:event="oninput"
                       placeholder="ПІБ замовника..." />
            </div>
            <div class="col-md-3">
                <label class="form-label">Відділ</label>
                <input class="form-control"
                       @bind="filterDept"
                       @bind:event="oninput"
                       placeholder="Назва відділу..." />
            </div>
        </div>

        <!-- Кнопка застосування фільтру -->
        <button class="btn btn-primary mt-3" @onclick="ApplyFilter">
            Застосувати
        </button>
    </div>
}

@if (requests == null)
{
    <p>Завантаження...</p>
}
else if (!requests.Any())
{
    <p>Немає заявок на доставку.</p>
}
else
{
    <table class="table table-hover table-striped table-bordered table-sm align-middle">
        <thead>
            <tr class="table-light">
                <th>ТМЦ</th>
                <th style="width:120px;">Кількість</th>
                <th style="width:150px;">Склад</th>
                <th style="width:180px;">Замовник</th>
                <th style="width:180px;">Відділ</th>
                <th style="width:220px;">Пошта</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var d in filteredRequests)
            {
                <tr>
                    <td>@d.ItemName</td>
                    <td>@d.Quantity</td>
                    <td>@d.Warehouse</td>
                    <td>@d.OrderedByFullName</td>
                    <td>@d.OrderedByDepartmentName</td>
                    <td>@d.OrderedByEmail</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<DeliveryRequestDTO>? requests;
    private List<DeliveryRequestDTO> filteredRequests = new();

    // Панель фільтру
    private bool showFilter = false;

    // Поля для фільтра
    private string filterTmc = "";
    private string filterWarehouse = "";
    private string filterUser = "";
    private string filterDept = "";

    protected override async Task OnInitializedAsync()
    {
        // Викликаємо GET /api/deliveryrequests
        requests = await Http.GetFromJsonAsync<List<DeliveryRequestDTO>>("api/deliveryrequests");
        filteredRequests = requests ?? new List<DeliveryRequestDTO>();
    }

    private void ToggleFilter()
    {
        showFilter = !showFilter;
    }

    private void ApplyFilter()
    {
        if (requests == null) return;

        // Початкова колекція
        var query = requests.AsEnumerable();

        // 1) Фільтр ТМЦ
        if (!string.IsNullOrWhiteSpace(filterTmc))
        {
            var lowerTmc = filterTmc.ToLower();
            query = query.Where(d => d.ItemName.ToLower().Contains(lowerTmc));
        }

        // 2) Фільтр Склад
        if (!string.IsNullOrWhiteSpace(filterWarehouse))
        {
            var lowerWh = filterWarehouse.ToLower();
            query = query.Where(d => d.Warehouse.ToLower().Contains(lowerWh));
        }

        // 3) Фільтр Замовник
        if (!string.IsNullOrWhiteSpace(filterUser))
        {
            var lowerUser = filterUser.ToLower();
            query = query.Where(d => d.OrderedByFullName.ToLower().Contains(lowerUser));
        }

        // 4) Фільтр Відділ
        if (!string.IsNullOrWhiteSpace(filterDept))
        {
            var lowerDept = filterDept.ToLower();
            query = query.Where(d => d.OrderedByDepartmentName.ToLower().Contains(lowerDept));
        }

        filteredRequests = query.ToList();
    }
}


--- File: DeptHeadRequests.razor (Path: .\AutomationOfPurchases.Client\Pages\DeptHeadRequests.razor) ---

﻿@page "/dept-requests"
@attribute [Authorize(Roles = "DepartmentHead")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

@using AutomationOfPurchases.Shared.DTOs
@using AutomationOfPurchases.Shared.Enums
@using AutomationOfPurchases.Shared.Localization

<h3>Заявки мого департаменту</h3>

<!-- Перемикач "Показати розглянуті заявки" =>
     Якщо увімкнути, показуємо ВСІ заявки (крім Draft).
     Якщо вимкнути, показуємо лише PendingDepartmentHead. -->
<div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" role="switch"
           id="showReviewedSwitch"
           @bind="showReviewedRequests" />
    <label class="form-check-label" for="showReviewedSwitch">
        Показати розглянуті
    </label>
</div>

<!-- Поле пошуку за назвою заявки -->
<div class="mb-3">
    <label class="form-label">Пошук за назвою заявки:</label>
    <input type="text" class="form-control" @bind="searchTitle"
           placeholder="Введіть фрагмент назви" />
</div>

<!-- Поле пошуку за автором заявки -->
<div class="mb-3">
    <label class="form-label">Пошук за автором заявки:</label>
    <input type="text" class="form-control" @bind="searchAuthor"
           placeholder="Введіть фрагмент імені автора" />
</div>

@if (requests == null)
{
    <p>Завантаження...</p>
}
else
{
    var filteredRequests = GetFilteredRequests();
    if (!filteredRequests.Any())
    {
        <p>Немає заявок для відображення</p>
    }
    else
    {
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Назва заявки</th>
                    <th>Автор заявки</th>
                    <th>Статус заявки</th>
                    <th>Дата створення</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in filteredRequests)
                {
                    <tr>
                        <td>@r.Title</td>
                        <td>@r.OrderedByFullName</td>
                        <td>@RequestStatusLocalizer.Localize(r.Status)</td>
                        <td>@r.CreationDate.ToLocalTime()</td>
                        <td>
                            <button class="btn btn-primary btn-sm"
                                    @onclick="() => ViewRequest(r.RequestId)">
                                Переглянути заявку
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@code {
    private List<RequestDTO>? requests;
    private string? message;

    // Перемикач: якщо увімкнений => показуємо всі (крім Draft),
    // якщо вимкнений => лише PendingDepartmentHead
    private bool showReviewedRequests = false;

    // Поля пошуку
    private string? searchTitle;
    private string? searchAuthor;

    protected override async Task OnInitializedAsync()
    {
        await LoadRequestsAsync();
    }

    private async Task LoadRequestsAsync()
    {
        message = null;
        try
        {
            // GET: api/request/department
            requests = await Http.GetFromJsonAsync<List<RequestDTO>>("api/request/department");
        }
        catch (Exception ex)
        {
            message = $"Помилка завантаження: {ex.Message}";
        }
    }

    private void ViewRequest(int requestId)
    {
        // Переходимо на сторінку деталей
        Navigation.NavigateTo($"/request-details/{requestId}");
    }

    private IEnumerable<RequestDTO> GetFilteredRequests()
    {
        if (requests == null)
            return Enumerable.Empty<RequestDTO>();

        var query = requests.AsEnumerable();

        // Якщо перемикач вимкнено (showReviewedRequests == false),
        // показуємо лише ті, що в статусі PendingDepartmentHead
        if (!showReviewedRequests)
        {
            query = query.Where(r => r.Status == RequestStatus.PendingDepartmentHead);
        }
        else
        {
            // Якщо перемикач увімкнено,
            // показуємо всі заявки, крім Draft
            query = query.Where(r => r.Status != RequestStatus.Draft);
        }

        // Пошук за назвою заявки
        if (!string.IsNullOrWhiteSpace(searchTitle))
        {
            var lower = searchTitle.ToLower();
            query = query.Where(r => (r.Title ?? "").ToLower().Contains(lower));
        }

        // Пошук за автором заявки
        if (!string.IsNullOrWhiteSpace(searchAuthor))
        {
            var lowerAuth = searchAuthor.ToLower();
            query = query.Where(r => (r.OrderedByFullName ?? "").ToLower().Contains(lowerAuth));
        }

        return query;
    }
}


--- File: EconomistRequests.razor (Path: .\AutomationOfPurchases.Client\Pages\EconomistRequests.razor) ---

﻿@page "/eco-requests"
@attribute [Authorize(Roles = "Economist")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

@using AutomationOfPurchases.Shared.DTOs
@using AutomationOfPurchases.Shared.Enums
@using AutomationOfPurchases.Shared.Localization

<h3>Заявки для економіста</h3>

<!-- Перемикач "Показати розглянуті заявки" -->
<div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" role="switch"
           id="showReviewedSwitch"
           @bind="showReviewedRequests" />
    <label class="form-check-label" for="showReviewedSwitch">
        Показати розглянуті заявки
    </label>
</div>

<!-- Поле пошуку за назвою заявки -->
<div class="mb-3">
    <label class="form-label">Пошук за назвою заявки:</label>
    <input type="text" class="form-control" @bind="searchTitle"
           placeholder="Введіть фрагмент назви" />
</div>

<!-- Поле пошуку за автором заявки -->
<div class="mb-3">
    <label class="form-label">Пошук за автором заявки:</label>
    <input type="text" class="form-control" @bind="searchAuthor"
           placeholder="Введіть фрагмент імені автора" />
</div>

@if (requests == null)
{
    <p>Завантаження...</p>
}
else
{
    var filteredRequests = GetFilteredRequests();
    if (!filteredRequests.Any())
    {
        <p>Немає заявок для відображення</p>
    }
    else
    {
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Назва заявки</th>
                    <th>Автор заявки</th>
                    <th>Відділ замовника</th>
                    <th>Статус заявки</th>
                    <th>Дата створення</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in filteredRequests)
                {
                    <tr>
                        <td>@r.Title</td>
                        <td>@r.OrderedByFullName</td>
                        <td>@r.OrderedByDepartmentName</td> <!-- НОВА КОЛОНКА -->
                        <td>@RequestStatusLocalizer.Localize(r.Status)</td>
                        <td>@r.CreationDate.ToLocalTime()</td>
                        <td>
                            <button class="btn btn-primary btn-sm"
                                    @onclick="() => ViewRequest(r.RequestId)">
                                Переглянути заявку
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@code {
    private List<RequestDTO>? requests;
    private string? message;

    // Перемикач: показувати Approved/Rejected чи лише PendingEconomist
    private bool showReviewedRequests = false;

    // Поля пошуку
    private string? searchTitle;
    private string? searchAuthor;

    protected override async Task OnInitializedAsync()
    {
        await LoadRequestsAsync();
    }

    private async Task LoadRequestsAsync()
    {
        try
        {
            // GET: api/request/economist
            requests = await Http.GetFromJsonAsync<List<RequestDTO>>("api/request/economist");
        }
        catch (Exception ex)
        {
            message = $"Помилка завантаження: {ex.Message}";
        }
    }

    private void ViewRequest(int requestId)
    {
        Navigation.NavigateTo($"/request-details/{requestId}");
    }

    private IEnumerable<RequestDTO> GetFilteredRequests()
    {
        if (requests == null)
            return Enumerable.Empty<RequestDTO>();

        var query = requests.AsEnumerable();

        // Якщо перемикач вимкнено,
        // показуємо лише ті, що в статусі PendingEconomist
        if (!showReviewedRequests)
        {
            query = query.Where(r => r.Status == RequestStatus.PendingEconomist);
        }
        else
        {
            // Якщо перемикач увімкнено,
            // показуємо всі заявки, крім Draft
            query = query.Where(r => r.Status != RequestStatus.Draft);
        }

        // Пошук за назвою заявки
        if (!string.IsNullOrWhiteSpace(searchTitle))
        {
            var lowerTitle = searchTitle.ToLower();
            query = query.Where(r => (r.Title ?? "").ToLower().Contains(lowerTitle));
        }

        // Пошук за автором заявки
        if (!string.IsNullOrWhiteSpace(searchAuthor))
        {
            var lowerAuth = searchAuthor.ToLower();
            query = query.Where(r => (r.OrderedByFullName ?? "").ToLower().Contains(lowerAuth));
        }

        return query;
    }
}


--- File: GeneralNeedsList.razor (Path: .\AutomationOfPurchases.Client\Pages\GeneralNeedsList.razor) ---

﻿@page "/general-needs"
@attribute [Authorize(Roles = "Economist")]
@inject HttpClient Http

@using System.Net.Http.Json
@using AutomationOfPurchases.Shared.DTOs

<h3>Таблиця загальних потреб</h3>

<!-- Кнопка/перемикач для розкриття панелі фільтра -->
<button class="btn btn-secondary mb-3" @onclick="ToggleFilter">
    @(showFilter ? "Сховати фільтр" : "Фільтрація")
</button>

@if (showFilter)
{
    <div class="border p-3 mb-3">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Назва ТМЦ</label>
                <input class="form-control"
                       @bind="filterTmc"
                       @bind:event="oninput"
                       placeholder="Введіть назву..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">Департамент</label>
                <input class="form-control"
                       @bind="filterDept"
                       @bind:event="oninput"
                       placeholder="Введіть відділ..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">Замовник</label>
                <input class="form-control"
                       @bind="filterUser"
                       @bind:event="oninput"
                       placeholder="ПІБ замовника..." />
            </div>
        </div>

        <button class="btn btn-primary mt-3" @onclick="ApplyFilter">
            Застосувати
        </button>
    </div>
}

@if (lists == null)
{
    <p>Завантаження...</p>
}
else if (!lists.Any())
{
    <p>Немає жодного активного списку загальних потреб.</p>
}
else
{
    @foreach (var list in filteredLists)
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <!-- Наприклад, заголовок «Список #..., створений ...» -->
                <h5 class="card-title mb-3">Загальний список (ID=@list.ListId)</h5>
                <p>Створено: @list.CreationDate</p>

                <table class="table table-sm align-middle">
                    <thead>
                        <tr class="table-light">
                            <th>ТМЦ</th>
                            <th style="width:100px;">Одиниця</th>
                            <th style="width:130px;">Кількість</th>
                            <th style="width:100px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ag in list.AggregatedItems)
                        {
                            <tr>
                                <td>
                                    <strong>@ag.ItemName</strong>
                                </td>
                                <td>@ag.StorageUnit</td>
                                <td>@ag.TotalQuantity</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary"
                                            @onclick="@(() => ToggleExpand(ag))">
                                        @(ag.IsExpanded ? "Сховати" : "Розкрити")
                                    </button>
                                </td>
                            </tr>

                            @if (ag.IsExpanded)
                            {
                                <tr>
                                    <td colspan="4">
                                        <!-- Підтаблиця детальних замовників -->
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Замовник</th>
                                                    <th>Відділ</th>
                                                    <th>Кількість</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var d in ag.Details)
                                                {
                                                    <tr>
                                                        <td>@d.OrderedByFullName</td>
                                                        <td>@d.DepartmentName</td>
                                                        <td>@d.Quantity</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    private List<GeneralNeedsListExpandedDTO>? lists;
    private List<GeneralNeedsListExpandedDTO> filteredLists = new();

    // Поля фільтру
    private bool showFilter = false;
    private string filterTmc = "";
    private string filterDept = "";
    private string filterUser = "";

    protected override async Task OnInitializedAsync()
    {
        // Викликаємо ваш API GET /api/generalneeds/expanded
        lists = await Http.GetFromJsonAsync<List<GeneralNeedsListExpandedDTO>>("api/generalneeds/expanded")
                 ?? new List<GeneralNeedsListExpandedDTO>();

        filteredLists = lists;
    }

    private void ToggleFilter() => showFilter = !showFilter;

    private void ApplyFilter()
    {
        if (lists == null) return;
        var query = lists.AsEnumerable();

        // 1) Фільтр за назвою ТМЦ
        if (!string.IsNullOrWhiteSpace(filterTmc))
        {
            var lowerTmc = filterTmc.ToLower();
            query = query.Select(l =>
            {
                var newAgg = l.AggregatedItems
                    .Where(ag => ag.ItemName.ToLower().Contains(lowerTmc))
                    .ToList();

                return new GeneralNeedsListExpandedDTO
                    {
                        ListId = l.ListId,
                        CreationDate = l.CreationDate,
                        NullificationDate = l.NullificationDate,
                        AggregatedItems = newAgg
                    };
            })
            .Where(l => l.AggregatedItems.Any());
        }

        // 2) Фільтр за департаментом
        if (!string.IsNullOrWhiteSpace(filterDept))
        {
            var lowerDept = filterDept.ToLower();
            query = query.Select(l =>
            {
                var newAgg = l.AggregatedItems.Select(ag =>
                {
                    var filteredDetails = ag.Details
                        .Where(d => d.DepartmentName.ToLower().Contains(lowerDept))
                        .ToList();

                    return new GeneralAggregatedItemDTO
                        {
                            ItemId = ag.ItemId,
                            ItemName = ag.ItemName,
                            StorageUnit = ag.StorageUnit,
                            TotalQuantity = ag.TotalQuantity,
                            IsExpanded = ag.IsExpanded,
                            Details = filteredDetails
                        };
                })
                .Where(ag => ag.Details.Any())
                .ToList();

                return new GeneralNeedsListExpandedDTO
                    {
                        ListId = l.ListId,
                        CreationDate = l.CreationDate,
                        NullificationDate = l.NullificationDate,
                        AggregatedItems = newAgg
                    };
            })
            .Where(x => x.AggregatedItems.Any());
        }

        // 3) Фільтр за замовником
        if (!string.IsNullOrWhiteSpace(filterUser))
        {
            var lowerUser = filterUser.ToLower();
            query = query.Select(l =>
            {
                var newAgg = l.AggregatedItems.Select(ag =>
                {
                    var newDetails = ag.Details
                        .Where(d => d.OrderedByFullName.ToLower().Contains(lowerUser))
                        .ToList();

                    return new GeneralAggregatedItemDTO
                        {
                            ItemId = ag.ItemId,
                            ItemName = ag.ItemName,
                            StorageUnit = ag.StorageUnit,
                            TotalQuantity = ag.TotalQuantity,
                            IsExpanded = ag.IsExpanded,
                            Details = newDetails
                        };
                })
                .Where(ag => ag.Details.Any())
                .ToList();

                return new GeneralNeedsListExpandedDTO
                    {
                        ListId = l.ListId,
                        CreationDate = l.CreationDate,
                        NullificationDate = l.NullificationDate,
                        AggregatedItems = newAgg
                    };
            })
            .Where(l => l.AggregatedItems.Any());
        }

        filteredLists = query.ToList();
    }

    private void ToggleExpand(GeneralAggregatedItemDTO ag)
    {
        ag.IsExpanded = !ag.IsExpanded;
    }
}


--- File: Home.razor (Path: .\AutomationOfPurchases.Client\Pages\Home.razor) ---

﻿@page "/notifications"
@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation

@using AutomationOfPurchases.Shared.DTOs

<style>
    .notifications-container {
        max-width: 750px;
        margin: 4rem auto 2rem auto;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 2rem;
    }

    .notifications-title {
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .notification-item-new {
        border: 2px solid #428bca;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #f7fcff;
    }

    .notification-item-read {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .notification-header {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .notification-date {
        font-size: 0.85rem;
        color: #777;
    }

    .notification-body {
        margin-top: 0.25rem;
    }

    /* Стиль для кнопки фільтру */
    .filter-button {
        margin-bottom: 1.5rem;
    }
</style>

<div class="notifications-container">
    <h2 class="notifications-title">Повідомлення</h2>

    <!-- Кнопка для вмикання/вимикання панелі фільтрації -->
    <button class="btn btn-secondary filter-button" @onclick="ToggleFilter">
        @(showFilter ? "Сховати фільтри" : "Фільтрація")
    </button>

    <!-- Панель фільтрації (відображається, якщо showFilter == true) -->
    @if (showFilter)
    {
        <div class="border p-3 mb-4">
            <h5>Фільтрація</h5>
            <!-- Фільтр за заголовком повідомлення -->
            <div class="mb-3">
                <label class="form-label">Пошук у заголовку повідомлення:</label>
                <input class="form-control"
                       @bind="searchTitle"
                       @bind:event="oninput"
                       placeholder="Введіть фрагмент заголовку..." />
            </div>
            <!-- Фільтр за описом повідомлення -->
            <div class="mb-3">
                <label class="form-label">Пошук за описом повідомлення:</label>
                <input class="form-control"
                       @bind="searchDescription"
                       @bind:event="oninput"
                       placeholder="Введіть фрагмент опису..." />
            </div>
            <button class="btn btn-primary" @onclick="FilterNotifications">
                Застосувати
            </button>
        </div>
    }

    @if (!notificationsLoaded)
    {
        <p>Завантаження повідомлень...</p>
    }
    else if (notifications == null)
    {
        <p>Помилка завантаження повідомлень.</p>
    }
    else
    {
        <h4>Непрочитані повідомлення</h4>
        @if (newMessagesFiltered.Any())
        {
            @foreach (var notif in newMessagesFiltered)
            {
                <div class="notification-item-new d-flex justify-content-between align-items-center">
                    <div class="notification-body-section">
                        <div class="notification-header">@notif.Title</div>
                        <div class="notification-date">@notif.CreatedAt.ToLocalTime()</div>
                        <div class="notification-body">@notif.Message</div>
                    </div>
                    @if (!string.IsNullOrEmpty(notif.LinkUrl))
                    {
                        <button class="btn btn-primary btn-sm"
                                @onclick="() => OnViewButtonClick(notif.LinkUrl, notif.NotificationId)">
                            Переглянути
                        </button>
                    }
                </div>
            }
        }
        else
        {
            <p>Немає нових повідомлень (фільтр застосовано).</p>
        }

        <h4 class="mt-4">Прочитані повідомлення</h4>
        @if (readMessagesFiltered.Any())
        {
            @foreach (var notif in readMessagesFiltered)
            {
                <div class="notification-item-read d-flex justify-content-between align-items-center">
                    <div class="notification-body-section">
                        <div class="notification-header">@notif.Title</div>
                        <div class="notification-date">@notif.CreatedAt.ToLocalTime()</div>
                        <div class="notification-body">@notif.Message</div>
                    </div>
                    @if (!string.IsNullOrEmpty(notif.LinkUrl))
                    {
                        <button class="btn btn-secondary btn-sm"
                                @onclick="() => Navigation.NavigateTo(notif.LinkUrl)">
                            Переглянути
                        </button>
                    }
                </div>
            }
        }
        else
        {
            <p>Немає прочитаних повідомлень (фільтр застосовано).</p>
        }
    }
</div>

@code {
    // Колекція повідомлень
    private List<NotificationDTO>? notifications;
    // Пошуковий запит за заголовком повідомлення
    private string searchTitle = "";
    // Пошуковий запит за описом повідомлення
    private string searchDescription = "";

    // Відфільтровані повідомлення
    private List<NotificationDTO> newMessagesFiltered = new();
    private List<NotificationDTO> readMessagesFiltered = new();

    private bool notificationsLoaded = false;
    private bool showFilter = false;

    protected override async Task OnInitializedAsync()
    {
        // Завантаження повідомлень поточного користувача
        notifications = await Http.GetFromJsonAsync<List<NotificationDTO>>("api/notification/my");
        notificationsLoaded = true;

        FilterNotifications();
    }

    private void ToggleFilter() => showFilter = !showFilter;

    private void FilterNotifications()
    {
        if (notifications == null)
            return;

        var filtered = notifications.AsEnumerable();

        // Фільтрація за заголовком повідомлення
        if (!string.IsNullOrWhiteSpace(searchTitle))
        {
            var lowerSearch = searchTitle.ToLower();
            filtered = filtered.Where(n => (n.Title ?? "").ToLower().Contains(lowerSearch));
        }

        // Фільтрація за описом повідомлення (Message)
        if (!string.IsNullOrWhiteSpace(searchDescription))
        {
            var lowerDesc = searchDescription.ToLower();
            filtered = filtered.Where(n => (n.Message ?? "").ToLower().Contains(lowerDesc));
        }

        newMessagesFiltered = filtered.Where(n => !n.IsRead)
                                      .OrderByDescending(n => n.CreatedAt)
                                      .ToList();
        readMessagesFiltered = filtered.Where(n => n.IsRead)
                                       .OrderByDescending(n => n.CreatedAt)
                                       .ToList();
    }

    private async void OnViewButtonClick(string linkUrl, int notifId)
    {
        Navigation.NavigateTo(linkUrl);
        await MarkAsRead(notifId);
    }

    private async Task MarkAsRead(int notifId)
    {
        var response = await Http.PutAsync($"api/notification/{notifId}/mark-read", null);
        if (response.IsSuccessStatusCode)
        {
            var notif = notifications?.FirstOrDefault(n => n.NotificationId == notifId);
            if (notif != null)
            {
                notif.IsRead = true;
            }
            FilterNotifications();
        }
    }
}


--- File: Login.razor (Path: .\AutomationOfPurchases.Client\Pages\Login.razor) ---

﻿@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]

@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

@using System.Net.Http.Json

<style>
    .login-container {
        /* Виставляємо ширину та відступи, щоб блок був по центру екрану */
        max-width: 400px;
        margin: 10vh auto; /* відступ зверху, щоб блок був приблизно по центру */
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 2rem;
        background-color: #fff;
    }

    .login-title {
        text-align: center;
        margin-bottom: 1rem;
    }
</style>

<div class="login-container">
    <h3 class="login-title">Вхід до системи</h3>

    <EditForm Model="@credentials" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Логін</label>
            <InputText class="form-control" @bind-Value="@credentials.UserName" />
        </div>

        <div class="mb-3">
            <label class="form-label">Пароль</label>
            <InputText class="form-control" @bind-Value="@credentials.Password" type="password" />
        </div>

        <button type="submit" class="btn btn-primary w-100">Увійти</button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mt-3">@errorMessage</div>
        }
    </EditForm>
</div>

@code {
    private LoginRequest credentials = new();
    private string? errorMessage;

    private async Task HandleValidSubmit()
    {
        errorMessage = null;

        try
        {
            // Відправляємо логін-запит на API (припустимо: POST /api/auth/login)
            var response = await Http.PostAsJsonAsync("api/auth/login", credentials);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (result is not null && !string.IsNullOrWhiteSpace(result.Token))
                {
                    // Зберігаємо токен у localStorage
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "authToken", result.Token);

                    // Повідомляємо провайдер, що користувач тепер авторизований
                    if (AuthStateProvider is Client.Auth.CustomAuthStateProvider customProvider)
                    {
                        customProvider.NotifyUserAuthenticationStateChanged();
                    }

                    // Перенаправляємося на головну (або на /notifications)
                    Navigation.NavigateTo("/", true);
                }
                else
                {
                    errorMessage = "Сервер не повернув дійсний токен.";
                }
            }
            else
            {
                errorMessage = "Неправильний логін або пароль.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    // Класи, потрібні для JSON-серіалізації
    class LoginRequest
    {
        public string UserName { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    class LoginResponse
    {
        public string Token { get; set; } = string.Empty;
    }
}


--- File: MyRequests.razor (Path: .\AutomationOfPurchases.Client\Pages\MyRequests.razor) ---

﻿@page "/my-requests"
@attribute [Authorize]
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

@using AutomationOfPurchases.Shared.DTOs
@using AutomationOfPurchases.Shared.Enums
@using AutomationOfPurchases.Shared.Localization

<h3>Мої заявки</h3>

<div class="mb-3">
    <label class="form-label">Пошук за назвою заявки:</label>
    <input type="text" class="form-control" @bind="searchTitle"
           placeholder="Введіть фрагмент назви" />
</div>

<div class="mb-3">
    <label class="form-label">Фільтр за статусом:</label>
    <select class="form-select" @bind="selectedStatusString">
        <option value="">Всі статуси</option>
        @foreach (var st in allStatuses)
        {
            <option value="@st.ToString()">@RequestStatusLocalizer.Localize(st)</option>
        }
    </select>
</div>

@if (requests == null)
{
    <p>Завантаження...</p>
}
else
{
    var filtered = GetFilteredRequests();
    if (!filtered.Any())
    {
        <p>Немає заявок для відображення</p>
    }
    else
    {
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Назва заявки</th>
                    <th>Статус заявки</th>
                    <th>Дата створення</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in filtered)
                {
                    <tr>
                        <td>@r.Title</td>
                        <td>@RequestStatusLocalizer.Localize(r.Status)</td>
                        <td>@r.CreationDate.ToLocalTime()</td>
                        <td>
                            @if (r.Status == RequestStatus.Draft)
                            {
                                <!-- Кнопка "Завершити створення" -->
                                <button class="btn btn-primary btn-sm me-2"
                                        @onclick="() => ContinueCreating(r.RequestId)">
                                    Завершити створення
                                </button>

                                <!-- Кнопка "Видалити чернетку" -->
                                <button class="btn btn-danger btn-sm"
                                        @onclick="() => DeleteDraft(r.RequestId)">
                                    Видалити чернетку
                                </button>
                            }
                            else
                            {
                                <!-- Якщо не Draft, то показуємо "Переглянути" -->
                                <button class="btn btn-primary btn-sm"
                                        @onclick="() => ViewRequest(r.RequestId)">
                                    Переглянути
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@code {
    private List<RequestDTO>? requests;
    private string? message;

    // Поле для пошуку за назвою
    private string? searchTitle;

    // Випадаючий список доступних статусів (у вигляді Enums)
    private List<RequestStatus> allStatuses = new()
    {
        RequestStatus.Draft,
        RequestStatus.PendingDepartmentHead,
        RequestStatus.PendingEconomist,
        RequestStatus.Approved,
        RequestStatus.Rejected
    };

    // Який статус обрано зараз у селекті
    private string? selectedStatusString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadRequestsAsync();
    }

    private async Task LoadRequestsAsync()
    {
        message = null;
        try
        {
            // Завантаження списку заявок (всіх, які належать поточному юзеру)
            requests = await Http.GetFromJsonAsync<List<RequestDTO>>("api/request/my");
        }
        catch (Exception ex)
        {
            message = $"Помилка завантаження: {ex.Message}";
        }
    }

    // Метод для відкриття деталів заявки
    private void ViewRequest(int requestId)
    {
        Navigation.NavigateTo($"/request-details/{requestId}");
    }

    // Метод "Завершити створення" – знову відкриваємо форму create-request з query-параметром
    private void ContinueCreating(int draftId)
    {
        Navigation.NavigateTo($"/create-request?draftId={draftId}");
    }

    // Видалення чернетки
    private async Task DeleteDraft(int requestId)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm",
            new object?[] { "Ви впевнені, що хочете видалити цю чернетку?" });
        if (!confirm) return;

        var response = await Http.DeleteAsync($"api/request/draft/{requestId}");
        if (response.IsSuccessStatusCode)
        {
            requests?.RemoveAll(r => r.RequestId == requestId);
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            message = $"Помилка видалення: {err}";
        }
    }

    // Фільтрація списку заявок
    private IEnumerable<RequestDTO> GetFilteredRequests()
    {
        if (requests == null)
            return Enumerable.Empty<RequestDTO>();

        var query = requests.AsEnumerable();

        // 1) Пошук за назвою
        if (!string.IsNullOrWhiteSpace(searchTitle))
        {
            var lowerSearch = searchTitle.ToLower();
            query = query.Where(r => (r.Title ?? "").ToLower().Contains(lowerSearch));
        }

        // 2) Фільтр за статусом
        if (!string.IsNullOrEmpty(selectedStatusString))
        {
            if (Enum.TryParse<RequestStatus>(selectedStatusString, out var parsedStatus))
            {
                query = query.Where(r => r.Status == parsedStatus);
            }
        }

        return query;
    }
}


--- File: NetNeedsList.razor (Path: .\AutomationOfPurchases.Client\Pages\NetNeedsList.razor) ---

﻿@page "/net-needs"
@attribute [Authorize(Roles = "Economist")]
@inject HttpClient Http

@using System.Net.Http.Json
@using AutomationOfPurchases.Shared.DTOs

<h3>Таблиця чистих потреб</h3>

<button class="btn btn-secondary mb-3" @onclick="ToggleFilter">
    @(showFilter ? "Сховати фільтр" : "Фільтрація")
</button>

@if (showFilter)
{
    <div class="border p-3 mb-3">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Назва ТМЦ</label>
                <input class="form-control"
                       @bind="filterTmc"
                       @bind:event="oninput"
                       placeholder="Введіть назву..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">Департамент</label>
                <input class="form-control"
                       @bind="filterDept"
                       @bind:event="oninput"
                       placeholder="Введіть відділ..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">Замовник</label>
                <input class="form-control"
                       @bind="filterUser"
                       @bind:event="oninput"
                       placeholder="ПІБ замовника..." />
            </div>
        </div>

        <button class="btn btn-primary mt-3" @onclick="ApplyFilter">
            Застосувати
        </button>
    </div>
}

@if (lists == null)
{
    <p>Завантаження...</p>
}
else if (!lists.Any())
{
    <p>Немає списків у чистих потребах.</p>
}
else
{
    @foreach (var list in filteredLists)
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3">Чисті потреби (ID=@list.ListId)</h5>
                <p>Створено: @list.CreationDate</p>

                <table class="table table-sm align-middle table-striped table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ТМЦ</th>
                            <th style="width:100px;">Одиниця</th>
                            <th style="width:130px;">Кількість</th>
                            <th style="width:100px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ag in list.AggregatedItems)
                        {
                            <tr>
                                <td><strong>@ag.ItemName</strong></td>
                                <td>@ag.StorageUnit</td>
                                <td>@ag.TotalQuantity</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary"
                                            @onclick="@(() => ToggleExpand(ag))">
                                        @(ag.IsExpanded ? "Сховати" : "Розкрити")
                                    </button>
                                </td>
                            </tr>

                            @if (ag.IsExpanded)
                            {
                                <tr>
                                    <td colspan="4">
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Замовник</th>
                                                    <th>Відділ</th>
                                                    <th>Кількість</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var d in ag.Details)
                                                {
                                                    <tr>
                                                        <td>@d.OrderedByFullName</td>
                                                        <td>@d.DepartmentName</td>
                                                        <td>@d.Quantity</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    private List<NetNeedsListExpandedDTO>? lists;
    private List<NetNeedsListExpandedDTO> filteredLists = new();

    private bool showFilter = false;
    private string filterTmc = "";
    private string filterDept = "";
    private string filterUser = "";

    protected override async Task OnInitializedAsync()
    {
        // GET /api/netneeds/expanded
        lists = await Http.GetFromJsonAsync<List<NetNeedsListExpandedDTO>>("api/netneeds/expanded")
                ?? new List<NetNeedsListExpandedDTO>();

        filteredLists = lists;
    }

    private void ToggleFilter() => showFilter = !showFilter;

    private void ApplyFilter()
    {
        if (lists == null) return;

        var query = lists.AsEnumerable();

        // 1) Фільтр за назвою ТМЦ
        if (!string.IsNullOrWhiteSpace(filterTmc))
        {
            var lowerTmc = filterTmc.ToLower();
            query = query
                .Select(l =>
                {
                    var filteredAgg = l.AggregatedItems
                        .Where(ag => ag.ItemName.ToLower().Contains(lowerTmc))
                        .ToList();

                    return new NetNeedsListExpandedDTO
                        {
                            ListId = l.ListId,
                            CreationDate = l.CreationDate,
                            NullificationDate = l.NullificationDate,
                            AggregatedItems = filteredAgg
                        };
                })
                .Where(l => l.AggregatedItems.Any());
        }

        // 2) Фільтр за департаментом
        if (!string.IsNullOrWhiteSpace(filterDept))
        {
            var lowerDept = filterDept.ToLower();
            query = query
                .Select(l =>
                {
                    var newAgg = l.AggregatedItems
                        .Select(ag =>
                        {
                            var newDetails = ag.Details
                                .Where(d => d.DepartmentName.ToLower().Contains(lowerDept))
                                .ToList();

                            return new NetAggregatedItemDTO
                                {
                                    ItemId = ag.ItemId,
                                    ItemName = ag.ItemName,
                                    StorageUnit = ag.StorageUnit,
                                    TotalQuantity = ag.TotalQuantity,
                                    IsExpanded = ag.IsExpanded,
                                    Details = newDetails
                                };
                        })
                        .Where(ag => ag.Details.Any())
                        .ToList();

                    return new NetNeedsListExpandedDTO
                        {
                            ListId = l.ListId,
                            CreationDate = l.CreationDate,
                            NullificationDate = l.NullificationDate,
                            AggregatedItems = newAgg
                        };
                })
                .Where(x => x.AggregatedItems.Any());
        }

        // 3) Фільтр за замовником
        if (!string.IsNullOrWhiteSpace(filterUser))
        {
            var lowerUser = filterUser.ToLower();
            query = query
                .Select(l =>
                {
                    var newAgg = l.AggregatedItems
                        .Select(ag =>
                        {
                            var newDetails = ag.Details
                                .Where(d => d.OrderedByFullName.ToLower().Contains(lowerUser))
                                .ToList();

                            return new NetAggregatedItemDTO
                                {
                                    ItemId = ag.ItemId,
                                    ItemName = ag.ItemName,
                                    StorageUnit = ag.StorageUnit,
                                    TotalQuantity = ag.TotalQuantity,
                                    IsExpanded = ag.IsExpanded,
                                    Details = newDetails
                                };
                        })
                        .Where(ag => ag.Details.Any())
                        .ToList();

                    return new NetNeedsListExpandedDTO
                        {
                            ListId = l.ListId,
                            CreationDate = l.CreationDate,
                            NullificationDate = l.NullificationDate,
                            AggregatedItems = newAgg
                        };
                })
                .Where(l => l.AggregatedItems.Any());
        }

        filteredLists = query.ToList();
    }

    private void ToggleExpand(NetAggregatedItemDTO ag)
    {
        ag.IsExpanded = !ag.IsExpanded;
    }
}


--- File: RequestDetails.razor (Path: .\AutomationOfPurchases.Client\Pages\RequestDetails.razor) ---

﻿@page "/request-details/{requestId:int}"
@attribute [Authorize]

@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@using AutomationOfPurchases.Shared.DTOs
@using AutomationOfPurchases.Shared.Enums
@using AutomationOfPurchases.Shared.Localization

<h3>Деталі заявки</h3>

@if (request == null)
{
    <p>Завантаження заявки...</p>
}
else
{
    <!-- Основна картка з інформацією про заявку -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h4 class="card-title">@request.Title</h4>
            <p class="card-text text-muted">@request.Description</p>

            <p>
                <strong>Статус:</strong>
                <span class="badge @(GetStatusBadgeClass(request.Status))">
                    @RequestStatusLocalizer.Localize(request.Status)
                </span>
            </p>

            @if (request.Status == RequestStatus.Approved && isAuthor)
            {
                <div class="alert alert-info">
                    Заявка пройшла процедуру затвердження, очікуйте повідомлення про деталі доставки.
                </div>
            }

            <p>
                <strong>Дата створення:</strong>
                @request.CreationDate.ToString("dd.MM.yyyy HH:mm:ss")
            </p>
            <p>
                <strong>Створено користувачем:</strong>
                @request.OrderedByFullName (@request.OrderedByEmail)
            </p>
            <p>
                <strong>Відділ замовника:</strong>
                @request.OrderedByDepartmentName
            </p>

            @if (!string.IsNullOrEmpty(request.DepartmentHeadApproverId))
            {
                <p>
                    Затверджено керівником:
                    <strong>@request.DepartmentHeadApproverFullName</strong>
                </p>
            }

            @if (!string.IsNullOrEmpty(request.EconomistApproverId))
            {
                <p>
                    Затверджено економістом:
                    <strong>@request.EconomistApproverFullName</strong>
                </p>
            }

            @if (request.Status == RequestStatus.Rejected)
            {
                <p>
                    Відхилено користувачем:
                    <strong>@request.RejectedByUserFullName</strong>
                </p>
                <p>
                    Причина відхилення:
                    <em>@request.RejectionReason</em>
                </p>
            }
        </div>
    </div>

    <!-- ТМЦ у цій заявці -->
    <h5>ТМЦ у цій заявці</h5>
    @if (request.Items == null || request.Items.Count == 0)
    {
        <p>Поки що немає доданих ТМЦ</p>
    }
    else
    {
        <table class="table table-striped table-bordered table-sm align-middle">
            <thead class="table-light">
                <tr>
                    <th>ТМЦ (Item)</th>
                    <th style="width:100px;">Кількість</th>
                    @if (request.Status == RequestStatus.Approved)
                    {
                        <th style="width:230px;">Зі складу / На закупівлю</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in request.Items)
                {
                    <tr>
                        <td>
                            <strong>@item.Item?.ItemName</strong>
                            <small class="text-muted">(@item.Item?.StorageUnit)</small>
                        </td>
                        <td>@item.Quantity</td>
                        @if (request.Status == RequestStatus.Approved)
                        {
                            <td>
                                @item.DeliveredQuantity / @item.ToPurchaseQuantity
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- Кнопки дій для керівника або економіста -->
    <div class="mt-3">
        @* Для керівника відділу *@
        @if (isDepartmentHead
       && request.Status == RequestStatus.PendingDepartmentHead)
        {
            <button class="btn btn-success me-2" @onclick="ApproveAsDepartmentHead">
                Затвердити
            </button>
            <button class="btn btn-danger" @onclick="RejectAsDepartmentHead">
                Відхилити
            </button>
        }
        @* Для економіста - 
           1) користувач має роль економіста
           2) бекенд сказав request.CanApproveAsEconomist = true
           3) user не є автором заявки
           4) статус заявки PendingEconomist *@
        else if (isEconomist
        && request.CanApproveAsEconomist
        && request.Status == RequestStatus.PendingEconomist)
        {
            <button class="btn btn-success me-2" @onclick="ApproveAsEconomist">
                Затвердити
            </button>
            <button class="btn btn-danger" @onclick="RejectAsEconomist">
                Відхилити
            </button>
        }
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@code {
    [Parameter] public int requestId { get; set; }
    private RequestDTO? request;
    private string? message;

    // Флаги ролей
    private bool isDepartmentHead = false;
    private bool isEconomist = false;
    private bool isAuthor = false;

    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        // 1) Отримуємо стан автентифікації
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // 2) userId (NameIdentifier)
        currentUserId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        // 3) Визначаємо ролі
        isDepartmentHead = user.IsInRole("DepartmentHead");
        isEconomist = user.IsInRole("Economist");

        // 4) Завантажуємо заявку
        await LoadRequestAsync();

        // 5) Якщо заявку отримано — визначаємо, чи автор
        if (request != null && request.OrderedById == currentUserId)
        {
            isAuthor = true;
        }
    }

    private async Task LoadRequestAsync()
    {
        try
        {
            // Якщо ви керівник чи економіст,
            // можете викликати один ендпоінт: "api/request/{requestId}"
            // Якщо автор — інший: "api/request/my/{requestId}"
            // (або ж сервер сам вирішує, що повертати)
            string url = (isDepartmentHead || isEconomist)
                ? $"api/request/{requestId}"
                : $"api/request/my/{requestId}";

            request = await Http.GetFromJsonAsync<RequestDTO>(url);
        }
        catch (Exception ex)
        {
            message = "Помилка завантаження заявки: " + ex.Message;
        }
    }

    private string GetStatusBadgeClass(RequestStatus status)
    {
        return status switch
        {
            RequestStatus.Draft => "bg-secondary",
            RequestStatus.PendingDepartmentHead => "bg-warning text-dark",
            RequestStatus.PendingEconomist => "bg-warning text-dark",
            RequestStatus.Approved => "bg-success",
            RequestStatus.Rejected => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task ApproveAsDepartmentHead()
    {
        if (request == null) return;
        try
        {
            var confirm = await JSRuntime.InvokeAsync<bool>(
                "confirm",
                "Ви дійсно бажаєте затвердити цю заявку?"
            );
            if (!confirm) return;

            var response = await Http.PutAsync($"api/request/{requestId}/approve", null);
            if (response.IsSuccessStatusCode)
            {
                message = "Заявку успішно затверджено керівником.";
                await LoadRequestAsync();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                message = $"Помилка при затвердженні: {err}";
            }
        }
        catch (Exception ex)
        {
            message = $"Помилка: {ex.Message}";
        }
    }

    private async Task RejectAsDepartmentHead()
    {
        if (request == null) return;
        var reason = await JSRuntime.InvokeAsync<string>("prompt", "Вкажіть причину відхилення:");
        if (string.IsNullOrWhiteSpace(reason)) return;

        var rejectObj = new { Reason = reason };
        var response = await Http.PutAsJsonAsync($"api/request/{requestId}/reject", rejectObj);
        if (response.IsSuccessStatusCode)
        {
            message = "Заявку відхилено керівником.";
            await LoadRequestAsync();
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            message = $"Помилка відхилення: {err}";
        }
    }

    private async Task ApproveAsEconomist()
    {
        if (request == null) return;
        try
        {
            var confirm = await JSRuntime.InvokeAsync<bool>(
                "confirm",
                "Ви дійсно бажаєте затвердити цю заявку як економіст?"
            );
            if (!confirm) return;

            var response = await Http.PutAsync($"api/request/{requestId}/approve-economist", null);
            if (response.IsSuccessStatusCode)
            {
                message = "Заявку успішно затверджено економістом.";
                await LoadRequestAsync();
            }
            else
            {
                var err = await response.Content.ReadAsStringAsync();
                message = $"Помилка при затвердженні: {err}";
            }
        }
        catch (Exception ex)
        {
            message = $"Помилка: {ex.Message}";
        }
    }

    private async Task RejectAsEconomist()
    {
        if (request == null) return;
        var reason = await JSRuntime.InvokeAsync<string>("prompt", "Вкажіть причину відхилення:");
        if (string.IsNullOrWhiteSpace(reason)) return;

        var rejectObj = new { Reason = reason };
        var response = await Http.PutAsJsonAsync($"api/request/{requestId}/reject-economist", rejectObj);
        if (response.IsSuccessStatusCode)
        {
            message = "Заявку відхилено економістом.";
            await LoadRequestAsync();
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            message = $"Помилка відхилення: {err}";
        }
    }
}

--- File: WarehouseGroupedNeeds.razor (Path: .\AutomationOfPurchases.Client\Pages\WarehouseGroupedNeeds.razor) ---

﻿@page "/warehouse-grouped"
@attribute [Authorize(Roles = "WarehouseWorker")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime

@using AutomationOfPurchases.Shared.DTOs

<h3>Список загальних потреб</h3>

<!-- Перемикач фільтра: -->
<button class="btn btn-secondary mb-3" @onclick="ToggleFilter">
    @(showFilter ? "Сховати фільтр" : "Фільтрація")
</button>

@if (showFilter)
{
    <div class="border p-3 mb-3">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Назва ТМЦ</label>
                <input class="form-control"
                       @bind="filterTmc"
                       @bind:event="oninput"
                       placeholder="Введіть назву..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">Департамент</label>
                <input class="form-control"
                       @bind="filterDept"
                       @bind:event="oninput"
                       placeholder="Введіть відділ..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">Замовник</label>
                <input class="form-control"
                       @bind="filterUser"
                       @bind:event="oninput"
                       placeholder="ПІБ замовника..." />
            </div>
        </div>

        <button class="btn btn-primary mt-3" @onclick="ApplyFilter">
            Застосувати
        </button>
    </div>
}

@if (groupedNeeds == null)
{
    <p>Завантаження...</p>
}
else if (!groupedNeeds.Any())
{
    <p>Немає активного списку потреб або він порожній.</p>
}
else
{
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            @foreach (var group in filteredNeeds)
            {
                <table class="table table-striped table-bordered table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ТМЦ (ItemName)</th>
                            <th style="width:100px;">Одиниця</th>
                            <th style="width:120px;">Загальна</th>
                            <th style="width:120px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>@group.ItemName</strong></td>
                            <td>@group.StorageUnit</td>
                            <td>@group.TotalQuantity</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => ToggleExpand(group))">
                                    @(group.IsExpanded ? "Сховати" : "Розкрити")
                                </button>
                            </td>
                        </tr>

                        @if (group.IsExpanded)
                        {
                            <tr>
                                <td colspan="4">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Відділ</th>
                                                <th>Замовник</th>
                                                <th>Кількість</th>
                                                <th>Дії</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var req in group.Requests)
                                            {
                                                <tr>
                                                    <td>@req.DepartmentName</td>
                                                    <td>@req.OrderedByFullName</td>
                                                    <td>@req.Quantity</td>
                                                    <td>
                                                        <button class="btn btn-sm btn-success me-2"
                                                                @onclick="() => SatisfyRequest(req, group)">
                                                            Задовольнити
                                                        </button>
                                                        <button class="btn btn-sm btn-warning"
                                                                @onclick="() => MarkNotAvailable(req, group)">
                                                            Відсутня
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
}

@code {
    private List<GroupedNeedDTO>? groupedNeeds;
    private List<GroupedNeedDTO> filteredNeeds = new();

    // Фільтр
    private bool showFilter = false;
    private string filterTmc = "";
    private string filterDept = "";
    private string filterUser = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadGroupedNeedsAsync();
    }

    private async Task LoadGroupedNeedsAsync()
    {
        groupedNeeds = await Http.GetFromJsonAsync<List<GroupedNeedDTO>>("api/warehouse/grouped-needs");
        filteredNeeds = groupedNeeds ?? new List<GroupedNeedDTO>();
    }

    private void ToggleFilter() => showFilter = !showFilter;

    private void ApplyFilter()
    {
        if (groupedNeeds == null) return;

        var query = groupedNeeds.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(filterTmc))
        {
            var tmcLow = filterTmc.ToLower();
            query = query.Where(g => (g.ItemName ?? "").ToLower().Contains(tmcLow));
        }
        if (!string.IsNullOrWhiteSpace(filterDept))
        {
            var deptLow = filterDept.ToLower();
            query = query
                .Select(g =>
                {
                    var newRequests = g.Requests
                        .Where(r => r.DepartmentName.ToLower().Contains(deptLow))
                        .ToList();
                    return new GroupedNeedDTO
                        {
                            ItemId = g.ItemId,
                            ItemName = g.ItemName,
                            StorageUnit = g.StorageUnit,
                            TotalQuantity = g.TotalQuantity,
                            IsExpanded = g.IsExpanded,
                            Requests = newRequests
                        };
                })
                .Where(g => g.Requests.Any());
        }
        if (!string.IsNullOrWhiteSpace(filterUser))
        {
            var userLow = filterUser.ToLower();
            query = query
                .Select(g =>
                {
                    var newReq = g.Requests
                        .Where(r => r.OrderedByFullName.ToLower().Contains(userLow))
                        .ToList();
                    return new GroupedNeedDTO
                        {
                            ItemId = g.ItemId,
                            ItemName = g.ItemName,
                            StorageUnit = g.StorageUnit,
                            TotalQuantity = g.TotalQuantity,
                            IsExpanded = g.IsExpanded,
                            Requests = newReq
                        };
                })
                .Where(g => g.Requests.Any());
        }

        filteredNeeds = query.ToList();
    }

    private void ToggleExpand(GroupedNeedDTO group)
    {
        group.IsExpanded = !group.IsExpanded;
    }

    private async Task SatisfyRequest(DepartmentRequestDTO req, GroupedNeedDTO group)
    {
        // Prompt для кількості
        var qtyStr = await JSRuntime.InvokeAsync<string>("prompt", $"Вкажіть кількість (макс: {req.Quantity}):", req.Quantity.ToString());
        if (!int.TryParse(qtyStr, out int qty) || qty <= 0 || qty > req.Quantity)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Невірна кількість.");
            return;
        }

        // Prompt для назви складу
        var warehouseName = await JSRuntime.InvokeAsync<string>("prompt", "Назва складу:", "Основний склад");
        if (string.IsNullOrWhiteSpace(warehouseName))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Склад не може бути порожнім.");
            return;
        }

        // Формуємо SatisfyNeedModel
        var model = new SatisfyNeedModel
            {
            // Тепер RequestItemId в DepartmentRequestDTO зберігає саме GeneralNeedsItemId
                GeneralNeedsItemId = req.RequestItemId,
                QuantityToSatisfy = qty,
                WarehouseName = warehouseName,
                IsNotAvailable = false
            };

        var response = await Http.PostAsJsonAsync("api/warehouse/satisfy", model);
        if (response.IsSuccessStatusCode)
        {
            var msg = await response.Content.ReadAsStringAsync();
            await JSRuntime.InvokeVoidAsync("alert", msg);
            // Перезавантажимо список
            await LoadGroupedNeedsAsync();
            ApplyFilter(); // якщо треба фільтр
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            await JSRuntime.InvokeVoidAsync("alert", $"Помилка: {err}");
        }
    }

    private async Task MarkNotAvailable(DepartmentRequestDTO req, GroupedNeedDTO group)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Позначити як відсутня?");
        if (!confirm) return;

        var model = new SatisfyNeedModel
            {
                GeneralNeedsItemId = req.RequestItemId,
                QuantityToSatisfy = 0,
                WarehouseName = "",
                IsNotAvailable = true
            };

        var response = await Http.PostAsJsonAsync("api/warehouse/satisfy", model);
        if (response.IsSuccessStatusCode)
        {
            var msg = await response.Content.ReadAsStringAsync();
            await JSRuntime.InvokeVoidAsync("alert", msg);
            await LoadGroupedNeedsAsync();
            ApplyFilter();
        }
        else
        {
            var err = await response.Content.ReadAsStringAsync();
            await JSRuntime.InvokeVoidAsync("alert", $"Помилка: {err}");
        }
    }
}


--- File: launchSettings.json (Path: .\AutomationOfPurchases.Client\Properties\launchSettings.json) ---

{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:38109",
      "sslPort": 44358
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "inspectUri": "{wsProtocol}://{url.hostname}:{url.port}/_framework/debug/ws-proxy?browser={browserInspectUri}",
      "applicationUrl": "http://localhost:5249",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "inspectUri": "{wsProtocol}://{url.hostname}:{url.port}/_framework/debug/ws-proxy?browser={browserInspectUri}",
      "applicationUrl": "https://localhost:7018;http://localhost:5249",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "inspectUri": "{wsProtocol}://{url.hostname}:{url.port}/_framework/debug/ws-proxy?browser={browserInspectUri}",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}


--- File: RedirectToLogin.razor (Path: .\AutomationOfPurchases.Client\Shared\RedirectToLogin.razor) ---

﻿@inject NavigationManager Navigation
@namespace AutomationOfPurchases.Client.Shared

@code {
    protected override void OnInitialized()
    {
        // Просто перенаправляємо користувача на сторінку логіну
        Navigation.NavigateTo("/login", true);
    }
}


--- File: RedirectToNotifications.razor (Path: .\AutomationOfPurchases.Client\Shared\RedirectToNotifications.razor) ---

﻿@page "/"
@inject NavigationManager Navigation

@code {
    protected override void OnInitialized()
    {
        Navigation.NavigateTo("/notifications", true);
    }
}


--- File: RequestStatusLocalizer.cs (Path: .\AutomationOfPurchases.Client\Shared\RequestStatusLocalizer.cs) ---

﻿using AutomationOfPurchases.Shared.Enums;

namespace AutomationOfPurchases.Shared.Localization
{
    /// Статичний клас для перекладу англомовного статусу (enum) на український рядок для відображення.
    public static class RequestStatusLocalizer
    {
        public static string Localize(RequestStatus status)
        {
            return status switch
            {
                RequestStatus.Draft => "Чернетка",
                RequestStatus.PendingDepartmentHead => "Очікується затвердження керівника",
                RequestStatus.PendingEconomist => "Очікується затвердження економіста",
                RequestStatus.Approved => "Затверджено",
                RequestStatus.Rejected => "Відхилено",
                _ => status.ToString()
            };
        }
    }
}


--- File: icon-192.png (Path: .\AutomationOfPurchases.Client\wwwroot\icon-192.png) ---

--- File: index.html (Path: .\AutomationOfPurchases.Client\wwwroot\index.html) ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutomationOfPurchases.Client</title>
    <base href="/" />

    <!-- Ваш app.css (якщо треба) -->
    <link rel="stylesheet" href="css/app.css" />

    <!-- **Bootstrap CSS** -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <!-- Blazor WebAssembly Script -->
    <script src="_framework/blazor.webassembly.js"></script>

    <!-- **Bootstrap JS** -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>

--- File: app.css (Path: .\AutomationOfPurchases.Client\wwwroot\css\app.css) ---

.valid.modified:not([type=checkbox]) {
    outline: 1px solid #26b050;
}

.invalid {
    outline: 1px solid red;
}

.validation-message {
    color: red;
}

#blazor-error-ui {
    background: lightyellow;
    bottom: 0;
    box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
    display: none;
    left: 0;
    padding: 0.6rem 1.25rem 0.7rem 1.25rem;
    position: fixed;
    width: 100%;
    z-index: 1000;
}

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }

.blazor-error-boundary {
    background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNDkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIG92ZXJmbG93PSJoaWRkZW4iPjxkZWZzPjxjbGlwUGF0aCBpZD0iY2xpcDAiPjxyZWN0IHg9IjIzNSIgeT0iNTEiIHdpZHRoPSI1NiIgaGVpZ2h0PSI0OSIvPjwvY2xpcFBhdGg+PC9kZWZzPjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMCkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMzUgLTUxKSI+PHBhdGggZD0iTTI2My41MDYgNTFDMjY0LjcxNyA1MSAyNjUuODEzIDUxLjQ4MzcgMjY2LjYwNiA1Mi4yNjU4TDI2Ny4wNTIgNTIuNzk4NyAyNjcuNTM5IDUzLjYyODMgMjkwLjE4NSA5Mi4xODMxIDI5MC41NDUgOTIuNzk1IDI5MC42NTYgOTIuOTk2QzI5MC44NzcgOTMuNTEzIDI5MSA5NC4wODE1IDI5MSA5NC42NzgyIDI5MSA5Ny4wNjUxIDI4OS4wMzggOTkgMjg2LjYxNyA5OUwyNDAuMzgzIDk5QzIzNy45NjMgOTkgMjM2IDk3LjA2NTEgMjM2IDk0LjY3ODIgMjM2IDk0LjM3OTkgMjM2LjAzMSA5NC4wODg2IDIzNi4wODkgOTMuODA3MkwyMzYuMzM4IDkzLjAxNjIgMjM2Ljg1OCA5Mi4xMzE0IDI1OS40NzMgNTMuNjI5NCAyNTkuOTYxIDUyLjc5ODUgMjYwLjQwNyA1Mi4yNjU4QzI2MS4yIDUxLjQ4MzcgMjYyLjI5NiA1MSAyNjMuNTA2IDUxWk0yNjMuNTg2IDY2LjAxODNDMjYwLjczNyA2Ni4wMTgzIDI1OS4zMTMgNjcuMTI0NSAyNTkuMzEzIDY5LjMzNyAyNTkuMzEzIDY5LjYxMDIgMjU5LjMzMiA2OS44NjA4IDI1OS4zNzEgNzAuMDg4N0wyNjEuNzk1IDg0LjAxNjEgMjY1LjM4IDg0LjAxNjEgMjY3LjgyMSA2OS43NDc1QzI2Ny44NiA2OS43MzA5IDI2Ny44NzkgNjkuNTg3NyAyNjcuODc5IDY5LjMxNzkgMjY3Ljg3OSA2Ny4xMTgyIDI2Ni40NDggNjYuMDE4MyAyNjMuNTg2IDY2LjAxODNaTTI2My41NzYgODYuMDU0N0MyNjEuMDQ5IDg2LjA1NDcgMjU5Ljc4NiA4Ny4zMDA1IDI1OS43ODYgODkuNzkyMSAyNTkuNzg2IDkyLjI4MzcgMjYxLjA0OSA5My41Mjk1IDI2My41NzYgOTMuNTI5NSAyNjYuMTE2IDkzLjUyOTUgMjY3LjM4NyA5Mi4yODM3IDI2Ny4zODcgODkuNzkyMSAyNjcuMzg3IDg3LjMwMDUgMjY2LjExNiA4Ni4wNTQ3IDI2My41NzYgODYuMDU0N1oiIGZpbGw9IiNGRkU1MDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvZz48L3N2Zz4=) no-repeat 1rem/1.8rem, #b32121;
    padding: 1rem 1rem 1rem 3.7rem;
    color: white;
}

    .blazor-error-boundary::after {
        content: "An error has occurred."
    }

.loading-progress {
    position: relative;
    display: block;
    width: 8rem;
    height: 8rem;
    margin: 20vh auto 1rem auto;
}

    .loading-progress circle {
        fill: none;
        stroke: #e0e0e0;
        stroke-width: 0.6rem;
        transform-origin: 50% 50%;
        transform: rotate(-90deg);
    }

        .loading-progress circle:last-child {
            stroke: #1b6ec2;
            stroke-dasharray: calc(3.141 * var(--blazor-load-percentage, 0%) * 0.8), 500%;
            transition: stroke-dasharray 0.05s ease-in-out;
        }

.loading-progress-text {
    position: absolute;
    text-align: center;
    font-weight: bold;
    inset: calc(20vh + 3.25rem) 0 auto 0.2rem;
}

    .loading-progress-text:after {
        content: var(--blazor-load-percentage-text, "Loading");
    }

code {
    color: #c02d76;
}


--- File: DeliveryRequestDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\DeliveryRequestDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class DeliveryRequestDTO
    {
        public int DeliveryRequestId { get; set; }

        public int ItemId { get; set; }
        public ItemDTO? Item { get; set; }

        public int Quantity { get; set; }

        public string? OrderedById { get; set; }
        public UserDTO? OrderedBy { get; set; }

        public string Warehouse { get; set; } = string.Empty;

        public int? RequestItemId { get; set; }

        // Поля для відображення на фронті (DeliveryRequests.razor):
        public string ItemName { get; set; } = "";
        public string OrderedByFullName { get; set; } = "";
        public string OrderedByDepartmentName { get; set; } = "";
        public string OrderedByEmail { get; set; } = "";
    }
}


--- File: DepartmentDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\DepartmentDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class DepartmentDTO
    {
        public int DepartmentId { get; set; }
        public string DepartmentName { get; set; } = string.Empty;

        // Змінили тип з int? на string?
        public string? HeadOfDepartmentId { get; set; }
        public UserDTO? HeadOfDepartment { get; set; }

        public int FreeCapital { get; set; }

        // За потреби можна включити сюди список економістів
        // public List<UserDTO> Economists { get; set; } = new();
    }
}


--- File: GeneralNeedsExpandedDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\GeneralNeedsExpandedDTO.cs) ---

﻿public class GeneralNeedsListExpandedDTO
{
    public int ListId { get; set; }
    public DateTime CreationDate { get; set; }
    public DateTime? NullificationDate { get; set; }

    public List<GeneralAggregatedItemDTO> AggregatedItems { get; set; } = new();
}

public class GeneralAggregatedItemDTO
{
    public int ItemId { get; set; }
    public string ItemName { get; set; } = "";
    public string StorageUnit { get; set; } = "";
    public int TotalQuantity { get; set; }
    public bool IsExpanded { get; set; } = false;

    public List<GeneralDetailDTO> Details { get; set; } = new();
}

public class GeneralDetailDTO
{
    public int RequestItemId { get; set; }
    public string OrderedByFullName { get; set; } = "";
    public string DepartmentName { get; set; } = "";
    public int Quantity { get; set; }
}


--- File: GeneralNeedsItemDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\GeneralNeedsItemDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    /// <summary>
    /// Відповідає запису в таблиці GeneralNeedsItem 
    /// (копія даних для Загальних Потреб).
    /// </summary>
    public class GeneralNeedsItemDTO
    {
        public int GeneralNeedsItemId { get; set; }

        // Посилання на список GeneralNeedsList
        public int GeneralNeedsListId { get; set; }

        // Посилання на Item
        public int ItemId { get; set; }
        public ItemDTO? Item { get; set; }

        // Скільки потрібно (поза складом)
        public int Quantity { get; set; }

        // Хто був автором у оригінальній заявці
        public string? OrderedById { get; set; }
        public UserDTO? OrderedBy { get; set; }

        // За бажання: щоб знати, з якого оригінального RequestItem це скопійовано
        public int? OriginalRequestItemId { get; set; }
        // Можна додати public RequestItemDTO? OriginalRequestItem { get; set; }
        // якщо потрібен детальніший зв’язок
    }
}


--- File: GeneralNeedsListDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\GeneralNeedsListDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class GeneralNeedsListDTO
    {
        public int ListId { get; set; }
        public DateTime CreationDate { get; set; }
        public DateTime? NullificationDate { get; set; }

        public List<GeneralNeedsItemDTO> Items { get; set; } = new();
    }
}


--- File: ItemDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\ItemDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class ItemDTO
    {
        public int ItemId { get; set; }
        public string ItemName { get; set; } = string.Empty;
        public string StorageUnit { get; set; } = string.Empty;
    }
}


--- File: NetNeedsExpandedDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\NetNeedsExpandedDTO.cs) ---

﻿public class NetNeedsListExpandedDTO
{
    public int ListId { get; set; }
    public DateTime CreationDate { get; set; }
    public DateTime? NullificationDate { get; set; }

    public List<NetAggregatedItemDTO> AggregatedItems { get; set; } = new();
}

public class NetAggregatedItemDTO
{
    public int ItemId { get; set; }
    public string ItemName { get; set; } = "";
    public string StorageUnit { get; set; } = "";
    public int TotalQuantity { get; set; }
    public bool IsExpanded { get; set; } = false;

    public List<NetDetailDTO> Details { get; set; } = new();
}

public class NetDetailDTO
{
    public int RequestItemId { get; set; }
    public string OrderedByFullName { get; set; } = "";
    public string DepartmentName { get; set; } = "";
    public int Quantity { get; set; }
}


--- File: NetNeedsItemDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\NetNeedsItemDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    /// <summary>
    /// Відповідає запису в таблиці NetNeedsItem
    /// (копія даних для Чистих Потреб).
    /// </summary>
    public class NetNeedsItemDTO
    {
        public int NetNeedsItemId { get; set; }

        // Посилання на список NetNeedsList
        public int NetNeedsListId { get; set; }

        // Посилання на Item
        public int ItemId { get; set; }
        public ItemDTO? Item { get; set; }

        // Скільки потрібно
        public int Quantity { get; set; }

        // Хто був автором у оригінальній заявці
        public string? OrderedById { get; set; }
        public UserDTO? OrderedBy { get; set; }

        // За бажання: посилання на оригінал
        public int? OriginalRequestItemId { get; set; }
    }
}


--- File: NetNeedsListDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\NetNeedsListDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class NetNeedsListDTO
    {
        public int ListId { get; set; }
        public DateTime CreationDate { get; set; }
        public DateTime? NullificationDate { get; set; }

        public List<NetNeedsItemDTO> Items { get; set; } = new();
    }
}


--- File: NotificationDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\NotificationDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class NotificationDTO
    {
        public int NotificationId { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Message { get; set; }
        public bool IsRead { get; set; }
        public DateTime CreatedAt { get; set; }
        public string? LinkUrl { get; set; }

        // Додаємо таке саме поле Category
        public string? Category { get; set; }

        public int? RequestId { get; set; }
    }
}


--- File: RejectModel.cs (Path: .\AutomationOfPurchases.Shared\DTOs\RejectModel.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class RejectModel
    {
        public string Reason { get; set; } = string.Empty;
    }
}


--- File: RequestDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\RequestDTO.cs) ---

﻿using AutomationOfPurchases.Shared.DTOs;
using AutomationOfPurchases.Shared.Enums;

public class RequestDTO
{
    public int RequestId { get; set; }
    public string Title { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public DateTime CreationDate { get; set; }
    public RequestStatus Status { get; set; } = RequestStatus.Draft;

    public string? OrderedById { get; set; }
    public string? OrderedByFullName { get; set; }
    public string? OrderedByEmail { get; set; }

    // НОВЕ ПОЛЕ:
    public string? OrderedByDepartmentName { get; set; }

    public bool ApprovedByDepartmentHead { get; set; }
    public bool ApprovedByEconomist { get; set; }

    public bool CanApproveAsEconomist { get; set; }

    public bool ReportDepartmentHead { get; set; }
    public bool ReportRequester { get; set; }
    public bool ReportEconomist { get; set; }

    public List<RequestItemDTO> Items { get; set; } = new();

    // Хто затвердив
    public string? DepartmentHeadApproverId { get; set; }
    public string? DepartmentHeadApproverFullName { get; set; }
    public string? EconomistApproverId { get; set; }
    public string? EconomistApproverFullName { get; set; }

    // Хто відхилив
    public string? RejectedByUserId { get; set; }
    public string? RejectedByUserFullName { get; set; }
    public string? RejectionReason { get; set; }
}


--- File: RequestItemDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\RequestItemDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    /// <summary>
    /// Відповідає оригінальному рядку заявки.
    /// Зберігає інформацію про виконання (Delivered/ToPurchase).
    /// </summary>
    public class RequestItemDTO
    {
        public int RequestItemId { get; set; }

        // Посилання на заявку
        public int RequestId { get; set; }

        // Посилання на Item
        public int ItemId { get; set; }
        public ItemDTO? Item { get; set; }

        // Скільки замовили
        public int Quantity { get; set; }
        // Чи повністю задоволений цей рядок
        public bool Satisfied { get; set; }

        // Хто створив (для прив’язки до автора)
        public string? OrderedById { get; set; }
        public UserDTO? OrderedBy { get; set; }

        // Показує, скільки вже фактично видано зі складу
        public int DeliveredQuantity { get; set; }
        // Показує, скільки відправлено на закупівлю
        public int ToPurchaseQuantity { get; set; }
    }
}


--- File: RequestShortDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\RequestShortDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    public class RequestShortDTO
    {
        public int RequestId { get; set; }
        public string Title { get; set; } = string.Empty;
    }
}


--- File: UserDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\UserDTO.cs) ---

﻿using AutomationOfPurchases.Shared.Enums;

namespace AutomationOfPurchases.Shared.DTOs
{
    public class UserDTO
    {
        public string? UserId { get; set; }
        public string FullName { get; set; } = string.Empty;

        public int? DepartmentId { get; set; }
        public DepartmentDTO? Department { get; set; }

        public string Login { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;

        public UserRole Role { get; set; } = UserRole.None;
    }
}


--- File: WarehouseDTO.cs (Path: .\AutomationOfPurchases.Shared\DTOs\WarehouseDTO.cs) ---

﻿namespace AutomationOfPurchases.Shared.DTOs
{
    // Відповідає згрупованим потребам (GroupBy по ItemId)
    public class GroupedNeedDTO
    {
        public int ItemId { get; set; }
        public string? ItemName { get; set; }
        public string? StorageUnit { get; set; }
        public int TotalQuantity { get; set; }
        public bool IsExpanded { get; set; } = false;

        public List<DepartmentRequestDTO> Requests { get; set; } = new();
        // IsExpanded зазвичай тільки для клієнта (Blazor); 
        // можна зберегти тут, або не передавати на API.
    }

    public class DepartmentRequestDTO
    {
        public int RequestItemId { get; set; }
        public string DepartmentName { get; set; } = string.Empty;
        public string OrderedByFullName { get; set; } = string.Empty;
        public int Quantity { get; set; }

        public string? OrderedById { get; set; }
    }

    public class SatisfyNeedModel
    {
        public int GeneralNeedsItemId { get; set; }

        public int QuantityToSatisfy { get; set; }
        public string WarehouseName { get; set; } = "";

        public bool IsNotAvailable { get; set; } = false;
    }

}


--- File: RequestStatus.cs (Path: .\AutomationOfPurchases.Shared\Enums\RequestStatus.cs) ---

﻿namespace AutomationOfPurchases.Shared.Enums
{
    public enum RequestStatus
    {
        Draft = 0,
        PendingDepartmentHead = 1,
        PendingEconomist = 2,
        Approved = 3,
        Rejected = 4
        // За потреби доповнюйте статуси
    }
}


--- File: UserRole.cs (Path: .\AutomationOfPurchases.Shared\Enums\UserRole.cs) ---

﻿namespace AutomationOfPurchases.Shared.Enums
{
    public enum UserRole
    {
        None = 0,
        DepartmentHead = 1,
        Economist = 2,
        WarehouseWorker = 3,
        // За потреби можна додати інші
    }
}


--- File: AppUser.cs (Path: .\AutomationOfPurchases.Shared\Models\AppUser.cs) ---

﻿using Microsoft.AspNetCore.Identity;

namespace AutomationOfPurchases.Shared.Models
{
    public class AppUser : IdentityUser
    {
        public string FullName { get; set; } = string.Empty;

        public int? DepartmentId { get; set; }
        public virtual Department? Department { get; set; }

        // НОВЕ: Зв’язок із DepartmentEconomist (many-to-many)
        public virtual ICollection<DepartmentEconomist> DepartmentEconomists { get; set; }
            = new List<DepartmentEconomist>();
    }
}


--- File: DeliveryRequest.cs (Path: .\AutomationOfPurchases.Shared\Models\DeliveryRequest.cs) ---

﻿using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutomationOfPurchases.Shared.Models
{
    public class DeliveryRequest
    {
        [Key]
        public int DeliveryRequestId { get; set; }

        // Який Item доставляти
        public int ItemId { get; set; }
        [ForeignKey(nameof(ItemId))]
        public virtual Item? Item { get; set; }

        public int Quantity { get; set; }

        // Хто ініціював доставку
        // Раніше було int OrderedById, тепер string? 
        public string? OrderedById { get; set; }
        [ForeignKey(nameof(OrderedById))]
        public virtual AppUser? OrderedBy { get; set; }

        public string Warehouse { get; set; } = string.Empty;

        // Зв'язок назад до RequestItem (якщо хочемо)
        public int? RequestItemId { get; set; }
        [ForeignKey(nameof(RequestItemId))]
        public virtual RequestItem? RequestItem { get; set; }
    }
}


--- File: Department.cs (Path: .\AutomationOfPurchases.Shared\Models\Department.cs) ---

﻿using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutomationOfPurchases.Shared.Models
{
    public class Department
    {
        [Key]
        public int DepartmentId { get; set; }
        public string DepartmentName { get; set; } = string.Empty;

        public string? HeadOfDepartmentId { get; set; }
        [ForeignKey(nameof(HeadOfDepartmentId))]
        public virtual AppUser? HeadOfDepartment { get; set; }

        public virtual ICollection<AppUser> Economists { get; set; }
            = new List<AppUser>();

        public int FreeCapital { get; set; }

        // НОВЕ: Зв’язок із DepartmentEconomist (many-to-many)
        public virtual ICollection<DepartmentEconomist> DepartmentEconomists { get; set; }
            = new List<DepartmentEconomist>();
    }
}


--- File: DepartmentEconomist.cs (Path: .\AutomationOfPurchases.Shared\Models\DepartmentEconomist.cs) ---

﻿using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutomationOfPurchases.Shared.Models
{
    /// <summary>
    /// Зв’язка “багато-до-багатьох” між відділами та економістами
    /// </summary>
    public class DepartmentEconomist
    {
        // Ключ складається з двох полів (Composite Key): DepartmentId + EconomistId
        public int DepartmentId { get; set; }
        [ForeignKey(nameof(DepartmentId))]
        public virtual Department? Department { get; set; }

        public string EconomistId { get; set; } = string.Empty;
        [ForeignKey(nameof(EconomistId))]
        public virtual AppUser? Economist { get; set; }
    }
}


--- File: GeneralNeedsItem.cs (Path: .\AutomationOfPurchases.Shared\Models\GeneralNeedsItem.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;

public class GeneralNeedsItem
{
    [Key]
    public int GeneralNeedsItemId { get; set; }

    public int GeneralNeedsListId { get; set; }
    [ForeignKey(nameof(GeneralNeedsListId))]
    public virtual GeneralNeedsList? List { get; set; }

    public int ItemId { get; set; }
    public virtual Item? Item { get; set; }

    public int Quantity { get; set; }

    // Для зручності можна зберігати відомості, хто замовляв
    public string? OrderedById { get; set; }
    public virtual AppUser? OrderedBy { get; set; }

    // За бажання - посилання на "оригінальний" RequestItem:
    public int? OriginalRequestItemId { get; set; }
    [ForeignKey(nameof(OriginalRequestItemId))]
    public virtual RequestItem? OriginalRequestItem { get; set; }
}

--- File: GeneralNeedsList.cs (Path: .\AutomationOfPurchases.Shared\Models\GeneralNeedsList.cs) ---

﻿using System.ComponentModel.DataAnnotations;

namespace AutomationOfPurchases.Shared.Models
{
    public class GeneralNeedsList
    {
        [Key]
        public int ListId { get; set; }

        public DateTime CreationDate { get; set; }
        public DateTime? NullificationDate { get; set; }

        // Припустимо, що маємо список RequestItem, який пов'язуємо через проміжну таблицю
        // або ключ із RequestItem. Тут показано підхід "один-до-багатьох" для прикладу:
        public virtual ICollection<GeneralNeedsItem> Items { get; set; }
            = new List<GeneralNeedsItem>();
    }
}


--- File: Item.cs (Path: .\AutomationOfPurchases.Shared\Models\Item.cs) ---

﻿using System.ComponentModel.DataAnnotations;

namespace AutomationOfPurchases.Shared.Models
{
    public class Item
    {
        [Key]
        public int ItemId { get; set; }

        public string ItemName { get; set; } = string.Empty;

        public string StorageUnit { get; set; } = string.Empty;
    }
}


--- File: NetNeedsItem.cs (Path: .\AutomationOfPurchases.Shared\Models\NetNeedsItem.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;

public class NetNeedsItem
{
    [Key]
    public int NetNeedsItemId { get; set; }

    public int NetNeedsListId { get; set; }
    [ForeignKey(nameof(NetNeedsListId))]
    public virtual NetNeedsList? List { get; set; }

    public int ItemId { get; set; }
    public virtual Item? Item { get; set; }

    public int Quantity { get; set; }

    // Хто замовляв
    public string? OrderedById { get; set; }
    public virtual AppUser? OrderedBy { get; set; }

    // Посилання на оригінальний рядок (якщо потрібно)
    public int? OriginalRequestItemId { get; set; }
    [ForeignKey(nameof(OriginalRequestItemId))]
    public virtual RequestItem? OriginalRequestItem { get; set; }
}

--- File: NetNeedsList.cs (Path: .\AutomationOfPurchases.Shared\Models\NetNeedsList.cs) ---

﻿using System.ComponentModel.DataAnnotations;

namespace AutomationOfPurchases.Shared.Models
{
    public class NetNeedsList
    {
        [Key]
        public int ListId { get; set; }

        public DateTime CreationDate { get; set; }
        public DateTime? NullificationDate { get; set; }

        public virtual ICollection<NetNeedsItem> Items { get; set; }
            = new List<NetNeedsItem>();
    }
}


--- File: Notifications.cs (Path: .\AutomationOfPurchases.Shared\Models\Notifications.cs) ---

﻿using System.ComponentModel.DataAnnotations;

namespace AutomationOfPurchases.Shared.Models
{
    public class Notification
    {
        [Key]
        public int NotificationId { get; set; }

        public string RecipientId { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string? Message { get; set; }
        public bool IsRead { get; set; } = false;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public string? LinkUrl { get; set; }

        // ДОДАНЕ ПОЛЕ ДЛЯ КАТЕГОРІЇ / ТИПУ (наприклад "Important", "Rejected", "Approved", ...).
        public string? Category { get; set; }

        public int? RequestId { get; set; }
    }
}


--- File: Request.cs (Path: .\AutomationOfPurchases.Shared\Models\Request.cs) ---

﻿using AutomationOfPurchases.Shared.Models;
using System.ComponentModel.DataAnnotations.Schema;
using System.ComponentModel.DataAnnotations;

namespace AutomationOfPurchases.Shared.Models
{
    public class Request
    {
        [Key]
        public int RequestId { get; set; }

        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime CreationDate { get; set; }

        public string Status { get; set; } = string.Empty;

        // Хто створив заявку
        public string? OrderedById { get; set; }
        [ForeignKey(nameof(OrderedById))]
        public virtual AppUser? OrderedBy { get; set; }

        public bool ApprovedByDepartmentHead { get; set; }
        public bool ApprovedByEconomist { get; set; }

        public bool ReportDepartmentHead { get; set; }
        public bool ReportRequester { get; set; }
        public bool ReportEconomist { get; set; }

        public virtual ICollection<RequestItem> Items { get; set; }
            = new List<RequestItem>();

        // ===================== НОВІ ПОЛЯ для відображення, ким затверджено =====================
        public string? DepartmentHeadApproverId { get; set; }
        [ForeignKey(nameof(DepartmentHeadApproverId))]
        public virtual AppUser? DepartmentHeadApprover { get; set; }

        public string? EconomistApproverId { get; set; }
        [ForeignKey(nameof(EconomistApproverId))]
        public virtual AppUser? EconomistApprover { get; set; }

        // ===================== Для відхилення =====================
        public string? RejectedByUserId { get; set; }
        [ForeignKey(nameof(RejectedByUserId))]
        public virtual AppUser? RejectedByUser { get; set; }

        public string? RejectionReason { get; set; }
    }
}

--- File: RequestItem.cs (Path: .\AutomationOfPurchases.Shared\Models\RequestItem.cs) ---

﻿using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace AutomationOfPurchases.Shared.Models
{
    public class RequestItem
    {
        [Key]
        public int RequestItemId { get; set; }

        public int ItemId { get; set; }
        [ForeignKey(nameof(ItemId))]
        public virtual Item? Item { get; set; }

        public int Quantity { get; set; }
        public bool Satisfied { get; set; }

        public string? OrderedById { get; set; }
        [ForeignKey(nameof(OrderedById))]
        public virtual AppUser? OrderedBy { get; set; }

        public virtual ICollection<DeliveryRequest> DeliveryRequests { get; set; }
            = new List<DeliveryRequest>();

        public int? RequestId { get; set; }
        [ForeignKey(nameof(RequestId))]
        public virtual Request? Request { get; set; }

        public int DeliveredQuantity { get; set; }
        public int ToPurchaseQuantity { get; set; }
    }
}


